{"version":3,"sources":["src/Sprite/SpriteLoader.js"],"names":[],"mappings":"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","file":"src/Sprite/SpriteLoader.js","sourcesContent":["/*\n\n2D Game Sprite Library, Built using JavaScript ES6\nCopyright (C) 2015 qhduan(http://qhduan.com)\n\nThis program is free software: you can redistribute it and/or modify\nit under the terms of the GNU General Public License as published by\nthe Free Software Foundation, either version 3 of the License, or\n(at your option) any later version.\n\nThis program is distributed in the hope that it will be useful,\nbut WITHOUT ANY WARRANTY; without even the implied warranty of\nMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\nGNU General Public License for more details.\n\nYou should have received a copy of the GNU General Public License\nalong with this program.  If not, see <http://www.gnu.org/licenses/>.\n\n*/\n\n/**\n * @fileoverview Sprite.Loader, fetch resource\n * @author mail@qhduan.com (QH Duan)\n */\n\n(function () {\n \"use strict\";\n\n  let internal = Sprite.Namespace();\n\n  /**\n   * Cache all url and element\n   */\n  let Cache = new Map();\n  /**\n   * When some url in Downloading, the url is downloading,\n   * and other thread want it have to wait\n   */\n  let Downloading = new Map();\n\n  function Fetch (url, callback, timeout) {\n\n    let Finish = (obj) => {\n      Cache.set(url, obj);\n      if (callback) {\n        callback(obj);\n      }\n      if (Downloading.has(url)) {\n        let callbacks = Downloading.get(url);\n        for (let callback of callbacks) {\n          if (callback) {\n            callback(obj);\n          }\n        }\n        Downloading.delete(url);\n      }\n    }\n\n    if (Cache.has(url)) {\n      Finish(Cache.get(url));\n      return;\n    }\n\n    if (Downloading.has(url)) {\n      Downloading.get(url).push(callback);\n      return;\n    }\n\n    Downloading.set(url, []);\n\n    let req = new XMLHttpRequest();\n    req.open(\"GET\", url, true);\n    req.timeout = 15000; // 15 seconds\n\n    let type = null;\n    if (url.match(/js$/)) {\n      req.responseType = \"text\";\n      type = \"js\";\n    } else if (url.match(/jpg$|jpeg$|png$|bmp$|gif$/i)) {\n      req.responseType = \"blob\";\n      type = \"image\";\n    } else if (url.match(/wav$|mp3$|ogg$/i)) {\n      req.responseType = \"blob\"\n      type = \"audio\";\n    } else if (url.match(/json$/i)) {\n      // req.responseType = \"text\"\n      req.responseType = \"json\";\n      type = \"json\";\n    } else {\n      console.error(url);\n      throw new Error(\"Sprite.Loader.Fetch got an invalid url\");\n    }\n\n    if (typeof callback != \"function\")\n      callback = function () {};\n\n    req.ontimeout = function () {\n      if (timeout) {\n        console.error(url);\n        throw new Error(\"Sprite.Loader.Fetch timeout twice\");\n      } else {\n        Fetch(url, callback, true);\n      }\n    };\n\n    let done = false;\n    req.onreadystatechange = function () {\n      if (req.readyState == 4 && !done) {\n        done = true;\n        if (req.response) {\n          if (type == \"js\") {\n            let fun = null;\n            try {\n              fun = new Function(req.response);\n            } catch (e) {\n              console.error(req.response, url);\n              throw e;\n            }\n            Finish(fun);\n          } else if (type == \"image\") {\n            let blob = req.response;\n            let image = new Image();\n            image.onload = function () {\n              // window.URL.revokeObjectURL(image.src);\n              image.onload = null;\n              Finish(image);\n            };\n            image.src = window.URL.createObjectURL(blob);\n          } else if (type == \"audio\") {\n            let blob = req.response;\n            let audio = new Audio();\n            audio.oncanplay = function () {\n              // 如果reoke掉audio，那么audio.load()方法则不能用了\n              // window.URL.revokeObjectURL(audio.src);\n              audio.oncanplay = null;\n              Finish(audio);\n            };\n            audio.src = window.URL.createObjectURL(blob);\n          } else if (type == \"json\") {\n            let json = req.response;\n            if (!json) {\n              console.error(url);\n              throw new Error(\"Sprite.Loader invalid json\");\n            }\n            Finish(json);\n          }\n        } else {\n          console.error(req.response, req.readyState, req.status, req.statusText);\n          throw new Error(\"Sprite.Loader.Fetch Error\");\n        }\n      }\n    };\n    req.send();\n  }\n\n  /**\n   * Class for fetch resources\n   * @class\n   */\n  Sprite.assign(\"Loader\", class SpriteLoader extends Sprite.Event {\n\n    /**\n     * Create a Sprite.Loader object\n     * @static\n     */\n    static create () {\n      return new Sprite.Loader();\n    }\n\n    /**\n     * Construct Sprite.Laoder\n     * @constructor\n     */\n    constructor () {\n      super();\n      let privates = internal(this);\n\n      privates.list = [];\n      privates.progress = 0;\n    }\n\n    /**\n     * @return {number} Return current download progress\n     */\n    get progress () {\n      let privates = internal(this);\n      return privates.progress;\n    }\n\n    set progress (value) {\n      throw new Error(\"Sprite.Loader.progress readonly\");\n    }\n\n    /**\n     * Add one or more urls\n     * eg. add(\"a.txt\") add(\"a.txt\", \"b.txt\") add([\"a.txt\", \"b.txt\"], \"c.txt\")\n     * @param {Object} urls, one or more urls.\n     */\n    add (urls) {\n      let privates = internal(this);\n      let args = Array.prototype.slice.call(arguments);\n\n      for (let element of args) {\n        if (element instanceof Array) {\n          privates.list = privates.list.concat(element);\n        } else if (typeof element == \"string\" && element.length > 0) {\n          privates.list.push(element);\n        } else {\n          console.error(element, args, this);\n          throw new Error(\"Sprite.Loader.add invalid argument\");\n        }\n      }\n      return this;\n    }\n\n    /**\n     * Begin to download\n     */\n    start () {\n      let privates = internal(this);\n      let done = 0;\n      let ret = [];\n      ret.length = privates.list.length;\n\n      let Done = () => {\n        done++;\n\n        privates.progress = done / ret.length;\n        this.emit(\"progress\");\n\n        if (done >= ret.length) {\n          this.emit(\"complete\", true, ret);\n        }\n      }\n\n      privates.list.forEach((element, index) => {\n        Fetch(element, (result) => {\n          ret[index] = result;\n          Done();\n        });\n      });\n      return this;\n    }\n\n  });\n\n\n})();\n"]}