{"version":3,"sources":["src/Game/GameArchive.js"],"names":[],"mappings":"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","file":"src/Game/GameArchive.js","sourcesContent":["/*\n\nA-RPG Game, Built using JavaScript ES6\nCopyright (C) 2015 qhduan(http://qhduan.com)\n\nThis program is free software: you can redistribute it and/or modify\nit under the terms of the GNU General Public License as published by\nthe Free Software Foundation, either version 3 of the License, or\n(at your option) any later version.\n\nThis program is distributed in the hope that it will be useful,\nbut WITHOUT ANY WARRANTY; without even the implied warranty of\nMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\nGNU General Public License for more details.\n\nYou should have received a copy of the GNU General Public License\nalong with this program.  If not, see <http://www.gnu.org/licenses/>.\n\n*/\n\n(function () {\n  Game.archive = {};\n\n  Game.archive.remove = function (id) {\n    if (window.localStorage.getItem(id)) {\n      window.localStorage.removeItem(id);\n    }\n  };\n\n  // 返回所有存档，Object格式\n  Game.archive.list = function () {\n    var keys = [];\n    for (var key in window.localStorage) {\n      if (key.match(/^SAVE_(\\d+)$/)) {\n        keys.push(parseInt(key.match(/^SAVE_(\\d+)$/)[1]));\n      }\n    }\n    keys.sort();\n    keys.reverse();\n    return keys;\n  };\n\n  // 返回最新存档，Object格式\n  Game.archive.last = function () {\n    var list = Game.archive.list();\n    if (list.length > 0) {\n      var last = list[0];\n      return JSON.parse(window.localStorage.getItem(`SAVE_${last}`));\n    } else {\n      throw new Error(\"Game.archive.last Error\");\n    }\n  };\n\n  Game.archive.clear = function () {\n    for (var key in window.localStorage) {\n      if (key.match(/^SAVE_(\\d+)$/)) {\n        window.localStorage.removeItem(key);\n      }\n    }\n  };\n\n  Game.archive.save = function (data) {\n    var now = new Date();\n    var id = now.getTime();\n\n    data.id = id;\n    data.name = data.hero.name;\n    data.date = now.toLocaleString();\n\n    window.localStorage.setItem(`SAVE_${id}`, JSON.stringify(data));\n  };\n\n  Game.archive.get = function (id) {\n    if (id && window.localStorage.getItem(id)) {\n      return JSON.parse(window.localStorage.getItem(id));\n    }\n    return null;\n  };\n\n  Game.archive.load = function (id) {\n    var data = Game.archive.get(id);\n    if (!data) {\n      data = Game.archive.last();\n    }\n\n    if (data) {\n      var heroData = data.hero;\n\n      Game.drawHero(heroData.custom, function (heroImage) {\n        heroData.image = heroImage;\n        Game.hero = new Game.Actor(heroData);\n\n        function FindHint () {\n\n          if (Game.area && Game.area.map && Game.hero) {\n\n          }\n\n          var heroPosition = Game.area.map.tile(Game.hero.x, Game.hero.y);\n          var heroDirection = Game.hero.sprite.currentAnimation.match(/up|left|down|right/)[0];\n          var heroFace = Sprite.copy(heroPosition);\n\n          switch (heroDirection) {\n            case \"up\":\n              heroFace.y -= 1;\n              break;\n            case \"down\":\n              heroFace.y += 1;\n              break;\n            case \"left\":\n              heroFace.x -= 1;\n              break;\n            case \"right\":\n              heroFace.x += 1;\n              break;\n          }\n\n          var hint = null;\n\n          function FindUnderHero (element) {\n            if (hint != null || element == Game.hero) {\n              return;\n            }\n            var t = Game.area.map.tile(element.x, element.y);\n            if (t.x == heroPosition.x && t.y == heroPosition.y) {\n              hint = element;\n            }\n          }\n\n          function FindFaceHero (element) {\n            if (hint != null || element == Game.hero) {\n              return;\n            }\n            var t = Game.area.map.tile(element.x, element.y);\n            if (t.x == heroFace.x && t.y == heroFace.y) {\n              hint = element;\n            }\n          }\n\n          // 找最近可“事件”人物 Game.area.actors\n          Sprite.each(Game.area.actors, FindUnderHero);\n          // 找最近尸体 Game.area.actors\n          Sprite.each(Game.area.bags, FindUnderHero);\n          // 最近的门\n          Game.area.doors.forEach(FindUnderHero);\n          // 最近的箱子\n          Game.area.chests.forEach(FindUnderHero);\n          // 最近的提示物（例如牌子）\n          Game.area.hints.forEach(FindUnderHero);\n\n\n          // 找最近可“事件”人物 Game.area.actors\n          Sprite.each(Game.area.actors, FindFaceHero);\n          // 找最近尸体 Game.area.actors\n          Sprite.each(Game.area.bags, FindFaceHero);\n          // 最近的门\n          Game.area.doors.forEach(FindFaceHero);\n          // 最近的箱子\n          Game.area.chests.forEach(FindFaceHero);\n          // 最近的提示物（例如牌子）\n          Game.area.hints.forEach(FindFaceHero);\n\n\n          if (Game.hintObject && Game.hintObject != hint) {\n            Game.hintObject = null;\n            Game.windows.interface.use.style.visibility = \"hidden\";\n          }\n\n          if (hint != null) {\n            Game.hintObject = hint;\n            Game.windows.interface.use.style.visibility = \"visible\";\n            if (hint.type == \"door\") {\n              Game.popup(hint, hint.description, 0, -30);\n            }\n          }\n\n        }\n\n        var skip = 0;\n        Sprite.Ticker.on(\"tick\", function () {\n          if (Game.area && Game.area.actors && Game.area.bags) {\n            skip++;\n            if (skip % 5 == 0)\n              FindHint();\n          }\n        });\n\n        //FindHint();\n        Game.hero.on(\"complete\", function () {\n          Game.loadArea(heroData.area, function (area) {\n            Game.area = area;\n            area.map.draw(Game.layers.mapLayer);\n\n            if (!Game.hero.data.x && !Game.hero.data.x) {\n              if (area.map.data.entry.x && area.map.data.entry.y) {\n                Game.hero.data.x = area.map.data.entry.x;\n                Game.hero.data.y = area.map.data.entry.y;\n              } else {\n                throw new Error(\"Invalid Hero Position\");\n              }\n            }\n\n            area.actors[\"hero\"] = Game.hero;\n            Game.hero.draw(Game.layers.actorLayer);\n            Game.hero.focus();\n            Game.windows.main.hide();\n            Game.windows.interface.show();\n          });\n        });\n\n      });\n\n    } else {\n      console.error(\"id:\", id);\n      throw \"Invalid id, Game.archive.load\";\n    }\n      //return archive[id];\n\n  };\n})();\n"]}