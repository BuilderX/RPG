{"version":3,"sources":["src/Game/GameArchive.js"],"names":[],"mappings":"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","file":"src/Game/GameArchive.js","sourcesContent":["/*\n\nA-RPG Game, Built using JavaScript ES6\nCopyright (C) 2015 qhduan(http://qhduan.com)\n\nThis program is free software: you can redistribute it and/or modify\nit under the terms of the GNU General Public License as published by\nthe Free Software Foundation, either version 3 of the License, or\n(at your option) any later version.\n\nThis program is distributed in the hope that it will be useful,\nbut WITHOUT ANY WARRANTY; without even the implied warranty of\nMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\nGNU General Public License for more details.\n\nYou should have received a copy of the GNU General Public License\nalong with this program.  If not, see <http://www.gnu.org/licenses/>.\n\n*/\n\n(function () {\n  \"use strict\";\n\n  Game.Archive = class GameArchive {\n\n    static remove (id) {\n      if (window.localStorage.getItem(id)) {\n        window.localStorage.removeItem(id);\n      }\n    }\n\n    // 返回所有存档，Object格式\n    static list () {\n      let keys = [];\n      for (let key in window.localStorage) {\n        if (key.match(/^SAVE_(\\d+)$/)) {\n          keys.push(parseInt(key.match(/^SAVE_(\\d+)$/)[1]));\n        }\n      }\n      keys.sort();\n      keys.reverse();\n      return keys;\n    }\n\n    // 返回最新存档，Object格式\n    static last () {\n      let list = Game.Archive.list();\n      if (list.length > 0) {\n        let last = list[0];\n        return JSON.parse(window.localStorage.getItem(`SAVE_${last}`));\n      } else {\n        return null;\n      }\n    }\n\n    static clear () {\n      for (let key in window.localStorage) {\n        if (key.match(/^SAVE_(\\d+)$/)) {\n          window.localStorage.removeItem(key);\n        }\n      }\n    }\n\n    static save (data) {\n      let now = new Date();\n      let id = now.getTime();\n\n      data.id = id;\n      data.name = data.hero.name;\n      data.date = now.toLocaleString();\n\n      window.localStorage.setItem(`SAVE_${id}`, JSON.stringify(data));\n    }\n\n    static get (id) {\n      if (id && window.localStorage.getItem(id)) {\n        return JSON.parse(window.localStorage.getItem(id));\n      }\n      return null;\n    }\n\n    static load (id) {\n      let data = Game.Archive.get(id);\n      if (!data) {\n        data = Game.Archive.last();\n      }\n\n      if (data) {\n\n        Game.windows.loading.begin();\n\n        let heroData = data.hero;\n\n\n        console.time(\"hero\");\n\n        Game.drawHero(heroData.custom, function (heroImage) {\n          heroData.image = heroImage;\n          Game.hero = new Game.Actor(heroData);\n\n          Game.hero.on(\"complete\", function () {\n\n            console.timeEnd(\"hero\");\n            console.time(\"area\");\n\n            Game.loadArea(heroData.area, function (area) {\n\n              console.timeEnd(\"area\");\n              console.time(\"other1\");\n\n              Game.area = area;\n              area.map.draw(Game.layers.mapLayer);\n\n              console.timeEnd(\"other1\");\n              console.time(\"other1.5\");\n\n              if (!Number.isInteger(Game.hero.data.x) || !Number.isInteger(Game.hero.data.y)) {\n                if (\n                  area.map.data.entry &&\n                  Number.isInteger(area.map.data.entry.x) &&\n                  Number.isInteger(area.map.data.entry.y)\n                ) {\n                  Game.hero.data.x = area.map.data.entry.x;\n                  Game.hero.data.y = area.map.data.entry.y;\n                } else {\n                  console.error(Game.hero.data.x, Game.hero.data.y, area.map.data.entry, Game.hero, area.map.data);\n                  throw new Error(\"Invalid hero position\");\n                }\n              }\n\n              area.actors.add(Game.hero);\n\n              console.timeEnd(\"other1.5\");\n              console.time(\"other2\");\n              Game.hero.draw(Game.layers.actorLayer);\n              Game.hero.focus();\n              console.timeEnd(\"other2\");\n              console.time(\"other3\");\n              Game.windows.main.hide();\n              Game.windows.interface.show();\n              console.timeEnd(\"other3\");\n              console.time(\"other4\");\n              Game.AI.attach(Game.hero);\n              Game.start();\n              console.timeEnd(\"other4\");\n\n              Game.windows.loading.end();\n            });\n          });\n\n        });\n\n      } else {\n        console.error(\"id:\", id);\n        throw \"Invalid id, Game.Archive.load\";\n      }\n    }\n\n  };\n\n})();\n"]}