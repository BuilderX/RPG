{"version":3,"sources":["src/Game/GameSkill.js"],"names":[],"mappings":"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","file":"src/Game/GameSkill.js","sourcesContent":["/*\n\nA-RPG Game, Built using JavaScript ES6\nCopyright (C) 2015 qhduan(http://qhduan.com)\n\nThis program is free software: you can redistribute it and/or modify\nit under the terms of the GNU General Public License as published by\nthe Free Software Foundation, either version 3 of the License, or\n(at your option) any later version.\n\nThis program is distributed in the hope that it will be useful,\nbut WITHOUT ANY WARRANTY; without even the implied warranty of\nMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\nGNU General Public License for more details.\n\nYou should have received a copy of the GNU General Public License\nalong with this program.  If not, see <http://www.gnu.org/licenses/>.\n\n*/\n\n(function () {\n  \"use strict\";\n\n  Game.Skill = class GameSkill extends Sprite.Event {\n    static load (id, callback) {\n      var skillLoader = new Sprite.Loader();\n      skillLoader.add(`/skill/${id}.json`);\n      skillLoader.start();\n      skillLoader.on(\"complete\", (event) => {\n        var skillData = event.data[0];\n        var skillObj = new Game.Skill(skillData);\n        Game.skills[id] = skillObj;\n        skillObj.on(\"complete\", () => {\n          if (typeof callback == \"function\") {\n            callback();\n          }\n        });\n      });\n    }\n\n    constructor (skillData) {\n      super ();\n\n      this.data = skillData;\n      this.id = this.data.id;\n\n      var loader = new Sprite.Loader();\n      loader.add(`/skill/${this.data.image}`);\n      loader.add(`/skill/${this.data.icon}`);\n      loader.add(`/skill/${this.data.sound}`);\n      loader.start();\n      loader.on(\"complete\", (event) => {\n        var image = event.data[0];\n        this.icon = event.data[1];\n        this.sound = event.data[2];\n\n        var sheet = new Sprite.Sheet({\n          images: [image],\n          width: this.data.tilewidth,\n          height: this.data.tileheight,\n          animations: this.data.animations\n        });\n\n        sheet.centerX = Math.floor(this.data.tilewidth / 2);\n        sheet.centerY = Math.floor(this.data.tileheight / 2);\n\n        this.sprite = sheet;\n\n        // 发送完成事件，第二个参数代表一次性事件\n        this.emit(\"complete\", true);\n      });\n    }\n\n    get power () {\n      if (typeof this.data.power == \"number\") {\n        return this.data.power;\n      } else if (typeof this.data.power == \"string\") {\n        var m = this.data.power.match(/(\\d+)d(\\d+)/);\n        var times = parseInt(m[1]);\n        var dice = parseInt(m[2]);\n        var sum = 0;\n        for (let i = 0; i < times; i++) {\n          sum += Sprite.rand(0, dice);\n        }\n        return sum;\n      } else {\n        console.error(this, this.data, this.data.power);\n        throw new Error(\"Game.Skill.power invalid power\");\n      }\n    }\n\n    set power (value) {\n      throw new Error(\"Game.Skill.power readonly\");\n    }\n\n    get type () {\n      return this.data.type;\n    }\n\n    set type (value) {\n      throw new Error(\"Game.Skill.type readonly\");\n    }\n\n    fire (actor, animation, callback) {\n\n      if (this.sound) {\n        this.sound.load();\n        this.sound.play();\n      }\n\n      var sprite = this.sprite.clone();\n\n      // 矫正武器效果位置\n      //sprite.x = parseInt(actor.sprite.x - parseInt(this.data.tilewidth / 2));\n      //sprite.y = parseInt(actor.sprite.y - parseInt(this.data.tileheight / 2));\n      sprite.x = actor.x;\n      sprite.y = actor.y;\n\n      if (this.data.animations[animation].x) {\n        sprite.x += this.data.animations[animation].x;\n      }\n\n      if (this.data.animations[animation].y) {\n        sprite.y += this.data.animations[animation].y;\n      }\n\n      // 被命中的actor列表\n      var hitted= {};\n      var CheckHit = () => {\n\n        // 碰撞检测\n        if (actor.data.type == \"hero\") {\n          for (var key in Game.area.actors) {\n            if (Game.area.actors[key].id == actor.id) continue;\n            if (Game.area.actors[key].data.type != \"monster\") continue;\n            var c = Game.skillCollision(sprite, Game.area.actors[key].sprite);\n            if (c) {\n              hitted[key] = true;\n            }\n          }\n        } else {\n          var c = Game.skillCollision(sprite, Game.hero.sprite);\n          if (c) {\n            hitted[\"hero\"] = true;\n          }\n        }\n      };\n\n      // 如果是远距离攻击（this.data.distance > 0），那么distance是它已经走过的举例\n      var distance = 0;\n\n      var listener = Sprite.Ticker.on(\"tick\", () => {\n\n        distance += this.data.flyspeed;\n\n        switch (animation) {\n          case \"attackdown\":\n            sprite.y += distance;\n            break;\n          case \"attackleft\":\n            sprite.x -= distance;\n            break;\n          case \"attackright\":\n            sprite.x += distance;\n            break;\n          case \"attackup\":\n            sprite.y -= distance;\n            break;\n        }\n\n        CheckHit();\n\n        // 如果击中了一个敌人（单体伤害）\n        if (Object.keys(hitted).length > 0) {\n          Finish();\n        }\n\n        // 如果是远程攻击，并且攻击距离已经到了\n        if (this.data.distance > 0 && distance >= this.data.distance) {\n          Finish();\n        }\n\n        // 如果是近战攻击（this.data.distance <= 0），而且动画已经停止\n        if (this.data.distance <= 0 && sprite.paused) {\n          Finish();\n        }\n\n      });\n\n      // 攻击结束时运行Stop函数\n      var Finish = () => {\n        Sprite.Ticker.off(\"tick\", listener);\n\n        if (Object.keys(hitted).length > 0 && this.data.animations[\"hitted\"]) {\n          var a = Object.keys(hitted)[0];\n          a = Game.area.actors[a];\n          sprite.x = a.sprite.x;\n          sprite.y = a.sprite.y;\n          sprite.play(\"hitted\");\n          if (sprite.paused == true) {\n            Game.layers.skillLayer.removeChild(sprite);\n          } else {\n            sprite.on(\"animationend\", function () {\n              Game.layers.skillLayer.removeChild(sprite);\n            });\n          }\n        } else {\n          // 如果动画已经播完，则停止\n          if (sprite.paused == true) {\n            Game.layers.skillLayer.removeChild(sprite);\n          } else {\n            sprite.on(\"animationend\", function () {\n              Game.layers.skillLayer.removeChild(sprite);\n            });\n          }\n        }\n\n        if (callback) callback(Object.keys(hitted));\n      }\n\n      Game.layers.skillLayer.appendChild(sprite);\n      sprite.play(animation);\n\n      if ( this.data.animations[animation].actor\n        && actor.data.animations[this.data.animations[animation].actor] ) {\n        actor.play(this.data.animations[animation].actor, 3);\n      } else {\n        var direction = this.data.animations[animation].actor.match(/left|right|up|down/);\n        if (direction) {\n          direction = direction[0];\n          actor.play(\"face\" + direction, 0);\n          actor.play(\"attack\" + direction, 3);\n        }\n      }\n    }\n\n  };\n\n})();\n"]}