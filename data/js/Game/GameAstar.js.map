{"version":3,"sources":["src/Game/GameAstar.js"],"names":[],"mappings":"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","file":"src/Game/GameAstar.js","sourcesContent":["/*\n\nA-RPG Game, Built using JavaScript ES6\nCopyright (C) 2015 qhduan(http://qhduan.com)\n\nThis program is free software: you can redistribute it and/or modify\nit under the terms of the GNU General Public License as published by\nthe Free Software Foundation, either version 3 of the License, or\n(at your option) any later version.\n\nThis program is distributed in the hope that it will be useful,\nbut WITHOUT ANY WARRANTY; without even the implied warranty of\nMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\nGNU General Public License for more details.\n\nYou should have received a copy of the GNU General Public License\nalong with this program.  If not, see <http://www.gnu.org/licenses/>.\n\n*/\n\n(function () {\n  \"use strict\";\n\n  /*\n  let pathCallback = {};\n\n  let worker = new Worker(\"js/Game/GameWorkerAstar.js\");\n\n  let lastMap = null;\n\n  worker.onmessage = function (event) {\n    let data = event.data;\n    let id = data.id;\n    if (pathCallback[id]) {\n      pathCallback[id](data.path);\n      delete pathCallback[id];\n    }\n  }\n  */\n\n  /**\n   * 自动寻路算法\n   */\n  Game.assign(\"Astar\", class GameAstar {\n    /**\n     * @param {function} collisionFunction 测试是否阻挡\n     * @param {number} width 地图宽度\n     * @param {number} height 地图高度\n     * @param {Object} start 起始位置 eg. {x: 0, y: 0}\n     * @param {Object} end\n     */\n\n     /*\n     static getPathAsync (start, end, callback) {\n       let id = Math.random().toString().substr(2);\n       let blocked = {};\n       for (let actor of Game.area.actors) {\n         if (actor != this) {\n           blocked[actor.x*10000+actor.y] = true;\n         }\n       }\n\n       let blockedMap = null;\n       if (lastMap != Game.area.map.blockedMap) {\n         blockedMap = Game.area.map.blockedMap;\n         lastMap = blockedMap;\n       }\n\n       pathCallback[id] = callback;\n       worker.postMessage({\n         id: id,\n         blockedMap: blockedMap,\n         blocked: blocked,\n         width: Game.area.map.col,\n         height: Game.area.map.row,\n         start: start,\n         end: end\n       });\n     }\n     */\n\n     static getPath (start, end, callback) {\n\n       console.time(\"t\");\n\n       let blocked = {};\n       for (let actor of Game.area.actors) {\n         if (actor != this) {\n           blocked[actor.x*10000+actor.y] = true;\n         }\n       }\n\n       let result = path(function (x, y) {\n         if (Game.area.map.blockedMap[x*10000+y]) {\n           // 有阻挡，返回true\n           return true;\n         }\n         if (blocked[x*10000+y]) {\n           return true;\n         }\n         return false;\n       }, Game.area.map.col, Game.area.map.row, start, end);\n\n       console.timeEnd(\"t\");\n\n       callback(result);\n     }\n\n\n  });\n\n\n  function path (collisionFunction, width, height, start, end) {\n    // 用一个点结构的x和y值返回一个字符串的key\n    // 例如{x: 9, y: 8}返回\"9-8\"\n    let tag = function (point) {\n      //return point.x.toString() + \"-\" + point.y.toString();\n      return point.x * 10000 + point.y;\n    };\n    // 计算点结构a和b之间的曼哈顿距离，即不带斜走的直线距离\n    let manhattan = function (a, b) {\n      return Math.abs(a.x - b.x) + Math.abs(a.y - b.y);\n    };\n    // 粗略验证一个点是否可用，是否超出边界，地图上是否是墙\n    let valid = function (x, y) {\n      if (collisionFunction(x, y))\n        return false;\n      return true;\n    };\n    // 通过坐标x，y，当前最好的节点best和一个附加值（直线10，斜线14），返回一个新节点\n    let make = function (x, y, best, addition, direction) {\n      let t = {\n        x: x,\n        y: y,\n        g: best.g + addition\n      };\n      t.key = tag(t);\n      t.h = manhattan(t, end);\n      t.f = t.g + t.h;\n      t.front = best.front.slice();\n      t.front.push(best.key);\n      return t;\n    };\n\n    // 开启列表和关闭列表\n    let open = {};\n    let close = {};\n\n    //构建起始节点\n    open[tag(start)] = {\n      x: start.x,\n      y: start.y,\n      key: tag(start),\n      f: 0,\n      g: 0,\n      h: manhattan(start, end),\n      front: []\n    };\n\n    while (Object.keys(open).length) {\n      // 找到F值最小的节点\n      let best = null;\n      for (let key in open) {\n        if (best == null || open[key].f < best.f) {\n          best = open[key];\n        }\n      }\n      // 从开启列表中删除，加入关闭列表\n      delete open[best.key];\n      close[best.key] = best;\n\n      // 如果这个最好的节点就是结尾节点，则返回\n      if (best.x == end.x && best.y == end.y) {\n        best.front.push(tag(end));\n        let result = [];\n        for (let i = 0, len = best.front.length; i < len; i++) {\n          result.push({\n            x: Math.floor(best.front[i]/10000),\n            y: Math.floor(best.front[i]%10000)\n          });\n          /*\n          let m = best.front[i].match(/(\\d+)-(\\d+)/);\n          if (m) {\n            result.push({\n              x: parseInt(m[1]),\n              y: parseInt(m[2])\n            });\n          }\n          */\n        }\n        return result;\n      }\n\n      // 记录上下左右，和四个斜方向的可能值\n      let possible = [];\n\n      if (valid(best.x, best.y - 1)) { // 验证up\n        possible.push(make(best.x, best.y - 1, best, 10));\n      }\n      if (valid(best.x, best.y + 1)) { // 验证down\n        possible.push(make(best.x, best.y + 1, best, 10));\n      }\n      if (valid(best.x - 1, best.y)) { // 验证left\n        possible.push(make(best.x - 1, best.y, best, 10));\n      }\n      if (valid(best.x + 1, best.y)) { // 验证right\n        possible.push(make(best.x + 1, best.y, best, 10));\n      }\n\n      // 去除已经在开启列表和关闭列表中的\n      possible.forEach(function (element) {\n        let t = tag(element);\n        if (open[t]) return;\n        if (close[t]) return;\n        open[t] = element;\n      });\n\n    } // while\n\n    return null;\n  }\n\n\n})();\n"]}