/*

A-RPG Game, Built using JavaScript ES6
Copyright (C) 2015 qhduan(http://qhduan.com)

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.

*/

"use strict";

(function () {
  "use strict";

  function boxCollide(spriteA, spriteB, rectA, rectB) {
    var A = {
      x: spriteA.x - rectA.centerX,
      y: spriteA.y - rectA.centerY,
      w: rectA.width,
      h: rectA.height,
      sx: rectA.x,
      sy: rectA.y,
      sw: rectA.width,
      sh: rectA.height,
      image: rectA.image
    };

    var B = {
      x: spriteB.x - rectB.centerX,
      y: spriteB.y - rectB.centerY,
      w: rectB.width,
      h: rectB.height,
      sx: rectB.x,
      sy: rectB.y,
      sw: rectB.width,
      sh: rectB.height,
      image: rectB.image
    };

    var bigX = Math.max(A.x + A.w, B.x + B.w);
    var smallX = Math.min(A.x, B.x);
    var bigY = Math.max(A.y + A.h, B.y + B.h);
    var smallY = Math.min(A.y, B.y);

    var width = bigX - smallX;
    var height = bigY - smallY;

    if (width < A.w + B.w && height < A.h + B.h) {
      return {
        A: A,
        B: B
      };
    }
    return false;
  }

  var collideCavansCache = new Map();

  function pixelCollide(A, B) {
    // 对图像进行某种意义上的移动，例如把上面的图的A和B都平移到左上角，也就是AA的左上角变为0,0坐标

    var now = new Date().getTime();

    // WWWHHH
    var key = A.w * 1000 + A.h;
    var canvas = undefined;
    var context = undefined;
    if (collideCavansCache.has(key)) {
      canvas = collideCavansCache.get(key).canvas;
      context = collideCavansCache.get(key).context;
    } else {
      canvas = document.createElement("canvas");
      canvas.width = A.w;
      canvas.height = A.h;
      context = canvas.getContext("2d");
      collideCavansCache.set(key, {
        canvas: canvas,
        context: context
      });
    }
    context.clearRect(0, 0, canvas.width, canvas.height);

    // draw spriteA
    context.globalCompositeOperation = "source-over";
    context.drawImage(A.image, A.sx, A.sy, A.sw, A.sh, 0, 0, A.w, A.h);

    // draw spriteB
    // 在source-in模式下，图像如果相交则显示，不相交则透明，所以判断如果有非透明就是相交
    context.globalCompositeOperation = "source-in";
    context.drawImage(B.image, B.sx, B.sy, B.sw, B.sh, B.x - A.x, B.y - A.y, B.w, B.h);

    var pixel = context.getImageData(0, 0, A.w, A.h).data;

    var collision = false;

    for (var i = 3, len = pixel.length; i < len; i += 3) {
      if (pixel[i] != 0) {
        collision = true;
      }
    }

    return collision;
  }

  // 角色碰撞检测，先简单的矩形检测，如有碰撞可能则进行像素级检测
  Game.assign("actorCollision", function (actorSprite, blockSprite) {
    // 角色只检测frame 0，因为角色老变动，避免卡住，只检测第一个frame
    var actorRect = actorSprite.getFrame(0);
    // 阻挡的块则检测当前frame
    var blockRect = blockSprite.getFrame();
    var data = boxCollide(actorSprite, blockSprite, actorRect, blockRect);
    if (data) {
      // 计算一个delta，即只碰撞角色的下半部分
      // deltaY偏移0.85，大概意思是只检测角色最下方15%的地方
      var deltaY = Math.floor(actorRect.height * 0.85);
      data.A.y += deltaY;
      data.A.sy += deltaY;
      data.A.h -= deltaY;
      data.A.sh -= deltaY;

      return pixelCollide(data.A, data.B);
    }
    return false;
  });

  // 技能碰撞检测
  Game.assign("skillCollision", function (skillSprite, actorSprite) {
    var skillRect = skillSprite.getFrame();
    var actorRect = actorSprite.getFrame();

    var data = boxCollide(skillSprite, actorSprite, skillRect, actorRect);
    if (data) {
      // 和角色碰撞检测对比，技能碰撞检测无delta
      return pixelCollide(data.A, data.B);
    }
    return false;
  });
})();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9HYW1lL0dhbWVDb2xsaXNpb24uanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQW9CQSxDQUFDLFlBQVk7QUFDWCxjQUFZLENBQUM7O0FBRWIsV0FBUyxVQUFVLENBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFO0FBQ25ELFFBQUksQ0FBQyxHQUFHO0FBQ04sT0FBQyxFQUFFLE9BQU8sQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFDLE9BQU87QUFDNUIsT0FBQyxFQUFFLE9BQU8sQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFDLE9BQU87QUFDNUIsT0FBQyxFQUFFLEtBQUssQ0FBQyxLQUFLO0FBQ2QsT0FBQyxFQUFFLEtBQUssQ0FBQyxNQUFNO0FBQ2YsUUFBRSxFQUFFLEtBQUssQ0FBQyxDQUFDO0FBQ1gsUUFBRSxFQUFFLEtBQUssQ0FBQyxDQUFDO0FBQ1gsUUFBRSxFQUFFLEtBQUssQ0FBQyxLQUFLO0FBQ2YsUUFBRSxFQUFFLEtBQUssQ0FBQyxNQUFNO0FBQ2hCLFdBQUssRUFBRSxLQUFLLENBQUMsS0FBSztLQUNuQixDQUFDOztBQUVGLFFBQUksQ0FBQyxHQUFHO0FBQ04sT0FBQyxFQUFFLE9BQU8sQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFDLE9BQU87QUFDNUIsT0FBQyxFQUFFLE9BQU8sQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFDLE9BQU87QUFDNUIsT0FBQyxFQUFFLEtBQUssQ0FBQyxLQUFLO0FBQ2QsT0FBQyxFQUFFLEtBQUssQ0FBQyxNQUFNO0FBQ2YsUUFBRSxFQUFFLEtBQUssQ0FBQyxDQUFDO0FBQ1gsUUFBRSxFQUFFLEtBQUssQ0FBQyxDQUFDO0FBQ1gsUUFBRSxFQUFFLEtBQUssQ0FBQyxLQUFLO0FBQ2YsUUFBRSxFQUFFLEtBQUssQ0FBQyxNQUFNO0FBQ2hCLFdBQUssRUFBRSxLQUFLLENBQUMsS0FBSztLQUNuQixDQUFDOztBQUVGLFFBQUks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SSxFQUFFOzs7QUFHUixVQUFJLE1BQU0sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLENBQUM7QUFDakQsVUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksTUFBTSxDQUFDO0FBQ25CLFVBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxJQUFJLE1BQU0sQ0FBQztBQUNwQixVQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxNQUFNLENBQUM7QUFDbkIsVUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLElBQUksTUFBTSxDQUFDOztBQUVwQixhQUFPLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztLQUNyQztBQUNELFdBQU8sS0FBSyxDQUFDO0dBQ2QsQ0FBQyxDQUFDOzs7QUFHSCxNQUFJLENBQUMsTUFBTSxDQUFDLGdCQUFnQixFQUFFLFVBQVUsV0FBVyxFQUFFLFdBQVcsRUFBRTtBQUNoRSxRQUFJLFNBQVMsR0FBRyxXQUFXLENBQUMsUUFBUSxFQUFFLENBQUM7QUFDdkMsUUFBSSxTQUFTLEdBQUcsV0FBVyxDQUFDLFFBQVEsRUFBRSxDQUFDOztBQUV2QyxRQUFJLElBQUksR0FBRyxVQUFVLENBQUMsV0FBVyxFQUFFLFdBQVcsRUFBRSxTQUFTLEVBQUUsU0FBUyxDQUFDLENBQUM7QUFDdEUsUUFBSSxJQUFJLEVBQUU7O0FBRVIsYUFBTyxZQUFZLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7S0FDckM7QUFDRCxXQUFPLEtBQUssQ0FBQztHQUNkLENBQUMsQ0FBQztDQUVKLENBQUEsRUFBRyxDQUFDIiwiZmlsZSI6IkdhbWVDb2xsaXNpb24uanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuXG5BLVJQRyBHYW1lLCBCdWlsdCB1c2luZyBKYXZhU2NyaXB0IEVTNlxuQ29weXJpZ2h0IChDKSAyMDE1IHFoZHVhbihodHRwOi8vcWhkdWFuLmNvbSlcblxuVGhpcyBwcm9ncmFtIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnlcbml0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5XG50aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uLCBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvclxuKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi5cblxuVGhpcyBwcm9ncmFtIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsXG5idXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZlxuTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiAgU2VlIHRoZVxuR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy5cblxuWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2VcbmFsb25nIHdpdGggdGhpcyBwcm9ncmFtLiAgSWYgbm90LCBzZWUgPGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LlxuXG4qL1xuXG4oZnVuY3Rpb24gKCkge1xuICBcInVzZSBzdHJpY3RcIjtcblxuICBmdW5jdGlvbiBib3hDb2xsaWRlIChzcHJpdGVBLCBzcHJpdGVCLCByZWN0QSwgcmVjdEIpIHtcbiAgICBsZXQgQSA9IHtcbiAgICAgIHg6IHNwcml0ZUEueCAtIHJlY3RBLmNlbnRlclgsXG4gICAgICB5OiBzcHJpdGVBLnkgLSByZWN0QS5jZW50ZXJZLFxuICAgICAgdzogcmVjdEEud2lkdGgsXG4gICAgICBoOiByZWN0QS5oZWlnaHQsXG4gICAgICBzeDogcmVjdEEueCxcbiAgICAgIHN5OiByZWN0QS55LFxuICAgICAgc3c6IHJlY3RBLndpZHRoLFxuICAgICAgc2g6IHJlY3RBLmhlaWdodCxcbiAgICAgIGltYWdlOiByZWN0QS5pbWFnZVxuICAgIH07XG5cbiAgICBsZXQgQiA9IHtcbiAgICAgIHg6IHNwcml0ZUIueCAtIHJlY3RCLmNlbnRlclgsXG4gICAgICB5OiBzcHJpdGVCLnkgLSByZWN0Qi5jZW50ZXJZLFxuICAgICAgdzogcmVjdEIud2lkdGgsXG4gICAgICBoOiByZWN0Qi5oZWlnaHQsXG4gICAgICBzeDogcmVjdEIueCxcbiAgICAgIHN5OiByZWN0Qi55LFxuICAgICAgc3c6IHJlY3RCLndpZHRoLFxuICAgICAgc2g6IHJlY3RCLmhlaWdodCxcbiAgICAgIGltYWdlOiByZWN0Qi5pbWFnZVxuICAgIH07XG5cbiAgICBsZXQgYmlnWCA9IE1hdGgubWF4KEEueCArIEEudywgQi54ICsgQi53KTtcbiAgICBsZXQgc21hbGxYID0gTWF0aC5taW4oQS54LCBCLngpO1xuICAgIGxldCBiaWdZID0gTWF0aC5tYXgoQS55ICsgQS5oLCBCLnkgKyBCLmgpO1xuICAgIGxldCBzbWFsbFkgPSBNYXRoLm1pbihBLnksIEIueSk7XG5cbiAgICBsZXQgd2lkdGggPSBiaWdYIC0gc21hbGxYO1xuICAgIGxldCBoZWlnaHQgPSBiaWdZIC0gc21hbGxZO1xuXG4gICAgaWYgKHdpZHRoIDwgKEEudyArIEIudykgJiYgaGVpZ2h0IDwgKEEuaCArIEIuaCkpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIEE6IEEsXG4gICAgICAgIEI6IEJcbiAgICAgIH07XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIGxldCBjb2xsaWRlQ2F2YW5zQ2FjaGUgPSBuZXcgTWFwKCk7XG5cbiAgZnVuY3Rpb24gcGl4ZWxDb2xsaWRlIChBLCBCKSB7XG4gICAgLy8g5a+55Zu+5YOP6L+b6KGM5p+Q56eN5oSP5LmJ5LiK55qE56e75Yqo77yM5L6L5aaC5oqK5LiK6Z2i55qE5Zu+55qEQeWSjELpg73lubPnp7vliLDlt6bkuIrop5LvvIzkuZ/lsLHmmK9BQeeahOW3puS4iuinkuWPmOS4ujAsMOWdkOagh1xuXG4gICAgbGV0IG5vdyA9IChuZXcgRGF0ZSgpLmdldFRpbWUoKSk7XG5cbiAgICAvLyBXV1dISEhcbiAgICBsZXQga2V5ID0gQS53ICogMTAwMCArIEEuaDtcbiAgICBsZXQgY2FudmFzO1xuICAgIGxldCBjb250ZXh0O1xuICAgIGlmIChjb2xsaWRlQ2F2YW5zQ2FjaGUuaGFzKGtleSkpIHtcbiAgICAgIGNhbnZhcyA9IGNvbGxpZGVDYXZhbnNDYWNoZS5nZXQoa2V5KS5jYW52YXM7XG4gICAgICBjb250ZXh0ID0gY29sbGlkZUNhdmFuc0NhY2hlLmdldChrZXkpLmNvbnRleHQ7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJjYW52YXNcIik7XG4gICAgICBjYW52YXMud2lkdGggPSBBLnc7XG4gICAgICBjYW52YXMuaGVpZ2h0ID0gQS5oO1xuICAgICAgY29udGV4dCA9IGNhbnZhcy5nZXRDb250ZXh0KFwiMmRcIik7XG4gICAgICBjb2xsaWRlQ2F2YW5zQ2FjaGUuc2V0KGtleSwge1xuICAgICAgICBjYW52YXM6IGNhbnZhcyxcbiAgICAgICAgY29udGV4dDogY29udGV4dFxuICAgICAgfSk7XG4gICAgfVxuICAgIGNvbnRleHQuY2xlYXJSZWN0KDAsIDAsIGNhbnZhcy53aWR0aCwgY2FudmFzLmhlaWdodCk7XG5cbiAgICAvLyBkcmF3IHNwcml0ZUFcbiAgICBjb250ZXh0Lmdsb2JhbENvbXBvc2l0ZU9wZXJhdGlvbj1cInNvdXJjZS1vdmVyXCJcbiAgICBjb250ZXh0LmRyYXdJbWFnZShBLmltYWdlLFxuICAgICAgQS5zeCwgQS5zeSwgQS5zdywgQS5zaCxcbiAgICAgIDAsIDAsIEEudywgQS5oKTtcblxuICAgIC8vIGRyYXcgc3ByaXRlQlxuICAgIC8vIOWcqHNvdXJjZS1pbuaooeW8j+S4i++8jOWbvuWDj+WmguaenOebuOS6pOWImeaYvuekuu+8jOS4jeebuOS6pOWImemAj+aYju+8jOaJgOS7peWIpOaWreWmguaenOaciemdnumAj+aYjuWwseaYr+ebuOS6pFxuICAgIGNvbnRleHQuZ2xvYmFsQ29tcG9zaXRlT3BlcmF0aW9uPVwic291cmNlLWluXCJcbiAgICBjb250ZXh0LmRyYXdJbWFnZShCLmltYWdlLFxuICAgICAgQi5zeCwgQi5zeSwgQi5zdywgQi5zaCxcbiAgICAgIEIueCAtIEEueCwgQi55IC0gQS55LCBCLncsIEIuaCk7XG5cbiAgICBsZXQgcGl4ZWwgPSBjb250ZXh0LmdldEltYWdlRGF0YSgwLCAwLCBBLncsIEEuaCkuZGF0YTtcblxuICAgIGxldCBjb2xsaXNpb24gPSBmYWxzZTtcblxuICAgIGZvciAobGV0IGkgPSAzLCBsZW4gPSBwaXhlbC5sZW5ndGg7IGkgPCBsZW47IGkgKz0gMykge1xuICAgICAgaWYgKHBpeGVsW2ldICE9IDApIHtcbiAgICAgICAgY29sbGlzaW9uID0gdHJ1ZTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gY29sbGlzaW9uO1xuICB9XG5cbiAgLy8g6KeS6Imy56Kw5pKe5qOA5rWL77yM5YWI566A5Y2V55qE55+p5b2i5qOA5rWL77yM5aaC5pyJ56Kw5pKe5Y+v6IO95YiZ6L+b6KGM5YOP57Sg57qn5qOA5rWLXG4gIEdhbWUuYXNzaWduKFwiYWN0b3JDb2xsaXNpb25cIiwgZnVuY3Rpb24gKGFjdG9yU3ByaXRlLCBibG9ja1Nwcml0ZSkge1xuICAgIC8vIOinkuiJsuWPquajgOa1i2ZyYW1lIDDvvIzlm6DkuLrop5LoibLogIHlj5jliqjvvIzpgb/lhY3ljaHkvY/vvIzlj6rmo4DmtYvnrKzkuIDkuKpmcmFtZVxuICAgIGxldCBhY3RvclJlY3QgPSBhY3RvclNwcml0ZS5nZXRGcmFtZSgwKTtcbiAgICAvLyDpmLvmjKHnmoTlnZfliJnmo4DmtYvlvZPliY1mcmFtZVxuICAgIGxldCBibG9ja1JlY3QgPSBibG9ja1Nwcml0ZS5nZXRGcmFtZSgpO1xuICAgIGxldCBkYXRhID0gYm94Q29sbGlkZShhY3RvclNwcml0ZSwgYmxvY2tTcHJpdGUsIGFjdG9yUmVjdCwgYmxvY2tSZWN0KTtcbiAgICBpZiAoZGF0YSkge1xuICAgICAgLy8g6K6h566X5LiA5LiqZGVsdGHvvIzljbPlj6rnorDmkp7op5LoibLnmoTkuIvljYrpg6jliIZcbiAgICAgIC8vIGRlbHRhWeWBj+enuzAuODXvvIzlpKfmpoLmhI/mgJ3mmK/lj6rmo4DmtYvop5LoibLmnIDkuIvmlrkxNSXnmoTlnLDmlrlcbiAgICAgIGxldCBkZWx0YVkgPSBNYXRoLmZsb29yKGFjdG9yUmVjdC5oZWlnaHQgKiAwLjg1KTtcbiAgICAgIGRhdGEuQS55ICs9IGRlbHRhWTtcbiAgICAgIGRhdGEuQS5zeSArPSBkZWx0YVk7XG4gICAgICBkYXRhLkEuaCAtPSBkZWx0YVk7XG4gICAgICBkYXRhLkEuc2ggLT0gZGVsdGFZO1xuXG4gICAgICByZXR1cm4gcGl4ZWxDb2xsaWRlKGRhdGEuQSwgZGF0YS5CKTtcbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9KTtcblxuICAvLyDmioDog73norDmkp7mo4DmtYtcbiAgR2FtZS5hc3NpZ24oXCJza2lsbENvbGxpc2lvblwiLCBmdW5jdGlvbiAoc2tpbGxTcHJpdGUsIGFjdG9yU3ByaXRlKSB7XG4gICAgbGV0IHNraWxsUmVjdCA9IHNraWxsU3ByaXRlLmdldEZyYW1lKCk7XG4gICAgbGV0IGFjdG9yUmVjdCA9IGFjdG9yU3ByaXRlLmdldEZyYW1lKCk7XG5cbiAgICBsZXQgZGF0YSA9IGJveENvbGxpZGUoc2tpbGxTcHJpdGUsIGFjdG9yU3ByaXRlLCBza2lsbFJlY3QsIGFjdG9yUmVjdCk7XG4gICAgaWYgKGRhdGEpIHtcbiAgICAgIC8vIOWSjOinkuiJsueisOaSnuajgOa1i+WvueavlO+8jOaKgOiDveeisOaSnuajgOa1i+aXoGRlbHRhXG4gICAgICByZXR1cm4gcGl4ZWxDb2xsaWRlKGRhdGEuQSwgZGF0YS5CKTtcbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9KTtcblxufSkoKTtcbiJdfQ==
