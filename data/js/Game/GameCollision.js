"use strict";

/*

A-RPG Game, Built using JavaScript ES6
Copyright (C) 2015 qhduan(http://qhduan.com)

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.

*/

(function () {
  "use strict";

  function boxCollide(spriteA, spriteB, rectA, rectB) {
    var A = {
      x: spriteA.x - rectA.centerX,
      y: spriteA.y - rectA.centerY,
      w: rectA.width,
      h: rectA.height,
      sx: rectA.x,
      sy: rectA.y,
      sw: rectA.width,
      sh: rectA.height,
      image: rectA.image
    };

    var B = {
      x: spriteB.x - rectB.centerX,
      y: spriteB.y - rectB.centerY,
      w: rectB.width,
      h: rectB.height,
      sx: rectB.x,
      sy: rectB.y,
      sw: rectB.width,
      sh: rectB.height,
      image: rectB.image
    };

    var bigX = Math.max(A.x + A.w, B.x + B.w);
    var smallX = Math.min(A.x, B.x);
    var bigY = Math.max(A.y + A.h, B.y + B.h);
    var smallY = Math.min(A.y, B.y);

    var width = bigX - smallX;
    var height = bigY - smallY;

    if (width < A.w + B.w && height < A.h + B.h) {
      return {
        A: A,
        B: B
      };
    }
    return false;
  }

  var collideCavansCache = new Map();

  function pixelCollide(A, B) {
    // 对图像进行某种意义上的移动，例如把上面的图的A和B都平移到左上角，也就是AA的左上角变为0,0坐标

    var now = new Date().getTime();

    // WWWHHH
    var key = A.w * 1000 + A.h;
    var canvas = undefined;
    var context = undefined;
    if (collideCavansCache.has(key)) {
      canvas = collideCavansCache.get(key).canvas;
      context = collideCavansCache.get(key).context;
    } else {
      canvas = document.createElement("canvas");
      canvas.width = A.w;
      canvas.height = A.h;
      context = canvas.getContext("2d");
      collideCavansCache.set(key, {
        canvas: canvas,
        context: context
      });
    }
    context.clearRect(0, 0, canvas.width, canvas.height);

    // draw spriteA
    context.globalCompositeOperation = "source-over";
    context.drawImage(A.image, A.sx, A.sy, A.sw, A.sh, 0, 0, A.w, A.h);

    // draw spriteB
    // 在source-in模式下，图像如果相交则显示，不相交则透明，所以判断如果有非透明就是相交
    context.globalCompositeOperation = "source-in";
    context.drawImage(B.image, B.sx, B.sy, B.sw, B.sh, B.x - A.x, B.y - A.y, B.w, B.h);

    var pixel = context.getImageData(0, 0, A.w, A.h).data;

    var collision = false;

    for (var i = 3, len = pixel.length; i < len; i += 3) {
      if (pixel[i] != 0) {
        collision = true;
      }
    }

    return collision;
  }

  // 角色碰撞检测，先简单的矩形检测，如有碰撞可能则进行像素级检测
  Game.assign("actorCollision", function (actorSprite, blockSprite) {
    // 角色只检测frame 0，因为角色老变动，避免卡住，只检测第一个frame
    var actorRect = actorSprite.getFrame(0);
    // 阻挡的块则检测当前frame
    var blockRect = blockSprite.getFrame();
    var data = boxCollide(actorSprite, blockSprite, actorRect, blockRect);
    if (data) {
      // 计算一个delta，即只碰撞角色的下半部分
      // deltaY偏移0.85，大概意思是只检测角色最下方15%的地方
      var deltaY = Math.floor(actorRect.height * 0.85);
      data.A.y += deltaY;
      data.A.sy += deltaY;
      data.A.h -= deltaY;
      data.A.sh -= deltaY;

      return pixelCollide(data.A, data.B);
    }
    return false;
  });

  // 技能碰撞检测
  Game.assign("skillCollision", function (skillSprite, actorSprite) {
    var skillRect = skillSprite.getFrame();
    var actorRect = actorSprite.getFrame();

    var data = boxCollide(skillSprite, actorSprite, skillRect, actorRect);
    if (data) {
      // 和角色碰撞检测对比，技能碰撞检测无delta
      return pixelCollide(data.A, data.B);
    }
    return false;
  });
})();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9HYW1lL0dhbWVDb2xsaXNpb24uanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQW9CQSxDQUFDLFlBQVk7QUFDWCxjQUFZLENBQUM7O0FBRWIsV0FBUyxVQUFVLENBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFO0FBQ25ELFFBQUksQ0FBQyxHQUFHO0FBQ04sT0FBQyxFQUFFLE9BQU8sQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFDLE9BQU87QUFDNUIsT0FBQyxFQUFFLE9BQU8sQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFDLE9BQU87QUFDNUIsT0FBQyxFQUFFLEtBQUssQ0FBQyxLQUFLO0FBQ2QsT0FBQyxFQUFFLEtBQUssQ0FBQyxNQUFNO0FBQ2YsUUFBRSxFQUFFLEtBQUssQ0FBQyxDQUFDO0FBQ1gsUUFBRSxFQUFFLEtBQUssQ0FBQyxDQUFDO0FBQ1gsUUFBRSxFQUFFLEtBQUssQ0FBQyxLQUFLO0FBQ2YsUUFBRSxFQUFFLEtBQUssQ0FBQyxNQUFNO0FBQ2hCLFdBQUssRUFBRSxLQUFLLENBQUMsS0FBSztLQUNuQixDQUFDOztBQUVGLFFBQUksQ0FBQyxHQUFHO0FBQ04sT0FBQyxFQUFFLE9BQU8sQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFDLE9BQU87QUFDNUIsT0FBQyxFQUFFLE9BQU8sQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFDLE9BQU87QUFDNUIsT0FBQyxFQUFFLEtBQUssQ0FBQyxLQUFLO0FBQ2QsT0FBQyxFQUFFLEtBQUssQ0FBQyxNQUFNO0FBQ2YsUUFBRSxFQUFFLEtBQUssQ0FBQyxDQUFDO0FBQ1gsUUFBRSxFQUFFLEtBQUssQ0FBQyxDQUFDO0FBQ1gsUUFBRSxFQUFFLEtBQUssQ0FBQyxLQUFLO0FBQ2YsUUFBRSxFQUFFLEtBQUssQ0FBQyxNQUFNO0FBQ2hCLFdBQUssRUFBRSxLQUFLLENBQUMsS0FBSztLQUNuQixDQUFDOztBQUVGLFFBQUks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SSxJQUFJLEVBQUU7OztBQUdSLFVBQUksTUFBTSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsQ0FBQztBQUNqRCxVQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxNQUFNLENBQUM7QUFDbkIsVUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLElBQUksTUFBTSxDQUFDO0FBQ3BCLFVBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLE1BQU0sQ0FBQztBQUNuQixVQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsSUFBSSxNQUFNLENBQUM7O0FBRXBCLGFBQU8sWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0tBQ3JDO0FBQ0QsV0FBTyxLQUFLLENBQUM7R0FDZCxDQUFDOzs7QUFBQyxBQUdILE1BQUksQ0FBQyxNQUFNLENBQUMsZ0JBQWdCLEVBQUUsVUFBVSxXQUFXLEVBQUUsV0FBVyxFQUFFO0FBQ2hFLFFBQUksU0FBUyxHQUFHLFdBQVcsQ0FBQyxRQUFRLEVBQUUsQ0FBQztBQUN2QyxRQUFJLFNBQVMsR0FBRyxXQUFXLENBQUMsUUFBUSxFQUFFLENBQUM7O0FBRXZDLFFBQUksSUFBSSxHQUFHLFVBQVUsQ0FBQyxXQUFXLEVBQUUsV0FBVyxFQUFFLFNBQVMsRUFBRSxTQUFTLENBQUMsQ0FBQztBQUN0RSxRQUFJLElBQUksRUFBRTs7QUFFUixhQUFPLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztLQUNyQztBQUNELFdBQU8sS0FBSyxDQUFDO0dBQ2QsQ0FBQyxDQUFDO0NBRUosQ0FBQSxFQUFHLENBQUMiLCJmaWxlIjoiR2FtZUNvbGxpc2lvbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG5cbkEtUlBHIEdhbWUsIEJ1aWx0IHVzaW5nIEphdmFTY3JpcHQgRVM2XG5Db3B5cmlnaHQgKEMpIDIwMTUgcWhkdWFuKGh0dHA6Ly9xaGR1YW4uY29tKVxuXG5UaGlzIHByb2dyYW0gaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeVxuaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnlcbnRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb24sIGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsIG9yXG4oYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLlxuXG5UaGlzIHByb2dyYW0gaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCxcbmJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mXG5NRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlXG5HTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLlxuXG5Zb3Ugc2hvdWxkIGhhdmUgcmVjZWl2ZWQgYSBjb3B5IG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZVxuYWxvbmcgd2l0aCB0aGlzIHByb2dyYW0uICBJZiBub3QsIHNlZSA8aHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLz4uXG5cbiovXG5cbihmdW5jdGlvbiAoKSB7XG4gIFwidXNlIHN0cmljdFwiO1xuXG4gIGZ1bmN0aW9uIGJveENvbGxpZGUgKHNwcml0ZUEsIHNwcml0ZUIsIHJlY3RBLCByZWN0Qikge1xuICAgIGxldCBBID0ge1xuICAgICAgeDogc3ByaXRlQS54IC0gcmVjdEEuY2VudGVyWCxcbiAgICAgIHk6IHNwcml0ZUEueSAtIHJlY3RBLmNlbnRlclksXG4gICAgICB3OiByZWN0QS53aWR0aCxcbiAgICAgIGg6IHJlY3RBLmhlaWdodCxcbiAgICAgIHN4OiByZWN0QS54LFxuICAgICAgc3k6IHJlY3RBLnksXG4gICAgICBzdzogcmVjdEEud2lkdGgsXG4gICAgICBzaDogcmVjdEEuaGVpZ2h0LFxuICAgICAgaW1hZ2U6IHJlY3RBLmltYWdlXG4gICAgfTtcblxuICAgIGxldCBCID0ge1xuICAgICAgeDogc3ByaXRlQi54IC0gcmVjdEIuY2VudGVyWCxcbiAgICAgIHk6IHNwcml0ZUIueSAtIHJlY3RCLmNlbnRlclksXG4gICAgICB3OiByZWN0Qi53aWR0aCxcbiAgICAgIGg6IHJlY3RCLmhlaWdodCxcbiAgICAgIHN4OiByZWN0Qi54LFxuICAgICAgc3k6IHJlY3RCLnksXG4gICAgICBzdzogcmVjdEIud2lkdGgsXG4gICAgICBzaDogcmVjdEIuaGVpZ2h0LFxuICAgICAgaW1hZ2U6IHJlY3RCLmltYWdlXG4gICAgfTtcblxuICAgIGxldCBiaWdYID0gTWF0aC5tYXgoQS54ICsgQS53LCBCLnggKyBCLncpO1xuICAgIGxldCBzbWFsbFggPSBNYXRoLm1pbihBLngsIEIueCk7XG4gICAgbGV0IGJpZ1kgPSBNYXRoLm1heChBLnkgKyBBLmgsIEIueSArIEIuaCk7XG4gICAgbGV0IHNtYWxsWSA9IE1hdGgubWluKEEueSwgQi55KTtcblxuICAgIGxldCB3aWR0aCA9IGJpZ1ggLSBzbWFsbFg7XG4gICAgbGV0IGhlaWdodCA9IGJpZ1kgLSBzbWFsbFk7XG5cbiAgICBpZiAod2lkdGggPCAoQS53ICsgQi53KSAmJiBoZWlnaHQgPCAoQS5oICsgQi5oKSkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgQTogQSxcbiAgICAgICAgQjogQlxuICAgICAgfTtcbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgbGV0IGNvbGxpZGVDYXZhbnNDYWNoZSA9IG5ldyBNYXAoKTtcblxuICBmdW5jdGlvbiBwaXhlbENvbGxpZGUgKEEsIEIpIHtcbiAgICAvLyDlr7nlm77lg4/ov5vooYzmn5Dnp43mhI/kuYnkuIrnmoTnp7vliqjvvIzkvovlpoLmiorkuIrpnaLnmoTlm77nmoRB5ZKMQumDveW5s+enu+WIsOW3puS4iuinku+8jOS5n+WwseaYr0FB55qE5bem5LiK6KeS5Y+Y5Li6MCww5Z2Q5qCHXG5cbiAgICBsZXQgbm93ID0gKG5ldyBEYXRlKCkuZ2V0VGltZSgpKTtcblxuICAgIC8vIFdXV0hISFxuICAgIGxldCBrZXkgPSBBLncgKiAxMDAwICsgQS5oO1xuICAgIGxldCBjYW52YXM7XG4gICAgbGV0IGNvbnRleHQ7XG4gICAgaWYgKGNvbGxpZGVDYXZhbnNDYWNoZS5oYXMoa2V5KSkge1xuICAgICAgY2FudmFzID0gY29sbGlkZUNhdmFuc0NhY2hlLmdldChrZXkpLmNhbnZhcztcbiAgICAgIGNvbnRleHQgPSBjb2xsaWRlQ2F2YW5zQ2FjaGUuZ2V0KGtleSkuY29udGV4dDtcbiAgICB9IGVsc2Uge1xuICAgICAgY2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImNhbnZhc1wiKTtcbiAgICAgIGNhbnZhcy53aWR0aCA9IEEudztcbiAgICAgIGNhbnZhcy5oZWlnaHQgPSBBLmg7XG4gICAgICBjb250ZXh0ID0gY2FudmFzLmdldENvbnRleHQoXCIyZFwiKTtcbiAgICAgIGNvbGxpZGVDYXZhbnNDYWNoZS5zZXQoa2V5LCB7XG4gICAgICAgIGNhbnZhczogY2FudmFzLFxuICAgICAgICBjb250ZXh0OiBjb250ZXh0XG4gICAgICB9KTtcbiAgICB9XG4gICAgY29udGV4dC5jbGVhclJlY3QoMCwgMCwgY2FudmFzLndpZHRoLCBjYW52YXMuaGVpZ2h0KTtcblxuICAgIC8vIGRyYXcgc3ByaXRlQVxuICAgIGNvbnRleHQuZ2xvYmFsQ29tcG9zaXRlT3BlcmF0aW9uPVwic291cmNlLW92ZXJcIlxuICAgIGNvbnRleHQuZHJhd0ltYWdlKEEuaW1hZ2UsXG4gICAgICBBLnN4LCBBLnN5LCBBLnN3LCBBLnNoLFxuICAgICAgMCwgMCwgQS53LCBBLmgpO1xuXG4gICAgLy8gZHJhdyBzcHJpdGVCXG4gICAgLy8g5Zyoc291cmNlLWlu5qih5byP5LiL77yM5Zu+5YOP5aaC5p6c55u45Lqk5YiZ5pi+56S677yM5LiN55u45Lqk5YiZ6YCP5piO77yM5omA5Lul5Yik5pat5aaC5p6c5pyJ6Z2e6YCP5piO5bCx5piv55u45LqkXG4gICAgY29udGV4dC5nbG9iYWxDb21wb3NpdGVPcGVyYXRpb249XCJzb3VyY2UtaW5cIlxuICAgIGNvbnRleHQuZHJhd0ltYWdlKEIuaW1hZ2UsXG4gICAgICBCLnN4LCBCLnN5LCBCLnN3LCBCLnNoLFxuICAgICAgQi54IC0gQS54LCBCLnkgLSBBLnksIEIudywgQi5oKTtcblxuICAgIGxldCBwaXhlbCA9IGNvbnRleHQuZ2V0SW1hZ2VEYXRhKDAsIDAsIEEudywgQS5oKS5kYXRhO1xuXG4gICAgbGV0IGNvbGxpc2lvbiA9IGZhbHNlO1xuXG4gICAgZm9yIChsZXQgaSA9IDMsIGxlbiA9IHBpeGVsLmxlbmd0aDsgaSA8IGxlbjsgaSArPSAzKSB7XG4gICAgICBpZiAocGl4ZWxbaV0gIT0gMCkge1xuICAgICAgICBjb2xsaXNpb24gPSB0cnVlO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBjb2xsaXNpb247XG4gIH1cblxuICAvLyDop5LoibLnorDmkp7mo4DmtYvvvIzlhYjnroDljZXnmoTnn6nlvaLmo4DmtYvvvIzlpoLmnInnorDmkp7lj6/og73liJnov5vooYzlg4/ntKDnuqfmo4DmtYtcbiAgR2FtZS5hc3NpZ24oXCJhY3RvckNvbGxpc2lvblwiLCBmdW5jdGlvbiAoYWN0b3JTcHJpdGUsIGJsb2NrU3ByaXRlKSB7XG4gICAgLy8g6KeS6Imy5Y+q5qOA5rWLZnJhbWUgMO+8jOWboOS4uuinkuiJsuiAgeWPmOWKqO+8jOmBv+WFjeWNoeS9j++8jOWPquajgOa1i+esrOS4gOS4qmZyYW1lXG4gICAgbGV0IGFjdG9yUmVjdCA9IGFjdG9yU3ByaXRlLmdldEZyYW1lKDApO1xuICAgIC8vIOmYu+aMoeeahOWdl+WImeajgOa1i+W9k+WJjWZyYW1lXG4gICAgbGV0IGJsb2NrUmVjdCA9IGJsb2NrU3ByaXRlLmdldEZyYW1lKCk7XG4gICAgbGV0IGRhdGEgPSBib3hDb2xsaWRlKGFjdG9yU3ByaXRlLCBibG9ja1Nwcml0ZSwgYWN0b3JSZWN0LCBibG9ja1JlY3QpO1xuICAgIGlmIChkYXRhKSB7XG4gICAgICAvLyDorqHnrpfkuIDkuKpkZWx0Ye+8jOWNs+WPqueisOaSnuinkuiJsueahOS4i+WNiumDqOWIhlxuICAgICAgLy8gZGVsdGFZ5YGP56e7MC44Ne+8jOWkp+amguaEj+aAneaYr+WPquajgOa1i+inkuiJsuacgOS4i+aWuTE1JeeahOWcsOaWuVxuICAgICAgbGV0IGRlbHRhWSA9IE1hdGguZmxvb3IoYWN0b3JSZWN0LmhlaWdodCAqIDAuODUpO1xuICAgICAgZGF0YS5BLnkgKz0gZGVsdGFZO1xuICAgICAgZGF0YS5BLnN5ICs9IGRlbHRhWTtcbiAgICAgIGRhdGEuQS5oIC09IGRlbHRhWTtcbiAgICAgIGRhdGEuQS5zaCAtPSBkZWx0YVk7XG5cbiAgICAgIHJldHVybiBwaXhlbENvbGxpZGUoZGF0YS5BLCBkYXRhLkIpO1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH0pO1xuXG4gIC8vIOaKgOiDveeisOaSnuajgOa1i1xuICBHYW1lLmFzc2lnbihcInNraWxsQ29sbGlzaW9uXCIsIGZ1bmN0aW9uIChza2lsbFNwcml0ZSwgYWN0b3JTcHJpdGUpIHtcbiAgICBsZXQgc2tpbGxSZWN0ID0gc2tpbGxTcHJpdGUuZ2V0RnJhbWUoKTtcbiAgICBsZXQgYWN0b3JSZWN0ID0gYWN0b3JTcHJpdGUuZ2V0RnJhbWUoKTtcblxuICAgIGxldCBkYXRhID0gYm94Q29sbGlkZShza2lsbFNwcml0ZSwgYWN0b3JTcHJpdGUsIHNraWxsUmVjdCwgYWN0b3JSZWN0KTtcbiAgICBpZiAoZGF0YSkge1xuICAgICAgLy8g5ZKM6KeS6Imy56Kw5pKe5qOA5rWL5a+55q+U77yM5oqA6IO956Kw5pKe5qOA5rWL5pegZGVsdGFcbiAgICAgIHJldHVybiBwaXhlbENvbGxpZGUoZGF0YS5BLCBkYXRhLkIpO1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH0pO1xuXG59KSgpO1xuIl19
