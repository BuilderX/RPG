"use strict";

/*

A-RPG Game, Built using JavaScript ES6
Copyright (C) 2015 qhduan(http://qhduan.com)

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.

*/

(function () {
  "use strict";

  var win = Game.windows.sell = Game.Window.create("sellWindow");

  win.html = "\n  <div class=\"window-box\">\n    <div id=\"sellWindowItemBar\">\n\n      <button id=\"sellWindowClose\" class=\"brownButton\">关闭</button>\n      <button id=\"sellWindowBuy\" class=\"brownButton\">买入</button>\n\n      <button id=\"sellWindowAll\" class=\"brownButton\">全部</button>\n      <button id=\"sellWindowWeapon\" class=\"brownButton\">武器</button>\n      <button id=\"sellWindowArmor\" class=\"brownButton\">护甲</button>\n      <button id=\"sellWindowPotion\" class=\"brownButton\">药水</button>\n      <button id=\"sellWindowMaterial\" class=\"brownButton\">材料</button>\n      <button id=\"sellWindowBook\" class=\"brownButton\">书籍</button>\n      <button id=\"sellWindowMisc\" class=\"brownButton\">其他</button>\n    </div>\n\n    <span id=\"sellWindowGold\"></span>\n\n    <div style=\"overflow: auto; height: 300px;\">\n      <table border=\"0\">\n        <thead>\n          <tr>\n            <td style=\"width: 40px;\"></td>\n            <td style=\"width: 120px;\"></td>\n            <td style=\"width: 30px;\"></td>\n            <td style=\"width: 30px;\"></td>\n            <td></td>\n            <td style=\"width: 60px;\"></td>\n          </tr>\n        </thead>\n        <tbody id=\"sellWindowTable\"></tbody>\n      </table>\n    </div>\n  </div>\n  ";

  win.css = "\n\n    #sellWindowTable tr:nth-child(odd) {\n      background-color: rgba(192, 192, 192, 0.6);\n    }\n\n    #sellWindowItemBar > button {\n      width: 60px;\n      height: 40px;\n      font-size: 16px;\n      margin-left: 5px;\n      margin-right: 5px;\n      margin-top: 0px;\n      margin-bottom: 5px;\n    }\n\n    #sellWindowClose {\n      float: right;\n    }\n\n    #sellWindowStatus {\n      float: right;\n    }\n\n    .sellWindow table {\n      width: 100%;\n    }\n\n    .sellWindow table button {\n      width: 60px;\n      height: 40px;\n      font-size: 16px;\n    }\n\n    #sellWindowGold {\n      position: absolute;\n      right: 100px;\n      bottom: 30px;\n      font-size: 20px;\n      color: black;\n    }\n  ";

  var sellWindowClose = win.querySelector("button#sellWindowClose");
  var sellWindowBuy = win.querySelector("button#sellWindowBuy");

  var sellWindowAll = win.querySelector("button#sellWindowAll");
  var sellWindowWeapon = win.querySelector("button#sellWindowWeapon");
  var sellWindowArmor = win.querySelector("button#sellWindowArmor");
  var sellWindowPotion = win.querySelector("button#sellWindowPotion");
  var sellWindowMaterial = win.querySelector("button#sellWindowMaterial");
  var sellWindowBook = win.querySelector("button#sellWindowBook");
  var sellWindowMisc = win.querySelector("button#sellWindowMisc");

  var sellWindowGold = win.querySelector("span#sellWindowGold");
  var sellWindowTable = win.querySelector("#sellWindowTable");

  var lastItems = null;
  var lastFilter = null;
  var lastSelect = -1;

  sellWindowClose.addEventListener("click", function () {
    win.hide();
  });

  sellWindowBuy.addEventListener("click", function () {
    win.hide();
    Game.windows.buy.open(lastItems);
  });

  win.whenUp(["tab"], function () {
    setTimeout(function () {
      win.hide();
      Game.windows.buy.open(lastItems);
    }, 20);
  });

  sellWindowAll.addEventListener("click", function (event) {
    win.open(lastItems, null);
  });

  sellWindowWeapon.addEventListener("click", function (event) {
    win.open(lastItems, "sword|spear|bow");
  });

  sellWindowArmor.addEventListener("click", function (event) {
    win.open(lastItems, "head|body|feet");
  });

  sellWindowPotion.addEventListener("click", function (event) {
    win.open(lastItems, "potion");
  });

  sellWindowMaterial.addEventListener("click", function (event) {
    win.open(lastItems, "material");
  });

  sellWindowBook.addEventListener("click", function (event) {
    win.open(lastItems, "book|scroll|letter");
  });

  sellWindowMisc.addEventListener("click", function (event) {
    win.open(lastItems, "misc");
  });

  win.assign("open", function (items, filter, select) {

    if (typeof select == "undefined") {
      select = -1;
    }

    lastItems = items;
    lastFilter = filter;
    lastSelect = select;

    sellWindowGold.textContent = Game.hero.data.gold + "G";

    var defaultColor = "white";
    var activeColor = "yellow";

    sellWindowAll.style.color = defaultColor;
    sellWindowWeapon.style.color = defaultColor;
    sellWindowArmor.style.color = defaultColor;
    sellWindowPotion.style.color = defaultColor;
    sellWindowMaterial.style.color = defaultColor;
    sellWindowBook.style.color = defaultColor;
    sellWindowMisc.style.color = defaultColor;

    if (filter == null) {
      sellWindowAll.style.color = activeColor;
    } else if (filter.match(/sword/)) {
      sellWindowWeapon.style.color = activeColor;
    } else if (filter.match(/head/)) {
      sellWindowArmor.style.color = activeColor;
    } else if (filter.match(/potion/)) {
      sellWindowPotion.style.color = activeColor;
    } else if (filter.match(/material/)) {
      sellWindowMaterial.style.color = activeColor;
    } else if (filter.match(/book/)) {
      sellWindowBook.style.color = activeColor;
    } else if (filter.match(/misc/)) {
      sellWindowMisc.style.color = activeColor;
    }

    var index = 0;
    var table = "";
    Sprite.each(Game.hero.data.items, function (itemCount, itemId) {
      var item = Game.items[itemId];

      if (filter && filter.indexOf(item.data.type) == -1) return;

      var line = "";

      if (select == index) {
        line += "<tr style=\"background-color: green;\">\n";
      } else {
        line += "<tr>\n";
      }

      if (item.icon) {
        line += "  <td style=\"text-align: center;\"><img alt=\"\" src=\"" + item.icon.src + "\"></td>\n";
      } else {
        line += "  <td> </td>\n";
      }
      line += "  <td>" + item.data.name + "</td>\n";
      line += "  <td style=\"text-align: center;\">" + Math.ceil(item.data.value * 0.8) + "G</td>\n";
      line += "  <td style=\"text-align: center;\">" + itemCount + "</td>\n";
      line += "  <td>" + item.data.description + "</td>\n";
      line += "  <td><button data-id=\"" + itemId + "\" class=\"brownButton\">卖出</button></td>\n";

      line += "</tr>\n";
      table += line;
      index++;
    });

    sellWindowTable.innerHTML = table;
    win.show();
  });

  win.whenUp(["enter"], function () {
    var buttons = sellWindowTable.querySelectorAll("button");
    if (lastSelect >= 0 && lastSelect < buttons.length) {
      buttons[lastSelect].click();
    }
  });

  win.whenUp(["up", "down"], function (key) {
    var count = sellWindowTable.querySelectorAll("button").length;
    if (count <= 0) return;

    if (lastSelect == -1) {
      if (key == "down") {
        win.open(lastItems, lastFilter, 0);
      } else if (key == "up") {
        win.open(lastItems, lastFilter, count - 1);
      }
    } else {
      if (key == "down") {
        var select = lastSelect + 1;
        if (select >= count) {
          select = 0;
        }
        win.open(lastItems, lastFilter, select);
      } else if (key == "up") {
        var select = lastSelect - 1;
        if (select < 0) {
          select = count - 1;
        }
        win.open(lastItems, lastFilter, select);
      }
    }
  });

  win.whenUp(["esc"], function () {
    setTimeout(function () {
      win.hide();
    }, 20);
  });

  win.whenUp(["left", "right"], function (key) {
    if (key == "right") {
      var filter = lastFilter;
      if (filter == null) {
        filter = "sword";
      } else if (filter.match(/sword/)) {
        filter = "head";
      } else if (filter.match(/head/)) {
        filter = "potion";
      } else if (filter.match(/potion/)) {
        filter = "material";
      } else if (filter.match(/material/)) {
        filter = "book";
      } else if (filter.match(/book/)) {
        filter = "misc";
      } else if (filter.match(/misc/)) {
        filter = null;
      }
      win.open(lastItems, filter);
    } else if (key == "left") {
      var filter = lastFilter;
      if (filter == null) {
        filter = "misc";
      } else if (filter.match(/sword/)) {
        filter = null;
      } else if (filter.match(/head/)) {
        filter = "sword";
      } else if (filter.match(/potion/)) {
        filter = "head";
      } else if (filter.match(/material/)) {
        filter = "potion";
      } else if (filter.match(/book/)) {
        filter = "material";
      } else if (filter.match(/misc/)) {
        filter = "book";
      }
      win.open(lastItems, filter);
    }
  });

  sellWindowTable.addEventListener("click", function (event) {
    var itemId = event.target.getAttribute("data-id");
    if (itemId && Game.hero.data.items.hasOwnProperty(itemId)) {
      var item = Game.items[itemId];
      var itemCount = Game.hero.data.items[itemId];

      if (lastItems.hasOwnProperty(itemId)) {
        lastItems[itemId]++;
      } else {
        lastItems[itemId] = 1;
      }

      if (itemCount == 1) {
        Game.hero.data.bar.forEach(function (element, index, array) {
          if (element && element.id == itemId) {
            array[index] = null;
          }
        });
        Sprite.each(Game.hero.data.equipment, function (element, key) {
          if (element == itemId) {
            Game.hero.data.equipment[key] = null;
          }
        });
        delete Game.hero.data.items[itemId];
      } else {
        Game.hero.data.items[itemId]--;
      }

      Game.hero.data.gold += Math.ceil(item.data.value * 0.8);
      Game.windows.interface.refresh();
      win.open(lastItems, lastFilter);
    }
  });
})();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9HYW1lL0dhbWVXaW5kb3dTZWxsLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFvQkEsQ0FBQyxZQUFZO0FBQ1gsY0FBWSxDQUFDOztBQUViLE1BQUksR0FBRyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFDOztBQUUvRCxLQUFHLENBQUMsSUFBSSx1dkNBa0NQLENBQUM7O0FBRUYsS0FBRyxDQUFDLEdBQUcsaXVCQXlDTixDQUFDOztBQUVGLE1BQUksZUFBZSxHQUFHLEdBQUcsQ0FBQyxhQUFhLENBQUMsd0JBQXdCLENBQUMsQ0FBQztBQUNsRSxNQUFJLGFBQWEsR0FBRyxHQUFHLENBQUMsYUFBYSxDQUFDLHNCQUFzQixDQUFDLENBQUM7O0FBRTlELE1BQUksYUFBYSxHQUFHLEdBQUcsQ0FBQyxhQUFhLENBQUMsc0JBQXNCLENBQUMsQ0FBQztBQUM5RCxNQUFJLGdCQUFnQixHQUFHLEdBQUcsQ0FBQyxhQUFhLENBQUMseUJBQXlCLENBQUMsQ0FBQztBQUNwRSxNQUFJLGVBQWUsR0FBRyxHQUFHLENBQUMsYUFBYSxDQUFDLHdCQUF3QixDQUFDLENBQUM7QUFDbEUsTUFBSSxnQkFBZ0IsR0FBRyxHQUFHLENBQUMsYUFBYSxDQUFDLHlCQUF5QixDQUFDLENBQUM7QUFDcEUsTUFBSSxrQkFBa0IsR0FBRyxHQUFHLENBQUMsYUFBYSxDQUFDLDJCQUEyQixDQUFDLENBQUM7QUFDeEUsTUFBSSxjQUFjLEdBQUcsR0FBRyxDQUFDLGFBQWEsQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDO0FBQ2hFLE1BQUksY0FBYyxHQUFHLEdBQUcsQ0FBQyxhQUFhLENBQUMsdUJBQXVCLENBQUMsQ0FBQzs7QUFFaEUsTUFBSSxjQUFjLEdBQUcsR0FBRyxDQUFDLGFBQWEsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO0FBQzlELE1B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R0FBRyxFQUFFO0FBQzVELGNBQUksT0FBTyxJQUFJLE1BQU0sRUFBRTtBQUNyQixnQkFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQztXQUN0QztTQUNGLENBQUMsQ0FBQztBQUNILGVBQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDO09BQ3JDLE1BQU07QUFDTCxZQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQztPQUNoQzs7QUFFRCxVQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssR0FBRyxHQUFHLENBQUMsQ0FBQztBQUN4RCxVQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztBQUNqQyxTQUFHLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxVQUFVLENBQUMsQ0FBQztLQUNqQztHQUNGLENBQUMsQ0FBQztDQUdKLENBQUEsRUFBRyxDQUFDIiwiZmlsZSI6IkdhbWVXaW5kb3dTZWxsLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLypcblxuQS1SUEcgR2FtZSwgQnVpbHQgdXNpbmcgSmF2YVNjcmlwdCBFUzZcbkNvcHlyaWdodCAoQykgMjAxNSBxaGR1YW4oaHR0cDovL3FoZHVhbi5jb20pXG5cblRoaXMgcHJvZ3JhbSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IgbW9kaWZ5XG5pdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieVxudGhlIEZyZWUgU29mdHdhcmUgRm91bmRhdGlvbiwgZWl0aGVyIHZlcnNpb24gMyBvZiB0aGUgTGljZW5zZSwgb3JcbihhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uXG5cblRoaXMgcHJvZ3JhbSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLFxuYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2Zcbk1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGVcbkdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuXG5cbllvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlXG5hbG9uZyB3aXRoIHRoaXMgcHJvZ3JhbS4gIElmIG5vdCwgc2VlIDxodHRwOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi5cblxuKi9cblxuKGZ1bmN0aW9uICgpIHtcbiAgXCJ1c2Ugc3RyaWN0XCI7XG5cbiAgbGV0IHdpbiA9IEdhbWUud2luZG93cy5zZWxsID0gR2FtZS5XaW5kb3cuY3JlYXRlKFwic2VsbFdpbmRvd1wiKTtcblxuICB3aW4uaHRtbCA9IGBcbiAgPGRpdiBjbGFzcz1cIndpbmRvdy1ib3hcIj5cbiAgICA8ZGl2IGlkPVwic2VsbFdpbmRvd0l0ZW1CYXJcIj5cblxuICAgICAgPGJ1dHRvbiBpZD1cInNlbGxXaW5kb3dDbG9zZVwiIGNsYXNzPVwiYnJvd25CdXR0b25cIj7lhbPpl608L2J1dHRvbj5cbiAgICAgIDxidXR0b24gaWQ9XCJzZWxsV2luZG93QnV5XCIgY2xhc3M9XCJicm93bkJ1dHRvblwiPuS5sOWFpTwvYnV0dG9uPlxuXG4gICAgICA8YnV0dG9uIGlkPVwic2VsbFdpbmRvd0FsbFwiIGNsYXNzPVwiYnJvd25CdXR0b25cIj7lhajpg6g8L2J1dHRvbj5cbiAgICAgIDxidXR0b24gaWQ9XCJzZWxsV2luZG93V2VhcG9uXCIgY2xhc3M9XCJicm93bkJ1dHRvblwiPuatpuWZqDwvYnV0dG9uPlxuICAgICAgPGJ1dHRvbiBpZD1cInNlbGxXaW5kb3dBcm1vclwiIGNsYXNzPVwiYnJvd25CdXR0b25cIj7miqTnlLI8L2J1dHRvbj5cbiAgICAgIDxidXR0b24gaWQ9XCJzZWxsV2luZG93UG90aW9uXCIgY2xhc3M9XCJicm93bkJ1dHRvblwiPuiNr+awtDwvYnV0dG9uPlxuICAgICAgPGJ1dHRvbiBpZD1cInNlbGxXaW5kb3dNYXRlcmlhbFwiIGNsYXNzPVwiYnJvd25CdXR0b25cIj7mnZDmlpk8L2J1dHRvbj5cbiAgICAgIDxidXR0b24gaWQ9XCJzZWxsV2luZG93Qm9va1wiIGNsYXNzPVwiYnJvd25CdXR0b25cIj7kuabnsY08L2J1dHRvbj5cbiAgICAgIDxidXR0b24gaWQ9XCJzZWxsV2luZG93TWlzY1wiIGNsYXNzPVwiYnJvd25CdXR0b25cIj7lhbbku5Y8L2J1dHRvbj5cbiAgICA8L2Rpdj5cblxuICAgIDxzcGFuIGlkPVwic2VsbFdpbmRvd0dvbGRcIj48L3NwYW4+XG5cbiAgICA8ZGl2IHN0eWxlPVwib3ZlcmZsb3c6IGF1dG87IGhlaWdodDogMzAwcHg7XCI+XG4gICAgICA8dGFibGUgYm9yZGVyPVwiMFwiPlxuICAgICAgICA8dGhlYWQ+XG4gICAgICAgICAgPHRyPlxuICAgICAgICAgICAgPHRkIHN0eWxlPVwid2lkdGg6IDQwcHg7XCI+PC90ZD5cbiAgICAgICAgICAgIDx0ZCBzdHlsZT1cIndpZHRoOiAxMjBweDtcIj48L3RkPlxuICAgICAgICAgICAgPHRkIHN0eWxlPVwid2lkdGg6IDMwcHg7XCI+PC90ZD5cbiAgICAgICAgICAgIDx0ZCBzdHlsZT1cIndpZHRoOiAzMHB4O1wiPjwvdGQ+XG4gICAgICAgICAgICA8dGQ+PC90ZD5cbiAgICAgICAgICAgIDx0ZCBzdHlsZT1cIndpZHRoOiA2MHB4O1wiPjwvdGQ+XG4gICAgICAgICAgPC90cj5cbiAgICAgICAgPC90aGVhZD5cbiAgICAgICAgPHRib2R5IGlkPVwic2VsbFdpbmRvd1RhYmxlXCI+PC90Ym9keT5cbiAgICAgIDwvdGFibGU+XG4gICAgPC9kaXY+XG4gIDwvZGl2PlxuICBgO1xuXG4gIHdpbi5jc3MgPSBgXG5cbiAgICAjc2VsbFdpbmRvd1RhYmxlIHRyOm50aC1jaGlsZChvZGQpIHtcbiAgICAgIGJhY2tncm91bmQtY29sb3I6IHJnYmEoMTkyLCAxOTIsIDE5MiwgMC42KTtcbiAgICB9XG5cbiAgICAjc2VsbFdpbmRvd0l0ZW1CYXIgPiBidXR0b24ge1xuICAgICAgd2lkdGg6IDYwcHg7XG4gICAgICBoZWlnaHQ6IDQwcHg7XG4gICAgICBmb250LXNpemU6IDE2cHg7XG4gICAgICBtYXJnaW4tbGVmdDogNXB4O1xuICAgICAgbWFyZ2luLXJpZ2h0OiA1cHg7XG4gICAgICBtYXJnaW4tdG9wOiAwcHg7XG4gICAgICBtYXJnaW4tYm90dG9tOiA1cHg7XG4gICAgfVxuXG4gICAgI3NlbGxXaW5kb3dDbG9zZSB7XG4gICAgICBmbG9hdDogcmlnaHQ7XG4gICAgfVxuXG4gICAgI3NlbGxXaW5kb3dTdGF0dXMge1xuICAgICAgZmxvYXQ6IHJpZ2h0O1xuICAgIH1cblxuICAgIC5zZWxsV2luZG93IHRhYmxlIHtcbiAgICAgIHdpZHRoOiAxMDAlO1xuICAgIH1cblxuICAgIC5zZWxsV2luZG93IHRhYmxlIGJ1dHRvbiB7XG4gICAgICB3aWR0aDogNjBweDtcbiAgICAgIGhlaWdodDogNDBweDtcbiAgICAgIGZvbnQtc2l6ZTogMTZweDtcbiAgICB9XG5cbiAgICAjc2VsbFdpbmRvd0dvbGQge1xuICAgICAgcG9zaXRpb246IGFic29sdXRlO1xuICAgICAgcmlnaHQ6IDEwMHB4O1xuICAgICAgYm90dG9tOiAzMHB4O1xuICAgICAgZm9udC1zaXplOiAyMHB4O1xuICAgICAgY29sb3I6IGJsYWNrO1xuICAgIH1cbiAgYDtcblxuICBsZXQgc2VsbFdpbmRvd0Nsb3NlID0gd2luLnF1ZXJ5U2VsZWN0b3IoXCJidXR0b24jc2VsbFdpbmRvd0Nsb3NlXCIpO1xuICBsZXQgc2VsbFdpbmRvd0J1eSA9IHdpbi5xdWVyeVNlbGVjdG9yKFwiYnV0dG9uI3NlbGxXaW5kb3dCdXlcIik7XG5cbiAgbGV0IHNlbGxXaW5kb3dBbGwgPSB3aW4ucXVlcnlTZWxlY3RvcihcImJ1dHRvbiNzZWxsV2luZG93QWxsXCIpO1xuICBsZXQgc2VsbFdpbmRvd1dlYXBvbiA9IHdpbi5xdWVyeVNlbGVjdG9yKFwiYnV0dG9uI3NlbGxXaW5kb3dXZWFwb25cIik7XG4gIGxldCBzZWxsV2luZG93QXJtb3IgPSB3aW4ucXVlcnlTZWxlY3RvcihcImJ1dHRvbiNzZWxsV2luZG93QXJtb3JcIik7XG4gIGxldCBzZWxsV2luZG93UG90aW9uID0gd2luLnF1ZXJ5U2VsZWN0b3IoXCJidXR0b24jc2VsbFdpbmRvd1BvdGlvblwiKTtcbiAgbGV0IHNlbGxXaW5kb3dNYXRlcmlhbCA9IHdpbi5xdWVyeVNlbGVjdG9yKFwiYnV0dG9uI3NlbGxXaW5kb3dNYXRlcmlhbFwiKTtcbiAgbGV0IHNlbGxXaW5kb3dCb29rID0gd2luLnF1ZXJ5U2VsZWN0b3IoXCJidXR0b24jc2VsbFdpbmRvd0Jvb2tcIik7XG4gIGxldCBzZWxsV2luZG93TWlzYyA9IHdpbi5xdWVyeVNlbGVjdG9yKFwiYnV0dG9uI3NlbGxXaW5kb3dNaXNjXCIpO1xuXG4gIGxldCBzZWxsV2luZG93R29sZCA9IHdpbi5xdWVyeVNlbGVjdG9yKFwic3BhbiNzZWxsV2luZG93R29sZFwiKTtcbiAgbGV0IHNlbGxXaW5kb3dUYWJsZSA9IHdpbi5xdWVyeVNlbGVjdG9yKFwiI3NlbGxXaW5kb3dUYWJsZVwiKTtcblxuICBsZXQgbGFzdEl0ZW1zID0gbnVsbDtcbiAgbGV0IGxhc3RGaWx0ZXIgPSBudWxsO1xuICBsZXQgbGFzdFNlbGVjdCA9IC0xO1xuXG4gIHNlbGxXaW5kb3dDbG9zZS5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgZnVuY3Rpb24gKCkge1xuICAgIHdpbi5oaWRlKCk7XG4gIH0pO1xuXG4gIHNlbGxXaW5kb3dCdXkuYWRkRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsIGZ1bmN0aW9uICgpIHtcbiAgICB3aW4uaGlkZSgpO1xuICAgIEdhbWUud2luZG93cy5idXkub3BlbihsYXN0SXRlbXMpO1xuICB9KTtcblxuICB3aW4ud2hlblVwKFtcInRhYlwiXSwgZnVuY3Rpb24gKCkge1xuICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xuICAgICAgd2luLmhpZGUoKTtcbiAgICAgIEdhbWUud2luZG93cy5idXkub3BlbihsYXN0SXRlbXMpO1xuICAgIH0sIDIwKTtcbiAgfSk7XG5cbiAgc2VsbFdpbmRvd0FsbC5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgZnVuY3Rpb24gKGV2ZW50KSB7XG4gICAgd2luLm9wZW4obGFzdEl0ZW1zLCBudWxsKTtcbiAgfSk7XG5cbiAgc2VsbFdpbmRvd1dlYXBvbi5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgZnVuY3Rpb24gKGV2ZW50KSB7XG4gICAgd2luLm9wZW4obGFzdEl0ZW1zLCBcInN3b3JkfHNwZWFyfGJvd1wiKTtcbiAgfSk7XG5cbiAgc2VsbFdpbmRvd0FybW9yLmFkZEV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCBmdW5jdGlvbiAoZXZlbnQpIHtcbiAgICB3aW4ub3BlbihsYXN0SXRlbXMsIFwiaGVhZHxib2R5fGZlZXRcIik7XG4gIH0pO1xuXG4gIHNlbGxXaW5kb3dQb3Rpb24uYWRkRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsIGZ1bmN0aW9uIChldmVudCkge1xuICAgIHdpbi5vcGVuKGxhc3RJdGVtcywgXCJwb3Rpb25cIik7XG4gIH0pO1xuXG4gIHNlbGxXaW5kb3dNYXRlcmlhbC5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgZnVuY3Rpb24gKGV2ZW50KSB7XG4gICAgd2luLm9wZW4obGFzdEl0ZW1zLCBcIm1hdGVyaWFsXCIpO1xuICB9KTtcblxuICBzZWxsV2luZG93Qm9vay5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgZnVuY3Rpb24gKGV2ZW50KSB7XG4gICAgd2luLm9wZW4obGFzdEl0ZW1zLCBcImJvb2t8c2Nyb2xsfGxldHRlclwiKTtcbiAgfSk7XG5cbiAgc2VsbFdpbmRvd01pc2MuYWRkRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsIGZ1bmN0aW9uIChldmVudCkge1xuICAgIHdpbi5vcGVuKGxhc3RJdGVtcywgXCJtaXNjXCIpO1xuICB9KTtcblxuICB3aW4uYXNzaWduKFwib3BlblwiLCBmdW5jdGlvbiAoaXRlbXMsIGZpbHRlciwgc2VsZWN0KSB7XG5cbiAgICBpZiAodHlwZW9mIHNlbGVjdCA9PSBcInVuZGVmaW5lZFwiKSB7XG4gICAgICBzZWxlY3QgPSAtMTtcbiAgICB9XG5cbiAgICBsYXN0SXRlbXMgPSBpdGVtcztcbiAgICBsYXN0RmlsdGVyID0gZmlsdGVyO1xuICAgIGxhc3RTZWxlY3QgPSBzZWxlY3Q7XG5cbiAgICBzZWxsV2luZG93R29sZC50ZXh0Q29udGVudCA9IEdhbWUuaGVyby5kYXRhLmdvbGQgKyBcIkdcIjtcblxuICAgIGxldCBkZWZhdWx0Q29sb3IgPSBcIndoaXRlXCI7XG4gICAgbGV0IGFjdGl2ZUNvbG9yID0gXCJ5ZWxsb3dcIjtcblxuICAgIHNlbGxXaW5kb3dBbGwuc3R5bGUuY29sb3IgPSBkZWZhdWx0Q29sb3I7XG4gICAgc2VsbFdpbmRvd1dlYXBvbi5zdHlsZS5jb2xvciA9IGRlZmF1bHRDb2xvcjtcbiAgICBzZWxsV2luZG93QXJtb3Iuc3R5bGUuY29sb3IgPSBkZWZhdWx0Q29sb3I7XG4gICAgc2VsbFdpbmRvd1BvdGlvbi5zdHlsZS5jb2xvciA9IGRlZmF1bHRDb2xvcjtcbiAgICBzZWxsV2luZG93TWF0ZXJpYWwuc3R5bGUuY29sb3IgPSBkZWZhdWx0Q29sb3I7XG4gICAgc2VsbFdpbmRvd0Jvb2suc3R5bGUuY29sb3IgPSBkZWZhdWx0Q29sb3I7XG4gICAgc2VsbFdpbmRvd01pc2Muc3R5bGUuY29sb3IgPSBkZWZhdWx0Q29sb3I7XG5cbiAgICBpZiAoZmlsdGVyID09IG51bGwpIHtcbiAgICAgIHNlbGxXaW5kb3dBbGwuc3R5bGUuY29sb3IgPSBhY3RpdmVDb2xvcjtcbiAgICB9IGVsc2UgaWYgKGZpbHRlci5tYXRjaCgvc3dvcmQvKSkge1xuICAgICAgc2VsbFdpbmRvd1dlYXBvbi5zdHlsZS5jb2xvciA9IGFjdGl2ZUNvbG9yO1xuICAgIH0gZWxzZSBpZiAoZmlsdGVyLm1hdGNoKC9oZWFkLykpIHtcbiAgICAgIHNlbGxXaW5kb3dBcm1vci5zdHlsZS5jb2xvciA9IGFjdGl2ZUNvbG9yO1xuICAgIH0gZWxzZSBpZiAoZmlsdGVyLm1hdGNoKC9wb3Rpb24vKSkge1xuICAgICAgc2VsbFdpbmRvd1BvdGlvbi5zdHlsZS5jb2xvciA9IGFjdGl2ZUNvbG9yO1xuICAgIH0gZWxzZSBpZiAoZmlsdGVyLm1hdGNoKC9tYXRlcmlhbC8pKSB7XG4gICAgICBzZWxsV2luZG93TWF0ZXJpYWwuc3R5bGUuY29sb3IgPSBhY3RpdmVDb2xvcjtcbiAgICB9IGVsc2UgaWYgKGZpbHRlci5tYXRjaCgvYm9vay8pKSB7XG4gICAgICBzZWxsV2luZG93Qm9vay5zdHlsZS5jb2xvciA9IGFjdGl2ZUNvbG9yO1xuICAgIH0gZWxzZSBpZiAoZmlsdGVyLm1hdGNoKC9taXNjLykpIHtcbiAgICAgIHNlbGxXaW5kb3dNaXNjLnN0eWxlLmNvbG9yID0gYWN0aXZlQ29sb3I7XG4gICAgfVxuXG4gICAgbGV0IGluZGV4ID0gMDtcbiAgICBsZXQgdGFibGUgPSBcIlwiO1xuICAgIFNwcml0ZS5lYWNoKEdhbWUuaGVyby5kYXRhLml0ZW1zLCBmdW5jdGlvbiAoaXRlbUNvdW50LCBpdGVtSWQpIHtcbiAgICAgIGxldCBpdGVtID0gR2FtZS5pdGVtc1tpdGVtSWRdO1xuXG4gICAgICBpZiAoZmlsdGVyICYmIGZpbHRlci5pbmRleE9mKGl0ZW0uZGF0YS50eXBlKSA9PSAtMSlcbiAgICAgICAgcmV0dXJuO1xuXG4gICAgICBsZXQgbGluZSA9IFwiXCI7XG5cbiAgICAgIGlmIChzZWxlY3QgPT0gaW5kZXgpIHtcbiAgICAgICAgbGluZSArPSBgPHRyIHN0eWxlPVwiYmFja2dyb3VuZC1jb2xvcjogZ3JlZW47XCI+XFxuYDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxpbmUgKz0gYDx0cj5cXG5gO1xuICAgICAgfVxuXG5cbiAgICAgIGlmIChpdGVtLmljb24pIHtcbiAgICAgICAgbGluZSArPSBgICA8dGQgc3R5bGU9XCJ0ZXh0LWFsaWduOiBjZW50ZXI7XCI+PGltZyBhbHQ9XCJcIiBzcmM9XCIke2l0ZW0uaWNvbi5zcmN9XCI+PC90ZD5cXG5gO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbGluZSArPSBgICA8dGQ+IDwvdGQ+XFxuYDtcbiAgICAgIH1cbiAgICAgIGxpbmUgKz0gYCAgPHRkPiR7aXRlbS5kYXRhLm5hbWV9PC90ZD5cXG5gO1xuICAgICAgbGluZSArPSBgICA8dGQgc3R5bGU9XCJ0ZXh0LWFsaWduOiBjZW50ZXI7XCI+JHtNYXRoLmNlaWwoaXRlbS5kYXRhLnZhbHVlICogMC44KX1HPC90ZD5cXG5gO1xuICAgICAgbGluZSArPSBgICA8dGQgc3R5bGU9XCJ0ZXh0LWFsaWduOiBjZW50ZXI7XCI+JHtpdGVtQ291bnR9PC90ZD5cXG5gO1xuICAgICAgbGluZSArPSBgICA8dGQ+JHtpdGVtLmRhdGEuZGVzY3JpcHRpb259PC90ZD5cXG5gO1xuICAgICAgbGluZSArPSBgICA8dGQ+PGJ1dHRvbiBkYXRhLWlkPVwiJHtpdGVtSWR9XCIgY2xhc3M9XCJicm93bkJ1dHRvblwiPuWNluWHujwvYnV0dG9uPjwvdGQ+XFxuYDtcblxuICAgICAgbGluZSArPSBcIjwvdHI+XFxuXCI7XG4gICAgICB0YWJsZSArPSBsaW5lO1xuICAgICAgaW5kZXgrKztcbiAgICB9KTtcblxuICAgIHNlbGxXaW5kb3dUYWJsZS5pbm5lckhUTUwgPSB0YWJsZTtcbiAgICB3aW4uc2hvdygpO1xuICB9KTtcblxuICB3aW4ud2hlblVwKFtcImVudGVyXCJdLCBmdW5jdGlvbiAoKSB7XG4gICAgbGV0IGJ1dHRvbnMgPSBzZWxsV2luZG93VGFibGUucXVlcnlTZWxlY3RvckFsbChcImJ1dHRvblwiKTtcbiAgICBpZiAobGFzdFNlbGVjdCA+PSAwICYmIGxhc3RTZWxlY3QgPCBidXR0b25zLmxlbmd0aCkge1xuICAgICAgYnV0dG9uc1tsYXN0U2VsZWN0XS5jbGljaygpO1xuICAgIH1cbiAgfSk7XG5cbiAgd2luLndoZW5VcChbXCJ1cFwiLCBcImRvd25cIl0sIGZ1bmN0aW9uIChrZXkpIHtcbiAgICBsZXQgY291bnQgPSBzZWxsV2luZG93VGFibGUucXVlcnlTZWxlY3RvckFsbChcImJ1dHRvblwiKS5sZW5ndGg7XG4gICAgaWYgKGNvdW50IDw9IDApIHJldHVybjtcblxuICAgIGlmIChsYXN0U2VsZWN0ID09IC0xKSB7XG4gICAgICBpZiAoa2V5ID09IFwiZG93blwiKSB7XG4gICAgICAgIHdpbi5vcGVuKGxhc3RJdGVtcywgbGFzdEZpbHRlciwgMCk7XG4gICAgICB9IGVsc2UgaWYgKGtleSA9PSBcInVwXCIpIHtcbiAgICAgICAgd2luLm9wZW4obGFzdEl0ZW1zLCBsYXN0RmlsdGVyLCBjb3VudCAtIDEpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoa2V5ID09IFwiZG93blwiKSB7XG4gICAgICAgIGxldCBzZWxlY3QgPSBsYXN0U2VsZWN0ICsgMTtcbiAgICAgICAgaWYgKHNlbGVjdCA+PSBjb3VudCkge1xuICAgICAgICAgIHNlbGVjdCA9IDA7XG4gICAgICAgIH1cbiAgICAgICAgd2luLm9wZW4obGFzdEl0ZW1zLCBsYXN0RmlsdGVyLCBzZWxlY3QpO1xuICAgICAgfSBlbHNlIGlmIChrZXkgPT0gXCJ1cFwiKSB7XG4gICAgICAgIGxldCBzZWxlY3QgPSBsYXN0U2VsZWN0IC0gMTtcbiAgICAgICAgaWYgKHNlbGVjdCA8IDApIHtcbiAgICAgICAgICBzZWxlY3QgPSBjb3VudCAtIDE7XG4gICAgICAgIH1cbiAgICAgICAgd2luLm9wZW4obGFzdEl0ZW1zLCBsYXN0RmlsdGVyLCBzZWxlY3QpO1xuICAgICAgfVxuICAgIH1cbiAgfSk7XG5cbiAgd2luLndoZW5VcChbXCJlc2NcIl0sIGZ1bmN0aW9uICgpIHtcbiAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcbiAgICAgIHdpbi5oaWRlKCk7XG4gICAgfSwgMjApO1xuICB9KTtcblxuICB3aW4ud2hlblVwKFtcImxlZnRcIiwgXCJyaWdodFwiXSwgZnVuY3Rpb24gKGtleSkge1xuICAgIGlmIChrZXkgPT0gXCJyaWdodFwiKSB7XG4gICAgICBsZXQgZmlsdGVyID0gbGFzdEZpbHRlcjtcbiAgICAgIGlmIChmaWx0ZXIgPT0gbnVsbCkge1xuICAgICAgICBmaWx0ZXIgPSBcInN3b3JkXCI7XG4gICAgICB9IGVsc2UgaWYgKGZpbHRlci5tYXRjaCgvc3dvcmQvKSkge1xuICAgICAgICBmaWx0ZXIgPSBcImhlYWRcIjtcbiAgICAgIH0gZWxzZSBpZiAoZmlsdGVyLm1hdGNoKC9oZWFkLykpIHtcbiAgICAgICAgZmlsdGVyID0gXCJwb3Rpb25cIjtcbiAgICAgIH0gZWxzZSBpZiAoZmlsdGVyLm1hdGNoKC9wb3Rpb24vKSkge1xuICAgICAgICBmaWx0ZXIgPSBcIm1hdGVyaWFsXCI7XG4gICAgICB9IGVsc2UgaWYgKGZpbHRlci5tYXRjaCgvbWF0ZXJpYWwvKSkge1xuICAgICAgICBmaWx0ZXIgPSBcImJvb2tcIjtcbiAgICAgIH0gZWxzZSBpZiAoZmlsdGVyLm1hdGNoKC9ib29rLykpIHtcbiAgICAgICAgZmlsdGVyID0gXCJtaXNjXCI7XG4gICAgICB9IGVsc2UgaWYgKGZpbHRlci5tYXRjaCgvbWlzYy8pKSB7XG4gICAgICAgIGZpbHRlciA9IG51bGw7XG4gICAgICB9XG4gICAgICB3aW4ub3BlbihsYXN0SXRlbXMsIGZpbHRlcik7XG4gICAgfSBlbHNlIGlmIChrZXkgPT0gXCJsZWZ0XCIpIHtcbiAgICAgIGxldCBmaWx0ZXIgPSBsYXN0RmlsdGVyO1xuICAgICAgaWYgKGZpbHRlciA9PSBudWxsKSB7XG4gICAgICAgIGZpbHRlciA9IFwibWlzY1wiO1xuICAgICAgfSBlbHNlIGlmIChmaWx0ZXIubWF0Y2goL3N3b3JkLykpIHtcbiAgICAgICAgZmlsdGVyID0gbnVsbDtcbiAgICAgIH0gZWxzZSBpZiAoZmlsdGVyLm1hdGNoKC9oZWFkLykpIHtcbiAgICAgICAgZmlsdGVyID0gXCJzd29yZFwiO1xuICAgICAgfSBlbHNlIGlmIChmaWx0ZXIubWF0Y2goL3BvdGlvbi8pKSB7XG4gICAgICAgIGZpbHRlciA9IFwiaGVhZFwiO1xuICAgICAgfSBlbHNlIGlmIChmaWx0ZXIubWF0Y2goL21hdGVyaWFsLykpIHtcbiAgICAgICAgZmlsdGVyID0gXCJwb3Rpb25cIjtcbiAgICAgIH0gZWxzZSBpZiAoZmlsdGVyLm1hdGNoKC9ib29rLykpIHtcbiAgICAgICAgZmlsdGVyID0gXCJtYXRlcmlhbFwiO1xuICAgICAgfSBlbHNlIGlmIChmaWx0ZXIubWF0Y2goL21pc2MvKSkge1xuICAgICAgICBmaWx0ZXIgPSBcImJvb2tcIjtcbiAgICAgIH1cbiAgICAgIHdpbi5vcGVuKGxhc3RJdGVtcywgZmlsdGVyKTtcbiAgICB9XG4gIH0pO1xuXG4gIHNlbGxXaW5kb3dUYWJsZS5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgZnVuY3Rpb24gKGV2ZW50KSB7XG4gICAgbGV0IGl0ZW1JZCA9IGV2ZW50LnRhcmdldC5nZXRBdHRyaWJ1dGUoXCJkYXRhLWlkXCIpO1xuICAgIGlmIChpdGVtSWQgJiYgR2FtZS5oZXJvLmRhdGEuaXRlbXMuaGFzT3duUHJvcGVydHkoaXRlbUlkKSkge1xuICAgICAgbGV0IGl0ZW0gPSBHYW1lLml0ZW1zW2l0ZW1JZF07XG4gICAgICBsZXQgaXRlbUNvdW50ID0gR2FtZS5oZXJvLmRhdGEuaXRlbXNbaXRlbUlkXTtcblxuICAgICAgaWYgKGxhc3RJdGVtcy5oYXNPd25Qcm9wZXJ0eShpdGVtSWQpKSB7XG4gICAgICAgIGxhc3RJdGVtc1tpdGVtSWRdKys7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsYXN0SXRlbXNbaXRlbUlkXSA9IDE7XG4gICAgICB9XG5cbiAgICAgIGlmIChpdGVtQ291bnQgPT0gMSkge1xuICAgICAgICBHYW1lLmhlcm8uZGF0YS5iYXIuZm9yRWFjaChmdW5jdGlvbiAoZWxlbWVudCwgaW5kZXgsIGFycmF5KSB7XG4gICAgICAgICAgaWYgKGVsZW1lbnQgJiYgZWxlbWVudC5pZCA9PSBpdGVtSWQpIHtcbiAgICAgICAgICAgIGFycmF5W2luZGV4XSA9IG51bGw7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgU3ByaXRlLmVhY2goR2FtZS5oZXJvLmRhdGEuZXF1aXBtZW50LCBmdW5jdGlvbiAoZWxlbWVudCwga2V5KSB7XG4gICAgICAgICAgaWYgKGVsZW1lbnQgPT0gaXRlbUlkKSB7XG4gICAgICAgICAgICBHYW1lLmhlcm8uZGF0YS5lcXVpcG1lbnRba2V5XSA9IG51bGw7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgZGVsZXRlIEdhbWUuaGVyby5kYXRhLml0ZW1zW2l0ZW1JZF07XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBHYW1lLmhlcm8uZGF0YS5pdGVtc1tpdGVtSWRdLS07XG4gICAgICB9XG5cbiAgICAgIEdhbWUuaGVyby5kYXRhLmdvbGQgKz0gTWF0aC5jZWlsKGl0ZW0uZGF0YS52YWx1ZSAqIDAuOCk7XG4gICAgICBHYW1lLndpbmRvd3MuaW50ZXJmYWNlLnJlZnJlc2goKTtcbiAgICAgIHdpbi5vcGVuKGxhc3RJdGVtcywgbGFzdEZpbHRlcik7XG4gICAgfVxuICB9KTtcblxuXG59KSgpO1xuIl19
