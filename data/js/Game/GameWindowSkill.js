"use strict";

/*

A-RPG Game, Built using JavaScript ES6
Copyright (C) 2015 qhduan(http://qhduan.com)

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.

*/

(function () {
  "use strict";

  var win = Game.windows.skill = Game.Window.create("skillWindow");

  win.html = "\n    <div class=\"window-box\">\n      <div id=\"skillWindowItemBar\">\n        <button id=\"skillWindowClose\" class=\"brownButton\">关闭</button>\n      </div>\n      <table border=\"0\">\n        <thead>\n          <tr>\n            <th style=\"width: 40px;\"></th>\n            <th style=\"width: 120px;\"></th>\n            <th></td>\n            <th style=\"width: 60px;\"></th>\n          </tr>\n        </thead>\n        <tbody id=\"skillWindowTable\"></tbody>\n      </table>\n    </div>\n  ";

  win.css = "\n    .skillWindow table {\n      width: 100%;\n    }\n\n    .skillWindow tr:nth-child(odd) {\n      background-color: rgba(192, 192, 192, 0.6);\n    }\n\n    .skillWindow table img {\n      width: 100%;\n      height: 100%;\n    }\n\n    .skillWindow button {\n      width: 60px;\n      height: 40px;\n      font-size: 16px;\n    }\n\n    #skillWindowItemBar button {\n      width: 60px;\n      height: 40px;\n      font-size: 16px;\n      margin-left: 5px;\n      margin-right: 5px;\n      margin-top: 0px;\n      margin-bottom: 5px;\n    }\n\n    #skillWindowClose {\n      float: right;\n    }\n  ";

  var skillWindowClose = win.querySelector("button#skillWindowClose");
  var skillWindowTable = win.querySelector("#skillWindowTable");

  var lastSelect = -1;

  skillWindowClose.addEventListener("click", function (event) {
    win.hide();
  });

  win.whenUp(["esc"], function (key) {
    setTimeout(function () {
      win.hide();
    }, 20);
  });

  win.assign("open", function (select) {

    if (typeof select == "undefined") {
      select = -1;
    }

    lastSelect = select;

    var index = 0;
    var table = "";
    Game.hero.data.skills.forEach(function (skillId) {
      var skill = Game.skills[skillId];

      var line = "";

      if (select == index) {
        line += "<tr style=\"background-color: green;\">\n";
      } else {
        line += "<tr>\n";
      }

      line += "  <td><img alt=\"\" src=\"" + skill.icon.src + "\"></td>\n";
      line += "  <td>" + skill.data.name + "</td>\n";
      line += "  <td>" + skill.data.description + "</td>\n";
      line += "  <td><button data-id=\"" + skillId + "\" class=\"brownButton skillWindowManage\">管理</button></td>\n";
      line += "</tr>\n";
      table += line;
      index++;
    });

    skillWindowTable.innerHTML = table;
    Game.windows.skill.show();
  });

  win.whenUp(["enter"], function () {
    var buttons = win.querySelectorAll(".skillWindowManage");
    if (lastSelect >= 0 && lastSelect < buttons.length) {
      buttons[lastSelect].click();
    }
  });

  win.whenUp(["up", "down"], function (key) {
    var count = win.querySelectorAll(".skillWindowManage").length;

    if (lastSelect == -1) {
      if (key == "down") {
        win.open(0);
      } else if (key == "up") {
        win.open(count - 1);
      }
    } else {
      if (key == "down") {
        var select = lastSelect + 1;
        if (select >= count) {
          select = 0;
        }
        win.open(select);
      } else if (key == "up") {
        var select = lastSelect - 1;
        if (select < 0) {
          select = count - 1;
        }
        win.open(select);
      }
    }
  });

  skillWindowTable.addEventListener("click", function (event) {
    var skillId = event.target.getAttribute("data-id");
    var index = Game.hero.data.skills.indexOf(skillId);
    if (skillId && Game.skills.hasOwnProperty(skillId) && index != -1) {
      (function () {

        var skill = Game.skills[skillId];

        var options = {};

        options["快捷栏"] = "shortcut";
        options["遗忘"] = "remove";
        if (skill.data.next) {
          options["升级"] = "levelup";
        }

        Game.choice(options).then(function (choice) {
          switch (choice) {
            case "shortcut":
              Game.choice({
                1: 0,
                2: 1,
                3: 2,
                4: 3,
                5: 4,
                6: 5,
                7: 6,
                8: 7
              }).then(function (choice) {
                if (Number.isFinite(choice) && choice >= 0) {
                  Game.hero.data.bar[choice] = {
                    id: skillId,
                    type: "skill"
                  };
                  Game.windows.interface.refresh();
                }
              });
              break;
            case "levelup":
              if (skill.data.next) {
                var cannot = [];
                if (Game.hero.data.gold < skill.data.next.gold) {
                  cannot.push("金币不足，需要金币" + skill.data.next.gold + "，当前您有金币" + Game.hero.data.gold);
                }
                if (Game.hero.data.exp < skill.data.next.exp) {
                  cannot.push("经验不足，需要经验" + skill.data.next.exp + "，当前您有经验" + Game.hero.data.exp);
                }
                if (cannot.length) {
                  Game.dialogue(cannot);
                  return;
                }
                Game.confirm("确定要升级这个技能吗？共需要金币" + skill.data.next.gold + "，经验" + skill.data.next.exp).then(function () {
                  var nextId = skill.data.next.id;
                  Game.hero.data.skills.splice(index, 1);
                  Game.hero.data.skills.push(nextId);
                  Game.hero.data.gold -= skill.data.next.gold;
                  Game.hero.data.exp -= skill.data.next.exp;
                  Game.windows.loading.begin();
                  Game.Skill.load(nextId).then(function (skillObj) {
                    Game.windows.loading.end();
                    win.open();
                  });
                }).catch(function () {
                  // no
                });
              }
              break;
            case "remove":
              Game.confirm("真的要遗忘 " + skill.data.name + " 技能吗？").then(function () {
                Game.hero.data.bar.forEach(function (element, index, array) {
                  if (element && element.id == skillId) {
                    array[index] = null;
                  }
                });
                Game.hero.data.skills.splice(index, 1);
                Game.windows.interface.refresh();
                win.open();
              }).catch(function () {
                // no
              });
              break;
          }
        });
      })();
    }
  });
})();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9HYW1lL0dhbWVXaW5kb3dTa2lsbC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBb0JBLENBQUMsWUFBWTtBQUNYLGNBQVksQ0FBQzs7QUFFYixNQUFJLEdBQUcsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUMsQ0FBQzs7QUFFakUsS0FBRyxDQUFDLElBQUksd2ZBaUJQLENBQUM7O0FBRUYsS0FBRyxDQUFDLEdBQUcsOGxCQWlDTixDQUFDOztBQUVGLE1BQUksZ0JBQWdCLEdBQUcsR0FBRyxDQUFDLGFBQWEsQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDO0FBQ3BFLE1BQUksZ0JBQWdCLEdBQUcsR0FBRyxDQUFDLGFBQWEsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDOztBQUU5RCxNQUFJLFVBQVUsR0FBRyxDQUFDLENBQUMsQ0FBQzs7QUFFcEIsa0JBQWdCLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxFQUFFLFVBQVUsS0FBSyxFQUFFO0FBQzFELE9BQUcsQ0FBQyxJQUFJLEVBQUUsQ0FBQztHQUNaLENBQUMsQ0FBQzs7QUFFSCxLQUFHLENBQUMsTUFBTSxDQUFDLENBQUMsS0FBSyxDQUFDLEVBQUUsVUFBVSxHQUFHLEVBQUU7QUFDakMsY0FBVSxDQUFDLFlBQVk7QUFDckIsU0FBRyxDQUFDLElBQUksRUFBRSxDQUFDO0tBQ1osRUFBRSxFQUFFLENBQUMsQ0FBQztHQUNSLENBQUMsQ0FBQzs7QUFFSCxLQUFHLENBQUMsTUFBTSxDQUFDLE1BQU0sRUFBRSxVQUFVLE1BQU0sRUFBRTs7QUFFbkMsUUFBSSxPQUFPLE1BQU0sSUFBSSxXQUFXLEVBQUU7QUFDaEMsWUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDO0tBQ2I7O0FBRUQsY0FBVSxHQUFHLE1BQU0sQ0FBQzs7QUFFcEIsUUFBSSxLQUFLLEdBQUcsQ0FBQyxDQUFDO0FB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bUJBQ3JCO2lCQUNGLENBQUMsQ0FBQztBQUNILG9CQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FBQztBQUN2QyxvQkFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsT0FBTyxFQUFFLENBQUM7QUFDakMsbUJBQUcsQ0FBQyxJQUFJLEVBQUUsQ0FBQztlQUNaLENBQUMsQ0FBQyxLQUFLLENBQUMsWUFBTTs7ZUFFZCxDQUFDLENBQUM7QUFDSCxvQkFBTTtBQUFBLFdBQ1Q7U0FDRixDQUFDLENBQUM7O0tBRUo7R0FDRixDQUFDLENBQUM7Q0FHSixDQUFBLEVBQUcsQ0FBQyIsImZpbGUiOiJHYW1lV2luZG93U2tpbGwuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuXG5BLVJQRyBHYW1lLCBCdWlsdCB1c2luZyBKYXZhU2NyaXB0IEVTNlxuQ29weXJpZ2h0IChDKSAyMDE1IHFoZHVhbihodHRwOi8vcWhkdWFuLmNvbSlcblxuVGhpcyBwcm9ncmFtIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnlcbml0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5XG50aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uLCBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvclxuKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi5cblxuVGhpcyBwcm9ncmFtIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsXG5idXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZlxuTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiAgU2VlIHRoZVxuR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy5cblxuWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2VcbmFsb25nIHdpdGggdGhpcyBwcm9ncmFtLiAgSWYgbm90LCBzZWUgPGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LlxuXG4qL1xuXG4oZnVuY3Rpb24gKCkge1xuICBcInVzZSBzdHJpY3RcIjtcblxuICBsZXQgd2luID0gR2FtZS53aW5kb3dzLnNraWxsID0gR2FtZS5XaW5kb3cuY3JlYXRlKFwic2tpbGxXaW5kb3dcIik7XG5cbiAgd2luLmh0bWwgPSBgXG4gICAgPGRpdiBjbGFzcz1cIndpbmRvdy1ib3hcIj5cbiAgICAgIDxkaXYgaWQ9XCJza2lsbFdpbmRvd0l0ZW1CYXJcIj5cbiAgICAgICAgPGJ1dHRvbiBpZD1cInNraWxsV2luZG93Q2xvc2VcIiBjbGFzcz1cImJyb3duQnV0dG9uXCI+5YWz6ZetPC9idXR0b24+XG4gICAgICA8L2Rpdj5cbiAgICAgIDx0YWJsZSBib3JkZXI9XCIwXCI+XG4gICAgICAgIDx0aGVhZD5cbiAgICAgICAgICA8dHI+XG4gICAgICAgICAgICA8dGggc3R5bGU9XCJ3aWR0aDogNDBweDtcIj48L3RoPlxuICAgICAgICAgICAgPHRoIHN0eWxlPVwid2lkdGg6IDEyMHB4O1wiPjwvdGg+XG4gICAgICAgICAgICA8dGg+PC90ZD5cbiAgICAgICAgICAgIDx0aCBzdHlsZT1cIndpZHRoOiA2MHB4O1wiPjwvdGg+XG4gICAgICAgICAgPC90cj5cbiAgICAgICAgPC90aGVhZD5cbiAgICAgICAgPHRib2R5IGlkPVwic2tpbGxXaW5kb3dUYWJsZVwiPjwvdGJvZHk+XG4gICAgICA8L3RhYmxlPlxuICAgIDwvZGl2PlxuICBgO1xuXG4gIHdpbi5jc3MgPSBgXG4gICAgLnNraWxsV2luZG93IHRhYmxlIHtcbiAgICAgIHdpZHRoOiAxMDAlO1xuICAgIH1cblxuICAgIC5za2lsbFdpbmRvdyB0cjpudGgtY2hpbGQob2RkKSB7XG4gICAgICBiYWNrZ3JvdW5kLWNvbG9yOiByZ2JhKDE5MiwgMTkyLCAxOTIsIDAuNik7XG4gICAgfVxuXG4gICAgLnNraWxsV2luZG93IHRhYmxlIGltZyB7XG4gICAgICB3aWR0aDogMTAwJTtcbiAgICAgIGhlaWdodDogMTAwJTtcbiAgICB9XG5cbiAgICAuc2tpbGxXaW5kb3cgYnV0dG9uIHtcbiAgICAgIHdpZHRoOiA2MHB4O1xuICAgICAgaGVpZ2h0OiA0MHB4O1xuICAgICAgZm9udC1zaXplOiAxNnB4O1xuICAgIH1cblxuICAgICNza2lsbFdpbmRvd0l0ZW1CYXIgYnV0dG9uIHtcbiAgICAgIHdpZHRoOiA2MHB4O1xuICAgICAgaGVpZ2h0OiA0MHB4O1xuICAgICAgZm9udC1zaXplOiAxNnB4O1xuICAgICAgbWFyZ2luLWxlZnQ6IDVweDtcbiAgICAgIG1hcmdpbi1yaWdodDogNXB4O1xuICAgICAgbWFyZ2luLXRvcDogMHB4O1xuICAgICAgbWFyZ2luLWJvdHRvbTogNXB4O1xuICAgIH1cblxuICAgICNza2lsbFdpbmRvd0Nsb3NlIHtcbiAgICAgIGZsb2F0OiByaWdodDtcbiAgICB9XG4gIGA7XG5cbiAgbGV0IHNraWxsV2luZG93Q2xvc2UgPSB3aW4ucXVlcnlTZWxlY3RvcihcImJ1dHRvbiNza2lsbFdpbmRvd0Nsb3NlXCIpO1xuICBsZXQgc2tpbGxXaW5kb3dUYWJsZSA9IHdpbi5xdWVyeVNlbGVjdG9yKFwiI3NraWxsV2luZG93VGFibGVcIik7XG5cbiAgbGV0IGxhc3RTZWxlY3QgPSAtMTtcblxuICBza2lsbFdpbmRvd0Nsb3NlLmFkZEV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCBmdW5jdGlvbiAoZXZlbnQpIHtcbiAgICB3aW4uaGlkZSgpO1xuICB9KTtcblxuICB3aW4ud2hlblVwKFtcImVzY1wiXSwgZnVuY3Rpb24gKGtleSkge1xuICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xuICAgICAgd2luLmhpZGUoKTtcbiAgICB9LCAyMCk7XG4gIH0pO1xuXG4gIHdpbi5hc3NpZ24oXCJvcGVuXCIsIGZ1bmN0aW9uIChzZWxlY3QpIHtcblxuICAgIGlmICh0eXBlb2Ygc2VsZWN0ID09IFwidW5kZWZpbmVkXCIpIHtcbiAgICAgIHNlbGVjdCA9IC0xO1xuICAgIH1cblxuICAgIGxhc3RTZWxlY3QgPSBzZWxlY3Q7XG5cbiAgICBsZXQgaW5kZXggPSAwO1xuICAgIGxldCB0YWJsZSA9IFwiXCI7XG4gICAgR2FtZS5oZXJvLmRhdGEuc2tpbGxzLmZvckVhY2goZnVuY3Rpb24gKHNraWxsSWQpIHtcbiAgICAgIGxldCBza2lsbCA9IEdhbWUuc2tpbGxzW3NraWxsSWRdO1xuXG4gICAgICBsZXQgbGluZSA9IFwiXCI7XG5cbiAgICAgIGlmIChzZWxlY3QgPT0gaW5kZXgpIHtcbiAgICAgICAgbGluZSArPSBgPHRyIHN0eWxlPVwiYmFja2dyb3VuZC1jb2xvcjogZ3JlZW47XCI+XFxuYDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxpbmUgKz0gYDx0cj5cXG5gO1xuICAgICAgfVxuXG4gICAgICBsaW5lICs9IGAgIDx0ZD48aW1nIGFsdD1cIlwiIHNyYz1cIiR7c2tpbGwuaWNvbi5zcmN9XCI+PC90ZD5cXG5gO1xuICAgICAgbGluZSArPSBgICA8dGQ+JHtza2lsbC5kYXRhLm5hbWV9PC90ZD5cXG5gO1xuICAgICAgbGluZSArPSBgICA8dGQ+JHtza2lsbC5kYXRhLmRlc2NyaXB0aW9ufTwvdGQ+XFxuYDtcbiAgICAgIGxpbmUgKz0gYCAgPHRkPjxidXR0b24gZGF0YS1pZD1cIiR7c2tpbGxJZH1cIiBjbGFzcz1cImJyb3duQnV0dG9uIHNraWxsV2luZG93TWFuYWdlXCI+566h55CGPC9idXR0b24+PC90ZD5cXG5gO1xuICAgICAgbGluZSArPSBcIjwvdHI+XFxuXCI7XG4gICAgICB0YWJsZSArPSBsaW5lO1xuICAgICAgaW5kZXgrKztcbiAgICB9KTtcblxuICAgIHNraWxsV2luZG93VGFibGUuaW5uZXJIVE1MID0gdGFibGU7XG4gICAgR2FtZS53aW5kb3dzLnNraWxsLnNob3coKTtcbiAgfSk7XG5cbiAgd2luLndoZW5VcChbXCJlbnRlclwiXSwgZnVuY3Rpb24gKCkge1xuICAgIGxldCBidXR0b25zID0gd2luLnF1ZXJ5U2VsZWN0b3JBbGwoXCIuc2tpbGxXaW5kb3dNYW5hZ2VcIik7XG4gICAgaWYgKGxhc3RTZWxlY3QgPj0gMCAmJiBsYXN0U2VsZWN0IDwgYnV0dG9ucy5sZW5ndGgpIHtcbiAgICAgIGJ1dHRvbnNbbGFzdFNlbGVjdF0uY2xpY2soKTtcbiAgICB9XG4gIH0pO1xuXG4gIHdpbi53aGVuVXAoW1widXBcIiwgXCJkb3duXCJdLCBmdW5jdGlvbiAoa2V5KSB7XG4gICAgbGV0IGNvdW50ID0gd2luLnF1ZXJ5U2VsZWN0b3JBbGwoXCIuc2tpbGxXaW5kb3dNYW5hZ2VcIikubGVuZ3RoO1xuXG4gICAgaWYgKGxhc3RTZWxlY3QgPT0gLTEpIHtcbiAgICAgIGlmIChrZXkgPT0gXCJkb3duXCIpIHtcbiAgICAgICAgd2luLm9wZW4oMCk7XG4gICAgICB9IGVsc2UgaWYgKGtleSA9PSBcInVwXCIpIHtcbiAgICAgICAgd2luLm9wZW4oY291bnQgLSAxKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKGtleSA9PSBcImRvd25cIikge1xuICAgICAgICBsZXQgc2VsZWN0ID0gbGFzdFNlbGVjdCArIDE7XG4gICAgICAgIGlmIChzZWxlY3QgPj0gY291bnQpIHtcbiAgICAgICAgICBzZWxlY3QgPSAwO1xuICAgICAgICB9XG4gICAgICAgIHdpbi5vcGVuKHNlbGVjdCk7XG4gICAgICB9IGVsc2UgaWYgKGtleSA9PSBcInVwXCIpIHtcbiAgICAgICAgbGV0IHNlbGVjdCA9IGxhc3RTZWxlY3QgLSAxO1xuICAgICAgICBpZiAoc2VsZWN0IDwgMCkge1xuICAgICAgICAgIHNlbGVjdCA9IGNvdW50IC0gMTtcbiAgICAgICAgfVxuICAgICAgICB3aW4ub3BlbihzZWxlY3QpO1xuICAgICAgfVxuICAgIH1cbiAgfSk7XG5cbiAgc2tpbGxXaW5kb3dUYWJsZS5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgZnVuY3Rpb24gKGV2ZW50KSB7XG4gICAgbGV0IHNraWxsSWQgPSBldmVudC50YXJnZXQuZ2V0QXR0cmlidXRlKFwiZGF0YS1pZFwiKTtcbiAgICBsZXQgaW5kZXggPSBHYW1lLmhlcm8uZGF0YS5za2lsbHMuaW5kZXhPZihza2lsbElkKTtcbiAgICBpZiAoc2tpbGxJZCAmJiBHYW1lLnNraWxscy5oYXNPd25Qcm9wZXJ0eShza2lsbElkKSAmJiBpbmRleCAhPSAtMSkge1xuXG4gICAgICBsZXQgc2tpbGwgPSBHYW1lLnNraWxsc1tza2lsbElkXTtcblxuICAgICAgbGV0IG9wdGlvbnMgPSB7fTtcblxuICAgICAgb3B0aW9uc1tcIuW/q+aNt+agj1wiXSA9IFwic2hvcnRjdXRcIjtcbiAgICAgIG9wdGlvbnNbXCLpgZflv5hcIl0gPSBcInJlbW92ZVwiO1xuICAgICAgaWYgKHNraWxsLmRhdGEubmV4dCkge1xuICAgICAgICBvcHRpb25zW1wi5Y2H57qnXCJdID0gXCJsZXZlbHVwXCI7XG4gICAgICB9XG5cbiAgICAgIEdhbWUuY2hvaWNlKG9wdGlvbnMpLnRoZW4oKGNob2ljZSkgPT4ge1xuICAgICAgICBzd2l0Y2goY2hvaWNlKSB7XG4gICAgICAgICAgY2FzZSBcInNob3J0Y3V0XCI6XG4gICAgICAgICAgICBHYW1lLmNob2ljZSh7XG4gICAgICAgICAgICAgIDE6MCxcbiAgICAgICAgICAgICAgMjoxLFxuICAgICAgICAgICAgICAzOjIsXG4gICAgICAgICAgICAgIDQ6MyxcbiAgICAgICAgICAgICAgNTo0LFxuICAgICAgICAgICAgICA2OjUsXG4gICAgICAgICAgICAgIDc6NixcbiAgICAgICAgICAgICAgODo3XG4gICAgICAgICAgICB9KS50aGVuKChjaG9pY2UpID0+IHtcbiAgICAgICAgICAgICAgaWYgKE51bWJlci5pc0Zpbml0ZShjaG9pY2UpICYmIGNob2ljZSA+PSAwKSB7XG4gICAgICAgICAgICAgICAgR2FtZS5oZXJvLmRhdGEuYmFyW2Nob2ljZV0gPSB7XG4gICAgICAgICAgICAgICAgICBpZDogc2tpbGxJZCxcbiAgICAgICAgICAgICAgICAgIHR5cGU6IFwic2tpbGxcIlxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgR2FtZS53aW5kb3dzLmludGVyZmFjZS5yZWZyZXNoKCk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgY2FzZSBcImxldmVsdXBcIjpcbiAgICAgICAgICAgIGlmIChza2lsbC5kYXRhLm5leHQpIHtcbiAgICAgICAgICAgICAgbGV0IGNhbm5vdCA9IFtdO1xuICAgICAgICAgICAgICBpZiAoR2FtZS5oZXJvLmRhdGEuZ29sZCA8IHNraWxsLmRhdGEubmV4dC5nb2xkKSB7XG4gICAgICAgICAgICAgICAgY2Fubm90LnB1c2goYOmHkeW4geS4jei2s++8jOmcgOimgemHkeW4gSR7c2tpbGwuZGF0YS5uZXh0LmdvbGR977yM5b2T5YmN5oKo5pyJ6YeR5biBJHtHYW1lLmhlcm8uZGF0YS5nb2xkfWApO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIGlmIChHYW1lLmhlcm8uZGF0YS5leHAgPCBza2lsbC5kYXRhLm5leHQuZXhwKSB7XG4gICAgICAgICAgICAgICAgY2Fubm90LnB1c2goYOe7j+mqjOS4jei2s++8jOmcgOimgee7j+mqjCR7c2tpbGwuZGF0YS5uZXh0LmV4cH3vvIzlvZPliY3mgqjmnInnu4/pqowke0dhbWUuaGVyby5kYXRhLmV4cH1gKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBpZiAoY2Fubm90Lmxlbmd0aCkge1xuICAgICAgICAgICAgICAgIEdhbWUuZGlhbG9ndWUoY2Fubm90KTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgR2FtZS5jb25maXJtKGDnoa7lrpropoHljYfnuqfov5nkuKrmioDog73lkJfvvJ/lhbHpnIDopoHph5HluIEke3NraWxsLmRhdGEubmV4dC5nb2xkfe+8jOe7j+mqjCR7c2tpbGwuZGF0YS5uZXh0LmV4cH1gKS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgbmV4dElkID0gc2tpbGwuZGF0YS5uZXh0LmlkO1xuICAgICAgICAgICAgICAgIEdhbWUuaGVyby5kYXRhLnNraWxscy5zcGxpY2UoaW5kZXgsIDEpO1xuICAgICAgICAgICAgICAgIEdhbWUuaGVyby5kYXRhLnNraWxscy5wdXNoKG5leHRJZCk7XG4gICAgICAgICAgICAgICAgR2FtZS5oZXJvLmRhdGEuZ29sZCAtPSBza2lsbC5kYXRhLm5leHQuZ29sZDtcbiAgICAgICAgICAgICAgICBHYW1lLmhlcm8uZGF0YS5leHAgLT0gc2tpbGwuZGF0YS5uZXh0LmV4cDtcbiAgICAgICAgICAgICAgICBHYW1lLndpbmRvd3MubG9hZGluZy5iZWdpbigpO1xuICAgICAgICAgICAgICAgIEdhbWUuU2tpbGwubG9hZChuZXh0SWQpLnRoZW4oZnVuY3Rpb24gKHNraWxsT2JqKSB7XG4gICAgICAgICAgICAgICAgICBHYW1lLndpbmRvd3MubG9hZGluZy5lbmQoKTtcbiAgICAgICAgICAgICAgICAgIHdpbi5vcGVuKCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgIH0pLmNhdGNoKCgpID0+IHtcbiAgICAgICAgICAgICAgICAvLyBub1xuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIGNhc2UgXCJyZW1vdmVcIjpcbiAgICAgICAgICAgIEdhbWUuY29uZmlybShg55yf55qE6KaB6YGX5b+YICR7c2tpbGwuZGF0YS5uYW1lfSDmioDog73lkJfvvJ9gKS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgR2FtZS5oZXJvLmRhdGEuYmFyLmZvckVhY2goZnVuY3Rpb24gKGVsZW1lbnQsIGluZGV4LCBhcnJheSkge1xuICAgICAgICAgICAgICAgIGlmIChlbGVtZW50ICYmIGVsZW1lbnQuaWQgPT0gc2tpbGxJZCkge1xuICAgICAgICAgICAgICAgICAgYXJyYXlbaW5kZXhdID0gbnVsbDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICBHYW1lLmhlcm8uZGF0YS5za2lsbHMuc3BsaWNlKGluZGV4LCAxKTtcbiAgICAgICAgICAgICAgR2FtZS53aW5kb3dzLmludGVyZmFjZS5yZWZyZXNoKCk7XG4gICAgICAgICAgICAgIHdpbi5vcGVuKCk7XG4gICAgICAgICAgICB9KS5jYXRjaCgoKSA9PiB7XG4gICAgICAgICAgICAgIC8vIG5vXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICB9KTtcblxuICAgIH1cbiAgfSk7XG5cblxufSkoKTtcbiJdfQ==
