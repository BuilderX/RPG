/*

A-RPG Game, Built using JavaScript ES6
Copyright (C) 2015 qhduan(http://qhduan.com)

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.

*/

"use strict";

(function () {
  "use strict";

  var popupCache = new Map();

  Game.assign("popup", function (obj, text) {
    var adjustX = arguments.length <= 2 || arguments[2] === undefined ? 0 : arguments[2];
    var adjustY = arguments.length <= 3 || arguments[3] === undefined ? 0 : arguments[3];

    if (popupCache.has(obj)) {
      var popup = popupCache.get(obj);
      Game.layers.dialogueLayer.removeChild(popup.container);
      clearInterval(popup.timer);
      popupCache["delete"](obj);
    }

    var dialogueText = new Sprite.Text({
      text: text,
      maxWidth: 200
    });

    var w = dialogueText.width;
    var h = dialogueText.height;
    var middle = Math.round((w + 10) / 2);

    var dialogueBox = new Sprite.Shape();

    dialogueBox.polygon({
      points: "0,0 " + (w + 10) + ",0 " + (w + 10) + "," + (h + 10) + " " + (middle + 5) + "," + (h + 10) + " " + middle + "," + (h + 15) + " " + (middle - 5) + "," + (h + 10) + " 0," + (h + 10) + " 0,0",
      fill: "white"
    });

    var dialogueContainer = new Sprite.Container();
    dialogueContainer.appendChild(dialogueBox, dialogueText);
    dialogueText.x = 5;
    dialogueText.y = 5;
    dialogueContainer.x = obj.x + adjustX;
    dialogueContainer.y = obj.y + adjustY;
    dialogueContainer.centerX = middle;
    dialogueContainer.centerY = h + 15;

    Game.layers.dialogueLayer.appendChild(dialogueContainer);

    if (obj instanceof Sprite.Event) {
      obj.on("change", function () {
        dialogueContainer.x = obj.x + adjustX;
        dialogueContainer.y = obj.y + adjustY;
      });
    }

    var timer = setTimeout(function () {
      if (popupCache.has(obj)) {
        var popup = popupCache.get(obj);
        Game.layers.dialogueLayer.removeChild(popup.container);
        popupCache["delete"](obj);
      }
    }, 3000);

    popupCache.set(obj, {
      container: dialogueContainer,
      timer: timer
    });
  });
})();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9HYW1lL0dhbWVVSS5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBb0JBLENBQUMsWUFBWTtBQUNYLGNBQVksQ0FBQzs7QUFFYixNQUFJLFVBQVUsR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDOztBQUUzQixNQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBRSxVQUFVLEdBQUcsRUFBRSxJQUFJLEVBQTRCO1FBQTFCLE9BQU8seURBQUcsQ0FBQztRQUFFLE9BQU8seURBQUcsQ0FBQzs7QUFFaEUsUUFBSSxVQUFVLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFFO0FBQ3ZCLFVBQUksS0FBSyxHQUFHLFVBQVUsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDaEMsVUFBSSxDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQztBQUN2RCxtQkFBYSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUMzQixnQkFBVSxVQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7S0FDeEI7O0FBRUQsUUFBSSxZQUFZLEdBQUcsSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDO0FBQ2pDLFVBQUksRUFBRSxJQUFJO0FBQ1YsY0FBUSxFQUFFLEdBQUc7S0FDZCxDQUFDLENBQUM7O0FBRUgsUUFBSSxDQUFDLEdBQUcsWUFBWSxDQUFDLEtBQUssQ0FBQztBQUMzQixRQUFJLENBQUMsR0FBRyxZQUFZLENBQUMsTUFBTSxDQUFDO0FBQzVCLFFBQUksTUFBTSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFBLEdBQUksQ0FBQyxDQUFDLENBQUM7O0FBRXRDLFFBQUksV0FBVyxHQUFHLElBQUksTUFBTSxDQUFDLEtBQUssRUFBRSxDQUFDOztBQUVyQyxlQUFXLENBQUMsT0FBTyxDQUFDO0FBQ2xCLFlBQU0sWUFBUyxDQUFDLEdBQUMsRUFBRSxDQUFBLFlBQU0sQ0FBQyxHQUFDLEVBQUUsQ0FBQSxVQUFJLENBQUMsR0FBQyxFQUFFLENBQUEsVUFBSSxNQUFNLEdBQUMsQ0FBQyxDQUFBLFVBQUksQ0FBQyxHQUFDLEVBQUUsQ0FBQSxTQUFJLE1BQU0sVUFBSSxDQUFDLEdBQUMsRUFBRSxDQUFBLFVBQUksTUFBTSxHQUFDLENBQUMsQ0FBQSxVQUFJLENBQUMsR0FBQyxFQUFFLENBQUEsWUFBTSxDQUFDLEdBQUMsRUFBRSxDQUFBLFNBQU07QUFDL0csVUFBSSxFQUFFLE9BQU87S0FDZCxDQUFDLENBQUM7O0FBRUgsUUFBSSxpQkFBaUIsR0FBRyxJQUFJLE1BQU0sQ0FBQyxTQUFTLEVBQUUsQ0FBQztBQUMvQyxxQkFBaUIsQ0FBQyxXQUFXLENBQUMsV0FBVyxFQUFFLFlBQVksQ0FBQyxDQUFDO0FBQ3pELGdCQUFZLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUNuQixnQkFBWSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDbkIscUJBQWlCLENBQUMsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDLEdBQUcsT0FBTyxDQUFDO0FBQ3RDLHFCQUFpQixDQUFDLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxHQUFHLE9BQU8sQ0FBQztBQUN0QyxxQkFBaUIsQ0FBQyxPQUFPLEdBQUcsTUFBTSxDQUFDO0FBQ25DLHFCQUFpQixDQUFDLE9BQU8sR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDOztBQUVuQyxRQUFJLENBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQyxXQUFXLENBQUMsaUJBQWlCLENBQUMsQ0FBQzs7QUFFekQsUUFBSSxHQUFHLFlBQVksTUFBTSxDQUFDLEtBQUssRUFBRTtBQUMvQixTQUFHLENBQUMsRUFBRSxDQUFDLFFBQVEsRUFBRSxZQUFZO0FBQzNCLHlCQUFpQixDQUFDLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxHQUFHLE9BQU8sQ0FBQztBQUN0Qyx5QkFBaUIsQ0FBQyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsR0FBRyxPQUFPLENBQUM7T0FDdkMsQ0FBQyxDQUFDO0tBQ0o7O0FBRUQsUUFBSSxLQUFLLEdBQUcsVUFBVSxDQUFDLFlBQU07QUFDM0IsVUFBSSxVQUFVLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFFO0FBQ3ZCLFlBQUksS0FBSyxHQUFHLFVBQVUsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDaEMsWUFBSSxDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQztBQUN2RCxrQkFBVSxVQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7T0FDeEI7S0FDRixFQUFFLElBQUksQ0FBQyxDQUFDOztBQUVULGNBQVUsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFO0FBQ2xCLGVBQVMsRUFBRSxpQkFBaUI7QUFDNUIsV0FBSyxFQUFFLEtBQUs7S0FDYixDQUFDLENBQUM7R0FDSixDQUFDLENBQUM7Q0FHSixDQUFBLEVBQUcsQ0FBQyIsImZpbGUiOiJHYW1lVUkuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuXG5BLVJQRyBHYW1lLCBCdWlsdCB1c2luZyBKYXZhU2NyaXB0IEVTNlxuQ29weXJpZ2h0IChDKSAyMDE1IHFoZHVhbihodHRwOi8vcWhkdWFuLmNvbSlcblxuVGhpcyBwcm9ncmFtIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnlcbml0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5XG50aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uLCBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvclxuKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi5cblxuVGhpcyBwcm9ncmFtIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsXG5idXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZlxuTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiAgU2VlIHRoZVxuR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy5cblxuWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2VcbmFsb25nIHdpdGggdGhpcyBwcm9ncmFtLiAgSWYgbm90LCBzZWUgPGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LlxuXG4qL1xuXG4oZnVuY3Rpb24gKCkge1xuICBcInVzZSBzdHJpY3RcIjtcblxuICBsZXQgcG9wdXBDYWNoZSA9IG5ldyBNYXAoKTtcblxuICBHYW1lLmFzc2lnbihcInBvcHVwXCIsIGZ1bmN0aW9uIChvYmosIHRleHQsIGFkanVzdFggPSAwLCBhZGp1c3RZID0gMCkge1xuXG4gICAgaWYgKHBvcHVwQ2FjaGUuaGFzKG9iaikpIHtcbiAgICAgIGxldCBwb3B1cCA9IHBvcHVwQ2FjaGUuZ2V0KG9iaik7XG4gICAgICBHYW1lLmxheWVycy5kaWFsb2d1ZUxheWVyLnJlbW92ZUNoaWxkKHBvcHVwLmNvbnRhaW5lcik7XG4gICAgICBjbGVhckludGVydmFsKHBvcHVwLnRpbWVyKTtcbiAgICAgIHBvcHVwQ2FjaGUuZGVsZXRlKG9iaik7XG4gICAgfVxuXG4gICAgbGV0IGRpYWxvZ3VlVGV4dCA9IG5ldyBTcHJpdGUuVGV4dCh7XG4gICAgICB0ZXh0OiB0ZXh0LFxuICAgICAgbWF4V2lkdGg6IDIwMCxcbiAgICB9KTtcblxuICAgIGxldCB3ID0gZGlhbG9ndWVUZXh0LndpZHRoO1xuICAgIGxldCBoID0gZGlhbG9ndWVUZXh0LmhlaWdodDtcbiAgICBsZXQgbWlkZGxlID0gTWF0aC5yb3VuZCgodyArIDEwKSAvIDIpO1xuXG4gICAgbGV0IGRpYWxvZ3VlQm94ID0gbmV3IFNwcml0ZS5TaGFwZSgpO1xuXG4gICAgZGlhbG9ndWVCb3gucG9seWdvbih7XG4gICAgICBwb2ludHM6IGAwLDAgJHt3KzEwfSwwICR7dysxMH0sJHtoKzEwfSAke21pZGRsZSs1fSwke2grMTB9ICR7bWlkZGxlfSwke2grMTV9ICR7bWlkZGxlLTV9LCR7aCsxMH0gMCwke2grMTB9IDAsMGAsXG4gICAgICBmaWxsOiBcIndoaXRlXCJcbiAgICB9KTtcblxuICAgIGxldCBkaWFsb2d1ZUNvbnRhaW5lciA9IG5ldyBTcHJpdGUuQ29udGFpbmVyKCk7XG4gICAgZGlhbG9ndWVDb250YWluZXIuYXBwZW5kQ2hpbGQoZGlhbG9ndWVCb3gsIGRpYWxvZ3VlVGV4dCk7XG4gICAgZGlhbG9ndWVUZXh0LnggPSA1O1xuICAgIGRpYWxvZ3VlVGV4dC55ID0gNTtcbiAgICBkaWFsb2d1ZUNvbnRhaW5lci54ID0gb2JqLnggKyBhZGp1c3RYO1xuICAgIGRpYWxvZ3VlQ29udGFpbmVyLnkgPSBvYmoueSArIGFkanVzdFk7XG4gICAgZGlhbG9ndWVDb250YWluZXIuY2VudGVyWCA9IG1pZGRsZTtcbiAgICBkaWFsb2d1ZUNvbnRhaW5lci5jZW50ZXJZID0gaCArIDE1O1xuXG4gICAgR2FtZS5sYXllcnMuZGlhbG9ndWVMYXllci5hcHBlbmRDaGlsZChkaWFsb2d1ZUNvbnRhaW5lcik7XG5cbiAgICBpZiAob2JqIGluc3RhbmNlb2YgU3ByaXRlLkV2ZW50KSB7XG4gICAgICBvYmoub24oXCJjaGFuZ2VcIiwgZnVuY3Rpb24gKCkge1xuICAgICAgICBkaWFsb2d1ZUNvbnRhaW5lci54ID0gb2JqLnggKyBhZGp1c3RYO1xuICAgICAgICBkaWFsb2d1ZUNvbnRhaW5lci55ID0gb2JqLnkgKyBhZGp1c3RZO1xuICAgICAgfSk7XG4gICAgfVxuXG4gICAgbGV0IHRpbWVyID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICBpZiAocG9wdXBDYWNoZS5oYXMob2JqKSkge1xuICAgICAgICBsZXQgcG9wdXAgPSBwb3B1cENhY2hlLmdldChvYmopO1xuICAgICAgICBHYW1lLmxheWVycy5kaWFsb2d1ZUxheWVyLnJlbW92ZUNoaWxkKHBvcHVwLmNvbnRhaW5lcik7XG4gICAgICAgIHBvcHVwQ2FjaGUuZGVsZXRlKG9iaik7XG4gICAgICB9XG4gICAgfSwgMzAwMCk7XG5cbiAgICBwb3B1cENhY2hlLnNldChvYmosIHtcbiAgICAgIGNvbnRhaW5lcjogZGlhbG9ndWVDb250YWluZXIsXG4gICAgICB0aW1lcjogdGltZXJcbiAgICB9KTtcbiAgfSk7XG5cblxufSkoKTtcbiJdfQ==
