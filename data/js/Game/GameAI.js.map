{"version":3,"sources":["src/Game/GameAI.js"],"names":[],"mappings":"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","file":"src/Game/GameAI.js","sourcesContent":["/*\n\nA-RPG Game, Built using JavaScript ES6\nCopyright (C) 2015 qhduan(http://qhduan.com)\n\nThis program is free software: you can redistribute it and/or modify\nit under the terms of the GNU General Public License as published by\nthe Free Software Foundation, either version 3 of the License, or\n(at your option) any later version.\n\nThis program is distributed in the hope that it will be useful,\nbut WITHOUT ANY WARRANTY; without even the implied warranty of\nMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\nGNU General Public License for more details.\n\nYou should have received a copy of the GNU General Public License\nalong with this program.  If not, see <http://www.gnu.org/licenses/>.\n\n*/\n\n\n(function () {\n  \"use strict\";\n\n  Game.assign(\"AI\", class GameAI {\n\n    static attach (hero) {\n      let run = function () {\n        Game.AI.heroOnto();\n        Game.AI.heroTouch();\n        Game.AI.autoHide();\n      };\n      run();\n      // 英雄移动后运行\n      hero.on(\"change\", run);\n      // 游戏窗口切换后运行\n      Game.windows.interface.on(\"active\", function () {\n        run();\n      });\n    }\n\n    static autoHide () {\n      let heroHide = Game.area.map.hitAutoHide(Game.hero.x, Game.hero.y);\n\n      for (let layer of Game.layers.mapHideLayer.children) {\n        if (layer.name == heroHide) {\n          layer.visible = false;\n        } else {\n          layer.visible = true;\n        }\n      }\n\n      // 检查需要隐藏的角色，例如建筑物里的npc\n      for (let actor of Game.area.actors) {\n        if (actor != Game.hero) {\n          let actorHide = Game.area.map.hitAutoHide(actor.x, actor.y);\n          if (actorHide && actorHide == heroHide) {\n            actor.visible = true;\n          } else {\n            if (actorHide) {\n              actor.visible = false;\n            } else {\n              actor.visible = true;\n            }\n          }\n\n          // 当npc紧挨着玩家所在格子的时候，自动面向玩家\n          if (actor.distance(Game.hero) == 1) {\n            let actorFace = actor.facePosition;\n            if (actorFace.x != Game.hero.x || actorFace.y != Game.hero.y) {\n              if (actor.y == Game.hero.y) { // 同一水平\n                if (actor.x < Game.hero.x) { // npc 在玩家左边\n                  actor.face(\"right\");\n                } else if (actor.x > Game.hero.x) { // npc在玩家右边\n                  actor.face(\"left\");\n                }\n              } else if (actor.x == Game.hero.x) { // 同一垂直\n                if (actor.y < Game.hero.y) {\n                  actor.face(\"down\");\n                } else if (actor.y > Game.hero.y) {\n                  actor.face(\"up\");\n                }\n              }\n            }\n          }\n\n\n\n        }\n      }\n\n      // 检查需要隐藏的小包包，例如建筑物中地下玩家扔下的物品\n      for (let bag of Game.area.bags) {\n        let bagHide = Game.area.map.hitAutoHide(bag.x, bag.y);\n        if (bagHide && bagHide == heroHide) {\n          bag.visible = true;\n        } else {\n          if (bagHide) {\n            bag.visible = false;\n          } else {\n            bag.visible = true;\n          }\n        }\n      }\n\n    }\n\n    static heroOnto () {\n      if (!Game.area) return;\n      if (!Game.area.onto) return;\n\n      let heroPosition = Game.hero.position;\n      let onto = null;\n\n      let FindUnderHero = function (element) {\n        if (onto != null || element == Game.hero) {\n          return;\n        }\n        if (element.hitTest && element.hitTest(heroPosition.x, heroPosition.y)) {\n          onto = element;\n        } else if (element.x == heroPosition.x && element.y == heroPosition.y) {\n          onto = element;\n        }\n      }\n      // 找最近可“事件”人物 Game.area.actors\n      Sprite.each(Game.area.onto, FindUnderHero);\n      if (onto) {\n        if (onto.dest) {\n          Game.pause();\n          Game.windows.loading.begin();\n          Game.windows.loading.update(\"20%\");\n          setTimeout(function () {\n            Game.clearStage();\n            Game.windows.loading.update(\"50%\");\n            Game.loadArea(onto.dest, function (area) {\n              Game.windows.loading.update(\"80%\");\n              Game.area = area;\n              area.map.draw(Game.layers.mapLayer);\n              Game.hero.data.area = onto.dest;\n              Game.hero.draw(Game.layers.actorLayer);\n              area.actors.add(Game.hero);\n              Game.hero.x = onto.destx;\n              Game.hero.y = onto.desty;\n              Game.windows.loading.update(\"100%\");\n              setTimeout(function () {\n                Game.windows.loading.end();\n              }, 20);\n            });\n          }, 20);\n        } // dest, aka. door\n      } // touch\n    }\n\n    static heroTouch () {\n      if (!Game.area) return;\n      if (!Game.area.actors) return;\n      if (!Game.area.bags) return;\n      if (!Game.area.touch) return;\n\n      let heroPosition = Game.hero.position;\n      let heroFace = Game.hero.facePosition;\n      let touch = null;\n\n      let FindUnderHero = function (element) {\n        if (touch != null || element == Game.hero) {\n          return;\n        }\n        if (element.heroUse) {\n          if (element.hitTest && element.hitTest(heroPosition.x, heroPosition.y)) {\n            touch = element;\n          } else if (element.x == heroPosition.x && element.y == heroPosition.y) {\n            touch = element;\n          }\n        }\n      }\n\n      let FindFaceHero = function (element) {\n        if (touch != null || element == Game.hero) {\n          return;\n        }\n        if (element.heroUse) {\n          if (element.hitTest && element.hitTest(heroFace.x, heroFace.y)) {\n            touch = element;\n          } else if (element.x == heroFace.x && element.y == heroFace.y) {\n            touch = element;\n          }\n        }\n      }\n\n      // 找最近可“事件”人物 Game.area.actors\n      Sprite.each(Game.area.actors, FindUnderHero);\n      // 找最近尸体 Game.area.actors\n      Sprite.each(Game.area.bags, FindUnderHero);\n      // 最近的提示物（例如牌子）\n      Game.area.touch.forEach(FindUnderHero);\n\n      // 找最近可“事件”人物 Game.area.actors\n      Sprite.each(Game.area.actors, FindFaceHero);\n      // 找最近尸体 Game.area.actors\n      Sprite.each(Game.area.bags, FindFaceHero);\n      // 最近的提示物（例如牌子）\n      Game.area.touch.forEach(FindFaceHero);\n      // 水源\n      if (!touch && Game.area.map.hitWater(heroFace.x, heroFace.y)) {\n        touch = {\n          type: \"water\",\n          heroUse: function () {\n            Game.popup(Game.hero.sprite, \"This is water\", 0, -50);\n          }\n        };\n      }\n\n      if (!touch) {\n        Game.hintObject = null;\n        Game.windows.interface.hideUse();\n      } else {\n\n        if (touch.type == \"message\") {\n          touch.heroUse = function () {\n            Game.popup({\n              x: touch.x * 32 + 16,\n              y: touch.y * 32 + 16\n            }, touch.content, 0, -30);\n          };\n        }\n\n        Game.hintObject = touch;\n        Game.windows.interface.showUse();\n      }\n    }\n\n  });\n\n})();\n"]}