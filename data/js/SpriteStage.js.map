{"version":3,"sources":["src/SpriteStage.js"],"names":[],"mappings":"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","file":"src/SpriteStage.js","sourcesContent":["/// @file SpriteStage.js\n/// @namespace Sprite\n/// class Sprite.Stage\n\n(function () {\n  \"use strict\";\n\n  /// @class Sprite.Stage\n  /// inherit the Sprite.Container\n  Sprite.Stage = class Stage extends Sprite.Container {\n\n    /// @function Sprite.Stage.constructor\n    /// consturct a Sprite.Stage with width and height\n    /// @param width, the width of stage you need\n    /// @param height, the height of stage you need\n    constructor (width, height) {\n      super();\n\n      this._color = \"black\";\n\n      this._canvas = document.createElement(\"canvas\");\n      this._canvas.width = width || 320;\n      this._canvas.height = height || 240;\n\n      this._context = this._canvas.getContext(\"2d\");\n      this._context.imageSmoothingEnabled = false;\n\n      this._stageCacheCanvas = document.createElement(\"canvas\");\n      this._stageCacheCanvas.width = this._canvas.width;\n      this._stageCacheCanvas.height = this._canvas.height;\n\n      this._stageCacheContext = this._stageCacheCanvas.getContext(\"2d\");\n      this._stageCacheContext.imageSmoothingEnabled = false;\n\n      this._updateNextTick = false;\n\n      this.on(\"addedChildren\", () => {\n        this.update();\n      });\n\n      this.on(\"removedChildren\", () => {\n        this.update();\n      });\n\n      this.on(\"change\", () => {\n        this.update();\n      });\n\n      Sprite.Ticker.on(\"tick\", () => {\n        if (this._updateNextTick) {\n          this._updateNextTick = false;\n          this.draw();\n        }\n      });\n\n      var mousedown = false;\n\n      var ConvertMouseEvent = (event) => {\n        var x;\n        var y;\n        var type;\n        var rect = this._canvas.getBoundingClientRect();\n\n        if (event.targetTouches && event.targetTouches.length == 1) {\n          var touch = event.targetTouches[0];\n          x = touch.pageX - rect.left;\n          y = touch.pageX - rect.top;\n          type = \"touch\";\n        } else {\n          x = event.pageX - rect.left;\n          y = event.pageY - rect.top;\n          type = \"mouse\";\n        }\n\n        //x = x / this.scale.x + this.center.x;\n        //y = y / this.scale.y + this.center.y;\n        x = Math.round(x);\n        y = Math.round(y);\n        return {x, y, type};\n      }\n\n      this._canvas.addEventListener(\"mousedown\", (event) => {\n        mousedown = true;\n        this.pressdown(ConvertMouseEvent(event));\n      });\n\n      this._canvas.addEventListener(\"mousemove\", (event) => {\n        if (mousedown)\n          this.pressmove(ConvertMouseEvent(event));\n      });\n\n      this._canvas.addEventListener(\"mouseup\", (event) => {\n        mousedown = false;\n        this.pressup(ConvertMouseEvent(event));\n      });\n\n      this._canvas.addEventListener(\"touchstart\", (event) => {\n        event.preventDefault();\n        this.pressdown(ConvertMouseEvent(event));\n      });\n\n      this._canvas.addEventListener(\"touchmove\", (event) => {\n        event.preventDefault();\n        this.pressmove(ConvertMouseEvent(event));\n      });\n\n      this._canvas.addEventListener(\"touchend\", (event) => {\n        event.preventDefault();\n        this.pressup(ConvertMouseEvent(event));\n      });\n\n      this.pressdownElement = null;\n\n    }\n\n    findHit (event, mouse) {\n      var hitted = super.hitTest(mouse.x, mouse.y);\n      hitted.reverse();\n      if (hitted.length)\n        return hitted;\n      return null;\n    }\n\n    pressdown (mouse) {\n      var hit = this.findHit(\"pressdown\", mouse);\n      if (hit) {\n        hit.forEach((element) => {\n          element.emit(\"pressdown\", false, mouse);\n        });\n      }\n\n      hit = this.findHit(\"click\", mouse);\n      if (hit) {\n        this.pressdownElement = hit;\n      }\n    }\n\n    pressmove (mouse) {\n      var hit = this.findHit(\"pressmove\", mouse);\n      if (hit) {\n        hit.forEach((element) => {\n          element.emit(\"pressmove\", false, mouse);\n        });\n      }\n    }\n\n    pressup (mouse) {\n      var hit = this.findHit(\"pressup\", mouse);\n      if (hit) {\n        hit.forEach((element) => {\n          element.emit(\"pressup\", false, mouse);\n        });\n      }\n\n      hit = this.findHit(\"click\", mouse);\n      if (hit) {\n        hit.forEach((element) => {\n          if (this.pressdownElement && this.pressdownElement.indexOf(element) != -1) {\n            element.emit(\"click\");\n          }\n        });\n      }\n\n      this.pressdownElement = null;\n    }\n\n    get width () {\n      return this._canvas.width;\n    }\n\n    set width (value) {\n      this._canvas.width = value;\n      this._stageCacheCanvas.width = this._canvas.width;\n    }\n\n    get height () {\n      return this._canvas.height;\n    }\n\n    set height (value) {\n      this._canvas.height = value;\n      this._stageCacheCanvas.height = this._canvas.height;\n    }\n\n    get color () {\n      return this._color;\n    }\n\n    set color (value) {\n      if (this._color != value) {\n        this._color = value;\n        this.update();\n      }\n    }\n\n    get canvas () {\n      return this._canvas;\n    }\n\n    set canvas (value) {\n      throw new TypeError(\"Sprite.Stage.canvas readonly\")\n    }\n\n    /// @function Sprite.Stage.clear\n    /// clear the stage\n    clear () {\n      this._context.fillStyle = \"white\";\n      this._context.fillRect(0, 0, this._canvas.width, this._canvas.height);\n      //this._context.clearRect(0, 0, this._canvas.width, this._canvas.height);\n    }\n\n    update () {\n      this._updateNextTick = true;\n    }\n\n    draw () {\n      this.emit(\"drawStart\");\n\n      if (this._children.length <= 0) return false;\n\n      this._children.forEach((element) => {\n        element.draw(this._stageCacheContext);\n      });\n\n      this.clear();\n      this._context.drawImage(this._stageCacheCanvas, 0, 0);\n      //this._stageCacheContext.clearRect(0, 0, this._stageCacheCanvas.width, this._stageCacheCanvas.height);\n      this._stageCacheContext.fillStyle = this._color;\n      this._stageCacheContext.fillRect(0, 0, this._stageCacheCanvas.width, this._stageCacheCanvas.height);\n\n      this.emit(\"drawEnd\");\n    }\n  };\n\n})();\n"]}