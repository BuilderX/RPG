{"version":3,"sources":["public/src/io.js"],"names":[],"mappings":"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","file":"public/src/io.js","sourcesContent":["\t                                                                   /*\n\nOnline A-RPG Game, Built using Node.js + createjs\nCopyright (C) 2015 qhduan(http://qhduan.com)\n\nThis program is free software: you can redistribute it and/or modify\nit under the terms of the GNU General Public License as published by\nthe Free Software Foundation, either version 3 of the License, or\n(at your option) any later version.\n\nThis program is distributed in the hope that it will be useful,\nbut WITHOUT ANY WARRANTY; without even the implied warranty of\nMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\nGNU General Public License for more details.\n\nYou should have received a copy of the GNU General Public License\nalong with this program.  If not, see <http://www.gnu.org/licenses/>.\n\n*/\n(function () {\n  \"use strict\";\n\n  // 封装socket.io client的一些功能\n  Game.io = {\n    getList: {}\n  };\n\n\n\n  Game.io.hit = function (spellId, actorIds) {\n    Game.io.socket.emit(\"hit\", {\n      spellId: spellId,\n      actorIds: actorIds\n    });\n  };\n\n  function DamageHandle (data) {\n    for (var key in data) {\n      if (Game.area.actors[key])\n        Game.area.actors[key].damage(data[key]);\n      if (Game.area.heros[key])\n        Game.area.heros[key].damage(data[key]);\n    }\n  }\n\n  Game.io.updateHero = function (object) {\n    Game.io.socket.emit(\"updateHero\", {\n      object: object\n    });\n  };\n\n  Game.io.get = function (path, data, callback) {\n    var id = uuid.v4();\n    Game.io.getList[id] = callback;\n    Game.io.socket.emit(\"get\", {\n      id: id,\n      path: path,\n      data: data\n    });\n  };\n\n  function GetHandle (data) {\n    if (Game.io.getList[data.id]) {\n      Game.io.getList[data.id](data.data);\n      delete Game.io.getList[data.id];\n    } else {\n      console.log(data);\n      throw \"GetHandle IO Error\";\n    }\n  };\n\n  Game.io.sendMessage = function (message) {\n    Game.io.socket.emit(\"message\", message);\n  };\n\n  Game.io.sync = function (type, data) {\n    Game.io.socket.emit(type, data);\n  };\n\n  Game.io.init = function (callback) {\n\n    // 从页面地址找到服务器地址，服务器地址就是web地址的hostname，但是没有path\n    // 如果直接用io(\"/\")的方法链接服务器，那么端口必须是80\n    var url = (function GetServerURL () {\n      var a = document.createElement(\"a\");\n      a.href = document.URL;\n      var u = \"http://\" + a.hostname;\n      if (a.port && a.port.length) {\n        u += \":\" + a.port;\n      }\n      return u;\n    })();\n\n    var socket = Game.io.socket = io(url);\n\n    Game.io.socket.on(\"connect\", function () {\n\n      socket.on(\"disconnect\", function () {\n        alert(\"断开了服务器\");\n        window.location.href = \"/\";\n      });\n\n      socket.on(\"message\", function (data) {\n        Game.ui.showMessage(data);\n      });\n\n      socket.on(\"damage\", DamageHandle);\n\n      socket.on(\"get\", GetHandle);\n\n      // 有角色（玩家，怪物，NPC）移动时的事件\n      socket.on(\"move\", function (data) {\n        if (Game.area.heros[data.id]) {\n          Game.area.heros[data.id].gotoXY(\n            data.data.x,\n            data.data.y,\n            data.data.speed,\n            false\n          );\n        }\n      });\n\n      // 有角色（玩家或怪物）攻击时的事件\n      socket.on(\"attack\", function (data) {\n        if (Game.area.heros[data.id]) {\n          Game.area.heros[data.id].fire(\n            data.data.num,\n            data.data.direction\n          );\n        }\n      });\n\n      // 有玩家离开这个区域时的事件\n      socket.on(\"removeHero\", function (data) {\n        for (var key in Game.area.heros) {\n          if (key == data.id) {\n            Game.area.heros[key].remove(Game.heroLayer);\n          }\n        }\n      });\n\n      // 有玩家登录这个区域时的事件\n      socket.on(\"addHero\", function (data) {\n        var heroData = data.hero;\n\n        var resources = {};\n        for (var key in heroData.spells) {\n          var spellData = heroData.spells[key];\n\n          resources[spellData.image] = \"image\";\n          resources[spellData.sound] = \"sound\";\n        }\n\n        // 加载这个hero所携带的资源（图片，技能图片，等）\n        Game.preload(resources, function () {\n          Game.drawHero(heroData.custom, function (heroImage) {\n            heroData.image = heroImage;\n\n            var heroObj = new Game.ActorClass(heroData);\n            Game.area.heros[heroObj.id] = heroObj;\n            heroObj.oncomplete(function () {\n              heroObj.draw(Game.heroLayer);\n            });\n          });\n        });\n\n      });\n\n      callback();\n\n      // 这个变量和下面的onbeforeunload事件用来控制firefox的一个bug\n      // 如果触发了onbeforeunload事件则不响应disconnect事件，避免firefox提示内存泄漏\n      window.onbeforeunload = function () {\n        socket.off(\"disconnect\");\n        socket.close();\n      };\n    });\n  };\n\n})();\n"]}