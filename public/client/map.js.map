{"version":3,"sources":["public/src/map.js"],"names":[],"mappings":"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","file":"public/src/map.js","sourcesContent":["/*\n\nOnline A-RPG Game, Built using Node.js + createjs\nCopyright (C) 2015 qhduan(http://qhduan.com)\n\nThis program is free software: you can redistribute it and/or modify\nit under the terms of the GNU General Public License as published by\nthe Free Software Foundation, either version 3 of the License, or\n(at your option) any later version.\n\nThis program is distributed in the hope that it will be useful,\nbut WITHOUT ANY WARRANTY; without even the implied warranty of\nMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\nGNU General Public License for more details.\n\nYou should have received a copy of the GNU General Public License\nalong with this program.  If not, see <http://www.gnu.org/licenses/>.\n\n*/\n(function () {\n  \"use strict\";\n\n\n  Game.MapClass = class MapClass extends Game.EventClass {\n    constructor (mapData) {\n      super();\n\n      this.data = mapData;\n      this.id = this.data.id;\n\n      var images = [];\n      this.data.tilesets.forEach(function (element) {\n        images.push(element.image);\n      });\n\n      this.sheet = new createjs.SpriteSheet({\n        images: images,\n        frames: {\n          width: this.data.tilewidth,\n          height: this.data.tileheight\n        }\n      });\n\n      // 计算阻挡地图，如果为object则有阻挡，undefined则无阻挡\n      this.blockedMap = [];\n      this.blockedMap.length = this.data.height;\n\n      for(var i = 0; i < this.blockedMap.length; i++) {\n        this.blockedMap[i] = [];\n        this.blockedMap[i].length = this.data.width;\n      }\n\n      // 保存这个地图的所有地图块\n      this.container = new createjs.Container();\n\n      this.data.layers.forEach((element, index, array) => {\n        var layer = element;\n\n        if (layer.data) { // 渲染普通层\n          var sprite = new createjs.Sprite(this.sheet);\n          for (var y = 0; y < layer.height; y++) {\n            for (var x = 0; x < layer.width; x++) {\n              var position = x + y * layer.width;\n              var picture = layer.data[position] - 1;\n              if (picture >= 0) {\n                var spriteClone = sprite.clone();\n                spriteClone.x = x * this.data.tilewidth;\n                spriteClone.y = y * this.data.tileheight;\n                spriteClone.gotoAndStop(picture);\n\n                if (layer.properties && layer.properties.blocked) {\n                  this.blockedMap[y][x] = spriteClone;\n                }\n\n                this.container.addChild(spriteClone);\n              }\n            }\n          }\n        } else { // 渲染对象层\n\n        }\n\n      });\n\n      this.width = this.data.width * this.data.tilewidth;\n      this.height = this.data.height * this.data.tileheight;\n\n      // 创建一个cache，地图很大可能会很大，所以以后可能还要想别的办法\n      // 这个cache会让createjs创建一个看不到的canvas\n      this.container.cache(0, 0, this.width, this.height);\n\n      // 开始计算迷你地图\n      var ratio = this.width / this.height;\n      var maxMinimapWidth = 940;\n      var maxMinimapHeight = 440;\n      var minimapWidth = 940;\n      var minimapHeight = 940 / ratio;\n      if (minimapHeight > maxMinimapHeight) {\n        minimapHeight = 440;\n        minimapWidth = 440 * ratio;\n      }\n      var minimapCanvas = document.createElement(\"canvas\");\n      minimapCanvas.width = minimapWidth;\n      minimapCanvas.height = minimapHeight;\n      var minimapContext = minimapCanvas.getContext(\"2d\");\n      minimapContext.drawImage(this.container.cacheCanvas, 0, 0,\n        this.width, this.height, 0, 0, minimapWidth, minimapHeight);\n\n      var minimap = new Image();\n      minimap.onload = function () {\n        this.minimap = new createjs.Bitmap(minimap);\n        this.minimap.regX = parseInt(minimap.width / 2);\n        this.minimap.regY = parseInt(minimap.height / 2);\n      };\n      minimap.src = minimapCanvas.toDataURL();\n\n      // 开始计算地图平均颜色（用迷你地图的平均颜色，用来作为document.body的背景）\n      var rgb = { r: 0, g: 0, b: 0 };\n      var minimapData = minimapContext.getImageData(0, 0, minimap.width, minimap.height).data;\n\n      for (var i = 0; i < minimapData.length; i += 4) {\n        rgb.r += minimapData[i];\n        rgb.g += minimapData[i + 1];\n        rgb.b += minimapData[i + 2];\n      }\n\n      // 把颜色取平均值然后转换为16进制，最后到css格式\n      rgb.r = Math.floor(rgb.r / (minimapData.length / 4)).toString(16);\n      rgb.g = Math.floor(rgb.g / (minimapData.length / 4)).toString(16);\n      rgb.b = Math.floor(rgb.b / (minimapData.length / 4)).toString(16);\n      this.averageColor = \"#\" + rgb.r + rgb.g + rgb.b;\n\n      // 发送完成事件，第二个参数代表一次性事件\n      this.emit(\"complete\", true);\n    }\n\n    // 返回某个坐标点所在的地格\n    tile (x, y) {\n      x = x / this.data.tilewidth;\n      y = y / this.data.tileheight;\n      return {\n        x: Math.floor(x),\n        y: Math.floor(y)\n      };\n    }\n\n    // 绘制图片，会改变Game.currentArea\n    draw (layer) {\n      layer.addChild(this.container);\n\n      if (this.averageColor) {\n        document.body.style.backgroundColor = this.averageColor;\n      }\n\n      if (this.data.bgm) {\n        // set loop = -1, 无限循环\n        //var bgm = createjs.Sound.play(this.data.bgm, undefined, undefined, undefined, -1);\n        //bgm.setVolume(0.2);\n      }\n    }\n  };\n\n})();\n"]}