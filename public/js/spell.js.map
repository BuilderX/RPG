{"version":3,"sources":["public/src/spell.js"],"names":[],"mappings":"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","file":"public/src/spell.js","sourcesContent":["/*\n\nA-RPG Game, Built using Node.js + JavaScript + ES6\nCopyright (C) 2015 qhduan(http://qhduan.com)\n\nThis program is free software: you can redistribute it and/or modify\nit under the terms of the GNU General Public License as published by\nthe Free Software Foundation, either version 3 of the License, or\n(at your option) any later version.\n\nThis program is distributed in the hope that it will be useful,\nbut WITHOUT ANY WARRANTY; without even the implied warranty of\nMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\nGNU General Public License for more details.\n\nYou should have received a copy of the GNU General Public License\nalong with this program.  If not, see <http://www.gnu.org/licenses/>.\n\n*/\n(function () {\n  \"use strict\";\n\n  Game.SpellClass = class SpellClass extends Sprite.Event {\n    constructor (spellData) {\n      super ();\n\n      this.data = spellData;\n      this.id = this.data.id;\n\n      var image = Game.resources[this.data.image];\n      var icon = Game.resources[this.data.icon];\n\n      this.icon = new Sprite.Bitmap(icon);\n      this.icon.center.x = icon.width / 2;\n      this.icon.center.y = icon.height / 2;\n\n      var sheet = new Sprite.Sheet({\n        images: [image],\n        width: this.data.tilewidth,\n        height: this.data.tileheight,\n        animations: this.data.animations\n      });\n\n      sheet.center.x = parseInt(this.data.tilewidth / 2);\n      sheet.center.y = parseInt(this.data.tileheight / 2);\n\n      this.sprite = sheet;\n\n      // 发送完成事件，第二个参数代表一次性事件\n      this.emit(\"complete\", true);\n    }\n\n\n\n    fire (actor, animation, callback) {\n      if (Game.resources[this.data.sound]) {\n        Game.resources[this.data.sound].load();\n        Game.resources[this.data.sound].play();\n      }\n\n      var sprite = this.sprite.clone();\n\n      // 矫正武器效果位置\n      //sprite.x = parseInt(actor.sprite.x - parseInt(this.data.tilewidth / 2));\n      //sprite.y = parseInt(actor.sprite.y - parseInt(this.data.tileheight / 2));\n      sprite.x = parseInt(actor.x);\n      sprite.y = parseInt(actor.y);\n\n      if (this.data.animations[animation].x) {\n        sprite.x += this.data.animations[animation].x;\n      }\n\n      if (this.data.animations[animation].y) {\n        sprite.y += this.data.animations[animation].y;\n      }\n\n      // 被命中的actor列表\n      var hitted= {};\n      var CheckHit = () => {\n\n        // 碰撞检测\n        for (var key in Game.area.actors) {\n          if (Game.area.actors[key].id == actor.id) continue;\n          if (Game.area.actors[key].data.type != \"monster\") continue;\n          var c = Game.spellCollision(sprite, Game.area.actors[key].sprite);\n          if (c) {\n            hitted[key] = true;\n          }\n        }\n      };\n\n      // 如果是远距离攻击（this.data.distance > 0），那么distance是它已经走过的举例\n      var distance = 0;\n\n      var listener = Sprite.Ticker.on(\"tick\", () => {\n\n        distance += this.data.flyspeed;\n\n        switch (animation) {\n          case \"attackdown\":\n            sprite.y += distance;\n            break;\n          case \"attackleft\":\n            sprite.x -= distance;\n            break;\n          case \"attackright\":\n            sprite.x += distance;\n            break;\n          case \"attackup\":\n            sprite.y -= distance;\n            break;\n        }\n\n        CheckHit();\n\n        Game.update();\n\n        // 如果击中了一个敌人（单体伤害）\n        if (Object.keys(hitted).length > 0) {\n          Finish();\n        }\n\n        // 如果是远程攻击，并且攻击距离已经到了\n        if (this.data.distance > 0 && distance >= this.data.distance) {\n          Finish();\n        }\n\n        // 如果是近战攻击（this.data.distance <= 0），而且动画已经停止\n        if (this.data.distance <= 0 && sprite.paused) {\n          Finish();\n        }\n\n      });\n\n      // 攻击结束时运行Stop函数\n      var Finish = () => {\n        Sprite.Ticker.off(\"tick\", listener);\n\n        if (Object.keys(hitted).length > 0 && this.data.animations[\"hitted\"]) {\n          var a = Object.keys(hitted)[0];\n          a = Game.area.actors[a];\n          sprite.x = a.sprite.x;\n          sprite.y = a.sprite.y;\n          console.log(a.sprite.x, a.sprite.y)\n          sprite.gotoAndPlay(\"hitted\");\n          sprite.on(\"animationend\", function () {\n            Game.spellLayer.removeChild(sprite);\n          })\n        } else {\n          // 如果动画已经播完，则停止\n          if (sprite.paused == true) {\n            Game.spellLayer.removeChild(sprite);\n          } else {\n            sprite.on(\"animationend\", function () {\n              Game.spellLayer.removeChild(sprite);\n            });\n          }\n        }\n\n\n        Game.update();\n        if (callback) callback(Object.keys(hitted));\n      }\n\n      Game.spellLayer.appendChild(sprite);\n      sprite.play(animation);\n\n      if ( this.data.animations[animation].actor\n        && actor.data.animations[this.data.animations[animation].actor] ) {\n        actor.play(this.data.animations[animation].actor, 3);\n      }\n    }\n\n  };\n\n})();\n"]}