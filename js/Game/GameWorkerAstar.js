/*

A-RPG Game, Built using JavaScript ES6
Copyright (C) 2015 qhduan(http://qhduan.com)

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.

*/

"use strict";

var lastMap = null;

self.addEventListener("message", function (event) {
  var data = event.data;
  var id = data.id;
  var blockedMap = data.blockedMap;
  var blocked = data.blocked;
  var width = data.width;
  var height = data.height;
  var start = data.start;
  var end = data.end;

  if (blockedMap) {
    lastMap = blockedMap;
  }

  var result = path(function (x, y) {
    if (lastMap[x * 10000 + y]) {
      // 有阻挡，返回true
      return true;
    }
    if (blocked[x * 10000 + y]) {
      return true;
    }
    return false;
  }, width, height, start, end);

  // console.log(id, data, blockedMap, block, width, height, start, end, result);

  self.postMessage({
    id: id,
    path: result
  });
});

function path(collisionFunction, width, height, start, end) {
  // 用一个点结构的x和y值返回一个字符串的key
  // 例如{x: 9, y: 8}返回"9-8"
  var tag = function tag(point) {
    return point.x.toString() + "-" + point.y.toString();
  };
  // 计算点结构a和b之间的曼哈顿距离，即不带斜走的直线距离
  var manhattan = function manhattan(a, b) {
    return Math.abs(a.x - b.x) + Math.abs(a.y - b.y);
  };
  // 粗略验证一个点是否可用，是否超出边界，地图上是否是墙
  var valid = function valid(x, y) {
    if (collisionFunction(x, y)) return false;
    return true;
  };
  // 通过坐标x，y，当前最好的节点best和一个附加值（直线10，斜线14），返回一个新节点
  var make = function make(x, y, best, addition, direction) {
    var t = {
      x: x,
      y: y,
      g: best.g + addition
    };
    t.key = tag(t);
    t.h = manhattan(t, end);
    t.f = t.g + t.h;
    t.front = best.front.slice();
    t.front.push(best.key);
    return t;
  };

  // 开启列表和关闭列表
  var open = {};
  var close = {};

  //构建起始节点
  open[tag(start)] = {
    x: start.x,
    y: start.y,
    key: tag(start),
    f: 0,
    g: 0,
    h: manhattan(start, end),
    front: []
  };

  while (Object.keys(open).length) {
    // 找到F值最小的节点
    var best = null;
    for (var key in open) {
      if (best == null || open[key].f < best.f) {
        best = open[key];
      }
    }
    // 从开启列表中删除，加入关闭列表
    delete open[best.key];
    close[best.key] = best;

    // 如果这个最好的节点就是结尾节点，则返回
    if (best.x == end.x && best.y == end.y) {
      best.front.push(tag(end));
      var result = [];
      for (var i = 0, len = best.front.length; i < len; i++) {
        var m = best.front[i].match(/(\d+)-(\d+)/);
        if (m) {
          result.push({
            x: parseInt(m[1]),
            y: parseInt(m[2])
          });
        }
      }
      return result;
    }

    // 记录上下左右，和四个斜方向的可能值
    var possible = [];

    if (valid(best.x, best.y - 1)) {
      // 验证up
      possible.push(make(best.x, best.y - 1, best, 10));
    }
    if (valid(best.x, best.y + 1)) {
      // 验证down
      possible.push(make(best.x, best.y + 1, best, 10));
    }
    if (valid(best.x - 1, best.y)) {
      // 验证left
      possible.push(make(best.x - 1, best.y, best, 10));
    }
    if (valid(best.x + 1, best.y)) {
      // 验证right
      possible.push(make(best.x + 1, best.y, best, 10));
    }

    // 去除已经在开启列表和关闭列表中的
    possible.forEach(function (element) {
      var t = tag(element);
      if (open[t]) return;
      if (close[t]) return;
      open[t] = element;
    });
  } // while

  return null;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9HYW1lL0dhbWVXb3JrZXJBc3Rhci5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBcUJBLElBQUksT0FBTyxHQUFHLElBQUksQ0FBQzs7QUFFbkIsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFNBQVMsRUFBRSxVQUFTLEtBQUssRUFBRTtBQUMvQyxNQUFJLElBQUksR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDO0FBQ3RCLE1BQUksRUFBRSxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUM7QUFDakIsTUFBSSxVQUFVLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQztBQUNqQyxNQUFJLE9BQU8sR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDO0FBQzNCLE1BQUksS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7QUFDdkIsTUFBSSxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQztBQUN6QixNQUFJLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO0FBQ3ZCLE1BQUksR0FBRyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUM7O0FBRW5CLE1BQUksVUFBVSxFQUFFO0FBQ2QsV0FBTyxHQUFHLFVBQVUsQ0FBQztHQUN0Qjs7QUFFRCxNQUFJLE1BQU0sR0FBRyxJQUFJLENBQUUsVUFBVSxDQUFDLEVBQUUsQ0FBQyxFQUFFO0FBQ2pDLFFBQUksT0FBTyxDQUFDLENBQUMsR0FBQyxLQUFLLEdBQUMsQ0FBQyxDQUFDLEVBQUU7O0FBRXRCLGFBQU8sSUFBSSxDQUFDO0tBQ2I7QUFDRCxRQUFJLE9BQU8sQ0FBQyxDQUFDLEdBQUMsS0FBSyxHQUFDLENBQUMsQ0FBQyxFQUFFO0FBQ3RCLGFBQU8sSUFBSSxDQUFDO0tBQ2I7QUFDRCxXQUFPLEtBQUssQ0FBQztHQUNkLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsR0FBRyxDQUFDLENBQUM7Ozs7QUFJOUIsTUFBSSxDQUFDLFdBQVcsQ0FBQztBQUNmLE1BQUUsRUFBRSxFQUFFO0FBQ04sUUFBSSxFQUFFLE1BQU07R0FDYixDQUFDLENBQUM7Q0FFSixDQUFDLENBQUM7O0FBRUgsU0FBUyxJQUFJLENBQUUsaUJBQWlCLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFOzs7QUFHM0QsTUFBSSxHQUFHLEdBQUcsU0FBTixHQUFHLENBQWEsS0FBSyxFQUFFO0FBQ3pCLFdBQU8sS0FBSyxDQUFDLENBQUMsQ0FBQyxRQUFRLEVBQUUsR0FBRyxHQUFHLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQztHQUN0RCxDQUFDOztBQUVGLE1BQUksU0FBUyxHQUFHLFNBQVosU0FBUyxDQUFhLENBQUMsRUFBRSxDQUFDLEVBQUU7QUFDOUIsV0FBTyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7R0FDbEQsQ0FBQzs7QUFFRixNQUFJLEtBQUssR0FBRyxTQUFSLEtBQUssQ0FBYSxDQUFDLEVBQUUsQ0FBQyxFQUFFO0FBQzFCLFFBQUksaUJBQWlCLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxFQUN6QixPQUFPLEtBQUssQ0FBQztBQUNmLFdBQU8sSUFBSSxDQUFDO0dBQ2IsQ0FBQzs7QUFFRixNQUFJLElBQUksR0FBRyxTQUFQLElBQUksQ0FBYSxDQUFDLEVBQUUsQ0FBQyxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsU0FBUyxFQUFFO0FBQ3BELFFBQUksQ0FBQyxHQUFHO0FBQ04sT0FBQyxFQUFFLENBQUM7QUFDSixPQUFDLEVBQUUsQ0FBQztBQUNKLE9BQUMsRUFBRSxJQUFJLENBQUMsQ0FBQyxHQUFHLFFBQVE7S0FDckIsQ0FBQztBQUNGLEtBQUMsQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ2YsS0FBQyxDQUFDLENBQUMsR0FBRyxTQUFTLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0FBQ3hCLEtBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ2hCLEtBQUMsQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLEVBQUUsQ0FBQztBQUM3QixLQUFDLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDdkIsV0FBTyxDQUFDLENBQUM7R0FDVixDQUFDOzs7QUFHRixNQUFJLElBQUksR0FBRyxFQUFFLENBQUM7QUFDZCxNQUFJLEtBQUssR0FBRyxFQUFFLENBQUM7OztBQUdmLE1BQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsR0FBRztBQUNqQixLQUFDLEVBQUUsS0FBSyxDQUFDLENBQUM7QUFDVixLQUFDLEVBQUUsS0FBSyxDQUFDLENBQUM7QUFDVixPQUFHLEVBQUUsR0FBRyxDQUFDLEtBQUssQ0FBQztBQUNmLEtBQUMsRUFBRSxDQUFDO0FBQ0osS0FBQyxFQUFFLENBQUM7QUFDSixLQUFDLEVBQUUsU0FBUyxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUM7QUFDeEIsU0FBSyxFQUFFLEVBQUU7R0FDVixDQUFDOztBQUVGLFNBQU8sTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFNLEVBQUU7O0FBRS9CLFFBQUksSUFBSSxHQUFHLElBQUksQ0FBQztBQUNoQixTQUFLLElBQUksR0FBRyxJQUFJLElBQUksRUFBRTtBQUNwQixVQUFJLElBQUksSUFBSSxJQUFJLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQyxFQUFFO0FBQ3hDLFlBQUksR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7T0FDbEI7S0FDRjs7QUFFRCxXQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDdEIsU0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxJQUFJLENBQUM7OztBQUd2QixRQUFJLElBQUksQ0FBQyxDQUFDLElBQUksR0FBRyxDQUFDLENBQUMsSUFBSSxJQUFJLENBQUMsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDLEVBQUU7QUFDdEMsVUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7QUFDMUIsVUFBSSxNQUFNLEdBQUcsRUFBRSxDQUFDO0FBQ2hCLFdBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLEdBQUcsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsR0FBRyxFQUFFLENBQUMsRUFBRSxFQUFFO0FBQ3JELFlBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLGFBQWEsQ0FBQyxDQUFDO0FBQzNDLFlBQUksQ0FBQyxFQUFFO0FBQ0wsZ0JBQU0sQ0FBQyxJQUFJLENBQUM7QUFDVixhQUFDLEVBQUUsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUNqQixhQUFDLEVBQUUsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztXQUNsQixDQUFDLENBQUM7U0FDSjtPQUNGO0FBQ0QsYUFBTyxNQUFNLENBQUM7S0FDZjs7O0FBR0QsUUFBSSxRQUFRLEdBQUcsRUFBRSxDQUFDOztBQUVsQixRQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUU7O0FBQzdCLGNBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLEVBQUUsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUM7S0FDbkQ7QUFDRCxRQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUU7O0FBQzdCLGNBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLEVBQUUsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUM7S0FDbkQ7QUFDRCxRQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUU7O0FBQzdCLGNBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLEVBQUUsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUM7S0FDbkQ7QUFDRCxRQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUU7O0FBQzdCLGNBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLEVBQUUsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUM7S0FDbkQ7OztBQUdELFlBQVEsQ0FBQyxPQUFPLENBQUMsVUFBVSxPQUFPLEVBQUU7QUFDbEMsVUFBSSxDQUFDLEdBQUcsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBQ3JCLFVBQUksSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLE9BQU87QUFDcEIsVUFBSSxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUsT0FBTztBQUNyQixVQUFJLENBQUMsQ0FBQyxDQUFDLEdBQUcsT0FBTyxDQUFDO0tBQ25CLENBQUMsQ0FBQztHQUVKOztBQUVELFNBQU8sSUFBSSxDQUFDO0NBQ2IiLCJmaWxlIjoiR2FtZVdvcmtlckFzdGFyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLypcblxuQS1SUEcgR2FtZSwgQnVpbHQgdXNpbmcgSmF2YVNjcmlwdCBFUzZcbkNvcHlyaWdodCAoQykgMjAxNSBxaGR1YW4oaHR0cDovL3FoZHVhbi5jb20pXG5cblRoaXMgcHJvZ3JhbSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IgbW9kaWZ5XG5pdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieVxudGhlIEZyZWUgU29mdHdhcmUgRm91bmRhdGlvbiwgZWl0aGVyIHZlcnNpb24gMyBvZiB0aGUgTGljZW5zZSwgb3JcbihhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uXG5cblRoaXMgcHJvZ3JhbSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLFxuYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2Zcbk1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGVcbkdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuXG5cbllvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlXG5hbG9uZyB3aXRoIHRoaXMgcHJvZ3JhbS4gIElmIG5vdCwgc2VlIDxodHRwOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi5cblxuKi9cblxuXG5sZXQgbGFzdE1hcCA9IG51bGw7XG5cbnNlbGYuYWRkRXZlbnRMaXN0ZW5lcihcIm1lc3NhZ2VcIiwgZnVuY3Rpb24oZXZlbnQpIHtcbiAgbGV0IGRhdGEgPSBldmVudC5kYXRhO1xuICBsZXQgaWQgPSBkYXRhLmlkO1xuICBsZXQgYmxvY2tlZE1hcCA9IGRhdGEuYmxvY2tlZE1hcDtcbiAgbGV0IGJsb2NrZWQgPSBkYXRhLmJsb2NrZWQ7XG4gIGxldCB3aWR0aCA9IGRhdGEud2lkdGg7XG4gIGxldCBoZWlnaHQgPSBkYXRhLmhlaWdodDtcbiAgbGV0IHN0YXJ0ID0gZGF0YS5zdGFydDtcbiAgbGV0IGVuZCA9IGRhdGEuZW5kO1xuXG4gIGlmIChibG9ja2VkTWFwKSB7XG4gICAgbGFzdE1hcCA9IGJsb2NrZWRNYXA7XG4gIH1cblxuICBsZXQgcmVzdWx0ID0gcGF0aCAoZnVuY3Rpb24gKHgsIHkpIHtcbiAgICBpZiAobGFzdE1hcFt4KjEwMDAwK3ldKSB7XG4gICAgICAvLyDmnInpmLvmjKHvvIzov5Tlm550cnVlXG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gICAgaWYgKGJsb2NrZWRbeCoxMDAwMCt5XSkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbiAgfSwgd2lkdGgsIGhlaWdodCwgc3RhcnQsIGVuZCk7XG5cbiAgLy8gY29uc29sZS5sb2coaWQsIGRhdGEsIGJsb2NrZWRNYXAsIGJsb2NrLCB3aWR0aCwgaGVpZ2h0LCBzdGFydCwgZW5kLCByZXN1bHQpO1xuXG4gIHNlbGYucG9zdE1lc3NhZ2Uoe1xuICAgIGlkOiBpZCxcbiAgICBwYXRoOiByZXN1bHRcbiAgfSk7XG5cbn0pO1xuXG5mdW5jdGlvbiBwYXRoIChjb2xsaXNpb25GdW5jdGlvbiwgd2lkdGgsIGhlaWdodCwgc3RhcnQsIGVuZCkge1xuICAvLyDnlKjkuIDkuKrngrnnu5PmnoTnmoR45ZKMeeWAvOi/lOWbnuS4gOS4quWtl+espuS4sueahGtleVxuICAvLyDkvovlpoJ7eDogOSwgeTogOH3ov5Tlm55cIjktOFwiXG4gIGxldCB0YWcgPSBmdW5jdGlvbiAocG9pbnQpIHtcbiAgICByZXR1cm4gcG9pbnQueC50b1N0cmluZygpICsgXCItXCIgKyBwb2ludC55LnRvU3RyaW5nKCk7XG4gIH07XG4gIC8vIOiuoeeul+eCuee7k+aehGHlkoxi5LmL6Ze055qE5pu85ZOI6aG/6Led56a777yM5Y2z5LiN5bim5pac6LWw55qE55u057q/6Led56a7XG4gIGxldCBtYW5oYXR0YW4gPSBmdW5jdGlvbiAoYSwgYikge1xuICAgIHJldHVybiBNYXRoLmFicyhhLnggLSBiLngpICsgTWF0aC5hYnMoYS55IC0gYi55KTtcbiAgfTtcbiAgLy8g57KX55Wl6aqM6K+B5LiA5Liq54K55piv5ZCm5Y+v55So77yM5piv5ZCm6LaF5Ye66L6555WM77yM5Zyw5Zu+5LiK5piv5ZCm5piv5aKZXG4gIGxldCB2YWxpZCA9IGZ1bmN0aW9uICh4LCB5KSB7XG4gICAgaWYgKGNvbGxpc2lvbkZ1bmN0aW9uKHgsIHkpKVxuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIHJldHVybiB0cnVlO1xuICB9O1xuICAvLyDpgJrov4flnZDmoId477yMee+8jOW9k+WJjeacgOWlveeahOiKgueCuWJlc3TlkozkuIDkuKrpmYTliqDlgLzvvIjnm7Tnur8xMO+8jOaWnOe6vzE077yJ77yM6L+U5Zue5LiA5Liq5paw6IqC54K5XG4gIGxldCBtYWtlID0gZnVuY3Rpb24gKHgsIHksIGJlc3QsIGFkZGl0aW9uLCBkaXJlY3Rpb24pIHtcbiAgICBsZXQgdCA9IHtcbiAgICAgIHg6IHgsXG4gICAgICB5OiB5LFxuICAgICAgZzogYmVzdC5nICsgYWRkaXRpb25cbiAgICB9O1xuICAgIHQua2V5ID0gdGFnKHQpO1xuICAgIHQuaCA9IG1hbmhhdHRhbih0LCBlbmQpO1xuICAgIHQuZiA9IHQuZyArIHQuaDtcbiAgICB0LmZyb250ID0gYmVzdC5mcm9udC5zbGljZSgpO1xuICAgIHQuZnJvbnQucHVzaChiZXN0LmtleSk7XG4gICAgcmV0dXJuIHQ7XG4gIH07XG5cbiAgLy8g5byA5ZCv5YiX6KGo5ZKM5YWz6Zet5YiX6KGoXG4gIGxldCBvcGVuID0ge307XG4gIGxldCBjbG9zZSA9IHt9O1xuXG4gIC8v5p6E5bu66LW35aeL6IqC54K5XG4gIG9wZW5bdGFnKHN0YXJ0KV0gPSB7XG4gICAgeDogc3RhcnQueCxcbiAgICB5OiBzdGFydC55LFxuICAgIGtleTogdGFnKHN0YXJ0KSxcbiAgICBmOiAwLFxuICAgIGc6IDAsXG4gICAgaDogbWFuaGF0dGFuKHN0YXJ0LCBlbmQpLFxuICAgIGZyb250OiBbXVxuICB9O1xuXG4gIHdoaWxlIChPYmplY3Qua2V5cyhvcGVuKS5sZW5ndGgpIHtcbiAgICAvLyDmib7liLBG5YC85pyA5bCP55qE6IqC54K5XG4gICAgbGV0IGJlc3QgPSBudWxsO1xuICAgIGZvciAobGV0IGtleSBpbiBvcGVuKSB7XG4gICAgICBpZiAoYmVzdCA9PSBudWxsIHx8IG9wZW5ba2V5XS5mIDwgYmVzdC5mKSB7XG4gICAgICAgIGJlc3QgPSBvcGVuW2tleV07XG4gICAgICB9XG4gICAgfVxuICAgIC8vIOS7juW8gOWQr+WIl+ihqOS4reWIoOmZpO+8jOWKoOWFpeWFs+mXreWIl+ihqFxuICAgIGRlbGV0ZSBvcGVuW2Jlc3Qua2V5XTtcbiAgICBjbG9zZVtiZXN0LmtleV0gPSBiZXN0O1xuXG4gICAgLy8g5aaC5p6c6L+Z5Liq5pyA5aW955qE6IqC54K55bCx5piv57uT5bC+6IqC54K577yM5YiZ6L+U5ZueXG4gICAgaWYgKGJlc3QueCA9PSBlbmQueCAmJiBiZXN0LnkgPT0gZW5kLnkpIHtcbiAgICAgIGJlc3QuZnJvbnQucHVzaCh0YWcoZW5kKSk7XG4gICAgICBsZXQgcmVzdWx0ID0gW107XG4gICAgICBmb3IgKGxldCBpID0gMCwgbGVuID0gYmVzdC5mcm9udC5sZW5ndGg7IGkgPCBsZW47IGkrKykge1xuICAgICAgICBsZXQgbSA9IGJlc3QuZnJvbnRbaV0ubWF0Y2goLyhcXGQrKS0oXFxkKykvKTtcbiAgICAgICAgaWYgKG0pIHtcbiAgICAgICAgICByZXN1bHQucHVzaCh7XG4gICAgICAgICAgICB4OiBwYXJzZUludChtWzFdKSxcbiAgICAgICAgICAgIHk6IHBhcnNlSW50KG1bMl0pXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxuXG4gICAgLy8g6K6w5b2V5LiK5LiL5bem5Y+z77yM5ZKM5Zub5Liq5pac5pa55ZCR55qE5Y+v6IO95YC8XG4gICAgbGV0IHBvc3NpYmxlID0gW107XG5cbiAgICBpZiAodmFsaWQoYmVzdC54LCBiZXN0LnkgLSAxKSkgeyAvLyDpqozor4F1cFxuICAgICAgcG9zc2libGUucHVzaChtYWtlKGJlc3QueCwgYmVzdC55IC0gMSwgYmVzdCwgMTApKTtcbiAgICB9XG4gICAgaWYgKHZhbGlkKGJlc3QueCwgYmVzdC55ICsgMSkpIHsgLy8g6aqM6K+BZG93blxuICAgICAgcG9zc2libGUucHVzaChtYWtlKGJlc3QueCwgYmVzdC55ICsgMSwgYmVzdCwgMTApKTtcbiAgICB9XG4gICAgaWYgKHZhbGlkKGJlc3QueCAtIDEsIGJlc3QueSkpIHsgLy8g6aqM6K+BbGVmdFxuICAgICAgcG9zc2libGUucHVzaChtYWtlKGJlc3QueCAtIDEsIGJlc3QueSwgYmVzdCwgMTApKTtcbiAgICB9XG4gICAgaWYgKHZhbGlkKGJlc3QueCArIDEsIGJlc3QueSkpIHsgLy8g6aqM6K+BcmlnaHRcbiAgICAgIHBvc3NpYmxlLnB1c2gobWFrZShiZXN0LnggKyAxLCBiZXN0LnksIGJlc3QsIDEwKSk7XG4gICAgfVxuXG4gICAgLy8g5Y676Zmk5bey57uP5Zyo5byA5ZCv5YiX6KGo5ZKM5YWz6Zet5YiX6KGo5Lit55qEXG4gICAgcG9zc2libGUuZm9yRWFjaChmdW5jdGlvbiAoZWxlbWVudCkge1xuICAgICAgbGV0IHQgPSB0YWcoZWxlbWVudCk7XG4gICAgICBpZiAob3Blblt0XSkgcmV0dXJuO1xuICAgICAgaWYgKGNsb3NlW3RdKSByZXR1cm47XG4gICAgICBvcGVuW3RdID0gZWxlbWVudDtcbiAgICB9KTtcblxuICB9IC8vIHdoaWxlXG5cbiAgcmV0dXJuIG51bGw7XG59XG4iXX0=
