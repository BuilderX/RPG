/*

A-RPG Game, Built using JavaScript ES6
Copyright (C) 2015 qhduan(http://qhduan.com)

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.

*/

"use strict";

(function () {
  "use strict";

  // 游戏无论什么时候都需要预加载的内容
  function Preload() {
    return new Promise(function (resolve, reject) {
      var promises = new Set();

      var preloadSoundEffects = {
        hurt: "sound/effect/hurt.ogg" // 伤害效果音
      };

      for (var key in preloadSoundEffects) {
        promises.add((function (key, url) {
          return new Promise(function (resolve, reject) {
            if (Game.sounds && Game.sounds[key]) {
              resolve();
            } else {
              Sprite.load(url).then(function (data) {
                Game.sounds[key] = data[0];
                resolve();
              });
            }
          });
        })(key, preloadSoundEffects[key]));
      }

      var preloadItems = ["bag", // 掉落物品用的小包
      "gold" // 金币图标
      ];

      preloadItems.forEach(function (id) {
        promises.add(new Promise(function (resolve, reject) {
          if (Game.items && Game.items[id]) {
            resolve();
          } else {
            Game.Item.load(id).then(function (itemObj) {
              resolve();
            });
          }
        }));
      });

      Promise.all(promises).then(function () {
        resolve();
      });
    });
  }

  // 加载区域，把括地图，角色，物品
  Game.assign("loadArea", function (id) {
    return new Promise(function (resolve, reject) {

      Game.Map.load(id).then(function (mapObj) {

        var area = {
          actors: new Set(), // 角色
          bags: new Set(), // 掉落小包
          items: new Set(), // 其他物品（有碰撞）
          touch: [], // touch或onto会触发的地点/物品
          onto: [], // onto会触发的地点/物品
          map: mapObj
        };

        var promises = new Set();

        promises.add(Preload());

        if (mapObj.data.actors) {
          mapObj.data.actors.forEach(function (element) {
            promises.add(new Promise(function (resolve, reject) {
              Game.Actor.load(element.id).then(function (actorObj) {

                for (var key in element) {
                  actorObj.data[key] = element[key];
                }

                area.actors.add(actorObj);
                actorObj.draw();
                resolve();
              });
            }));
          });
        }

        if (mapObj.spawnMonster && mapObj.spawnMonster.list && mapObj.spawnMonster.count) {
          var _loop = function (monsterId) {
            promises.add(new Promise(function (resolve, reject) {
              Game.Actor.load(monsterId).then(function () {
                resolve();
              });
            }));
          };

          for (var monsterId in mapObj.spawnMonster.list) {
            _loop(monsterId);
          }
        }

        if (mapObj.spawnItem && mapObj.spawnItem.list && mapObj.spawnItem.count) {
          var _loop2 = function (itemId) {
            promises.add(new Promise(function (resolve, reject) {
              Game.Item.load(itemId).then(function () {
                resolve();
              });
            }));
          };

          for (var itemId in mapObj.spawnItem.list) {
            _loop2(itemId);
          }
        }

        if (mapObj.data.onto) {
          mapObj.data.onto.forEach(function (element) {
            area.onto.push(element);
          });
        }

        if (mapObj.data.touch) {
          mapObj.data.touch.forEach(function (element) {
            area.touch.push(element);
          });
        }

        Promise.all(promises).then(function () {
          resolve(area);
        });
      }); //map
    });
  });
})();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9HYW1lL0dhbWVBcmVhLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFxQkEsQ0FBQyxZQUFZO0FBQ1gsY0FBWSxDQUFDOzs7QUFHYixXQUFTLE9BQU8sR0FBSTtBQUNsQixXQUFPLElBQUksT0FBTyxDQUFDLFVBQVUsT0FBTyxFQUFFLE1BQU0sRUFBRTtBQUM1QyxVQUFJLFFBQVEsR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDOztBQUV6QixVQUFJLG1CQUFtQixHQUFHO0FBQ3hCLFlBQUksRUFBRSx1QkFBdUI7T0FDOUIsQ0FBQzs7QUFFRixXQUFLLElBQUksR0FBRyxJQUFJLG1CQUFtQixFQUFFO0FBQ25DLGdCQUFRLENBQUMsR0FBRyxDQUNWLENBQUMsVUFBVSxHQUFHLEVBQUUsR0FBRyxFQUFFO0FBQ25CLGlCQUFPLElBQUksT0FBTyxDQUFDLFVBQVUsT0FBTyxFQUFFLE1BQU0sRUFBRTtBQUM1QyxnQkFBSSxJQUFJLENBQUMsTUFBTSxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEVBQUU7QUFDbkMscUJBQU8sRUFBRSxDQUFDO2FBQ1gsTUFBTTtBQUNMLG9CQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLElBQUksRUFBRTtBQUNwQyxvQkFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDM0IsdUJBQU8sRUFBRSxDQUFDO2VBQ1gsQ0FBQyxDQUFDO2FBQ0o7V0FDRixDQUFDLENBQUM7U0FDSixDQUFBLENBQUUsR0FBRyxFQUFFLG1CQUFtQixDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQ2xDLENBQUM7T0FDSDs7QUFFRCxVQUFJLFlBQVksR0FBRyxDQUNqQixLQUFLO0FBQ0wsWUFBTTtPQUNQLENBQUM7O0FBRUYsa0JBQVksQ0FBQyxPQUFPLENBQUMsVUFBVSxFQUFFLEVB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ZUFyZWEuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuXG5BLVJQRyBHYW1lLCBCdWlsdCB1c2luZyBKYXZhU2NyaXB0IEVTNlxuQ29weXJpZ2h0IChDKSAyMDE1IHFoZHVhbihodHRwOi8vcWhkdWFuLmNvbSlcblxuVGhpcyBwcm9ncmFtIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnlcbml0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5XG50aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uLCBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvclxuKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi5cblxuVGhpcyBwcm9ncmFtIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsXG5idXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZlxuTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiAgU2VlIHRoZVxuR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy5cblxuWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2VcbmFsb25nIHdpdGggdGhpcyBwcm9ncmFtLiAgSWYgbm90LCBzZWUgPGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LlxuXG4qL1xuXG5cbihmdW5jdGlvbiAoKSB7XG4gIFwidXNlIHN0cmljdFwiO1xuXG4gIC8vIOa4uOaIj+aXoOiuuuS7gOS5iOaXtuWAmemDvemcgOimgemihOWKoOi9veeahOWGheWuuVxuICBmdW5jdGlvbiBQcmVsb2FkICgpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgbGV0IHByb21pc2VzID0gbmV3IFNldCgpO1xuXG4gICAgICBsZXQgcHJlbG9hZFNvdW5kRWZmZWN0cyA9IHtcbiAgICAgICAgaHVydDogXCJzb3VuZC9lZmZlY3QvaHVydC5vZ2dcIiAvLyDkvKTlrrPmlYjmnpzpn7NcbiAgICAgIH07XG5cbiAgICAgIGZvciAobGV0IGtleSBpbiBwcmVsb2FkU291bmRFZmZlY3RzKSB7XG4gICAgICAgIHByb21pc2VzLmFkZChcbiAgICAgICAgICAoZnVuY3Rpb24gKGtleSwgdXJsKSB7XG4gICAgICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICAgICAgICBpZiAoR2FtZS5zb3VuZHMgJiYgR2FtZS5zb3VuZHNba2V5XSkge1xuICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBTcHJpdGUubG9hZCh1cmwpLnRoZW4oZnVuY3Rpb24gKGRhdGEpIHtcbiAgICAgICAgICAgICAgICAgIEdhbWUuc291bmRzW2tleV0gPSBkYXRhWzBdO1xuICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9KShrZXksIHByZWxvYWRTb3VuZEVmZmVjdHNba2V5XSlcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgbGV0IHByZWxvYWRJdGVtcyA9IFtcbiAgICAgICAgXCJiYWdcIiwgLy8g5o6J6JC954mp5ZOB55So55qE5bCP5YyFXG4gICAgICAgIFwiZ29sZFwiIC8vIOmHkeW4geWbvuagh1xuICAgICAgXTtcblxuICAgICAgcHJlbG9hZEl0ZW1zLmZvckVhY2goZnVuY3Rpb24gKGlkKSB7XG4gICAgICAgIHByb21pc2VzLmFkZChcbiAgICAgICAgICBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgICAgICBpZiAoR2FtZS5pdGVtcyAmJiBHYW1lLml0ZW1zW2lkXSkge1xuICAgICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICBHYW1lLkl0ZW0ubG9hZChpZCkudGhlbihmdW5jdGlvbiAoaXRlbU9iaikge1xuICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSlcbiAgICAgICAgKTtcbiAgICAgIH0pO1xuXG4gICAgICBQcm9taXNlLmFsbChwcm9taXNlcykudGhlbihmdW5jdGlvbiAoKSB7XG4gICAgICAgIHJlc29sdmUoKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgLy8g5Yqg6L295Yy65Z+f77yM5oqK5ous5Zyw5Zu+77yM6KeS6Imy77yM54mp5ZOBXG4gIEdhbWUuYXNzaWduKFwibG9hZEFyZWFcIiwgZnVuY3Rpb24gKGlkKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcblxuICAgICAgR2FtZS5NYXAubG9hZChpZCkudGhlbihmdW5jdGlvbiAobWFwT2JqKSB7XG5cbiAgICAgICAgbGV0IGFyZWEgPSB7XG4gICAgICAgICAgYWN0b3JzOiBuZXcgU2V0KCksIC8vIOinkuiJslxuICAgICAgICAgIGJhZ3M6IG5ldyBTZXQoKSwgLy8g5o6J6JC95bCP5YyFXG4gICAgICAgICAgaXRlbXM6IG5ldyBTZXQoKSwgLy8g5YW25LuW54mp5ZOB77yI5pyJ56Kw5pKe77yJXG4gICAgICAgICAgdG91Y2g6IFtdLCAvLyB0b3VjaOaIlm9udG/kvJrop6blj5HnmoTlnLDngrkv54mp5ZOBXG4gICAgICAgICAgb250bzogW10sIC8vIG9udG/kvJrop6blj5HnmoTlnLDngrkv54mp5ZOBXG4gICAgICAgICAgbWFwOiBtYXBPYmpcbiAgICAgICAgfTtcblxuICAgICAgICBsZXQgcHJvbWlzZXMgPSBuZXcgU2V0KCk7XG5cbiAgICAgICAgcHJvbWlzZXMuYWRkKFByZWxvYWQoKSk7XG5cbiAgICAgICAgaWYgKG1hcE9iai5kYXRhLmFjdG9ycykge1xuICAgICAgICAgIG1hcE9iai5kYXRhLmFjdG9ycy5mb3JFYWNoKGZ1bmN0aW9uIChlbGVtZW50KSB7XG4gICAgICAgICAgICBwcm9taXNlcy5hZGQoXG4gICAgICAgICAgICAgIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgICAgICAgICBHYW1lLkFjdG9yLmxvYWQoZWxlbWVudC5pZCkudGhlbihmdW5jdGlvbiAoYWN0b3JPYmopIHtcblxuICAgICAgICAgICAgICAgICAgZm9yIChsZXQga2V5IGluIGVsZW1lbnQpIHtcbiAgICAgICAgICAgICAgICAgICAgYWN0b3JPYmouZGF0YVtrZXldID0gZWxlbWVudFtrZXldO1xuICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICBhcmVhLmFjdG9ycy5hZGQoYWN0b3JPYmopO1xuICAgICAgICAgICAgICAgICAgYWN0b3JPYmouZHJhdygpO1xuICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChcbiAgICAgICAgICBtYXBPYmouc3Bhd25Nb25zdGVyICYmXG4gICAgICAgICAgbWFwT2JqLnNwYXduTW9uc3Rlci5saXN0ICYmXG4gICAgICAgICAgbWFwT2JqLnNwYXduTW9uc3Rlci5jb3VudFxuICAgICAgICApIHtcbiAgICAgICAgICBmb3IgKGxldCBtb25zdGVySWQgaW4gbWFwT2JqLnNwYXduTW9uc3Rlci5saXN0KSB7XG4gICAgICAgICAgICBwcm9taXNlcy5hZGQoXG4gICAgICAgICAgICAgIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgICAgICAgICBHYW1lLkFjdG9yLmxvYWQobW9uc3RlcklkKS50aGVuKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKFxuICAgICAgICAgIG1hcE9iai5zcGF3bkl0ZW0gJiZcbiAgICAgICAgICBtYXBPYmouc3Bhd25JdGVtLmxpc3QgJiZcbiAgICAgICAgICBtYXBPYmouc3Bhd25JdGVtLmNvdW50XG4gICAgICAgICkge1xuICAgICAgICAgIGZvciAobGV0IGl0ZW1JZCBpbiBtYXBPYmouc3Bhd25JdGVtLmxpc3QpIHtcbiAgICAgICAgICAgIHByb21pc2VzLmFkZChcbiAgICAgICAgICAgICAgbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICAgICAgICAgIEdhbWUuSXRlbS5sb2FkKGl0ZW1JZCkudGhlbihmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChtYXBPYmouZGF0YS5vbnRvKSB7XG4gICAgICAgICAgbWFwT2JqLmRhdGEub250by5mb3JFYWNoKGZ1bmN0aW9uIChlbGVtZW50KSB7XG4gICAgICAgICAgICBhcmVhLm9udG8ucHVzaChlbGVtZW50KTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChtYXBPYmouZGF0YS50b3VjaCkge1xuICAgICAgICAgIG1hcE9iai5kYXRhLnRvdWNoLmZvckVhY2goZnVuY3Rpb24gKGVsZW1lbnQpIHtcbiAgICAgICAgICAgIGFyZWEudG91Y2gucHVzaChlbGVtZW50KTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIFByb21pc2UuYWxsKHByb21pc2VzKS50aGVuKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICByZXNvbHZlKGFyZWEpO1xuICAgICAgICB9KTtcblxuICAgICAgfSk7IC8vbWFwXG5cbiAgICB9KTtcbiAgfSk7XG5cbn0pKCk7XG4iXX0=
