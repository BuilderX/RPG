/*

A-RPG Game, Built using JavaScript ES6
Copyright (C) 2015 qhduan(http://qhduan.com)

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.

*/

"use strict";

(function () {
  "use strict";

  var win = Game.windows.pickup = Game.Window.create("pickupWindow");

  win.html = "\n    <div class=\"window-box\">\n      <button id=\"pickupWindowClose\" class=\"brownButton\">关闭</button>\n      <button id=\"pickupWindowAll\" class=\"brownButton\">A 全部</button>\n      <table border=\"0\">\n        <thead>\n          <tr>\n            <td style=\"width: 40px;\"></td>\n            <td style=\"width: 120px;\"></td>\n            <td style=\"width: 30px;\"></td>\n            <td style=\"width: 30px;\"></td>\n            <td></td>\n            <td style=\"width: 60px;\"></td>\n          </tr>\n        </thead>\n        <tbody id=\"pickupWindowTable\"></tbody>\n      </table>\n    </div>\n  ";

  win.css = "\n\n    #pickupWindowTable tr:nth-child(odd) {\n      background-color: rgba(192, 192, 192, 0.6);\n    }\n\n    .pickupWindow table {\n      width: 100%;\n    }\n\n    .pickupWindow button {\n      width: 60px;\n      height: 40px;\n      font-size: 16;\n    }\n\n    #pickupWindowClose {\n\n    }\n\n    #pickupWindowAll {\n\n    }\n  ";

  var pickupWindowClose = win.querySelector("button#pickupWindowClose");
  var pickupWindowAll = win.querySelector("button#pickupWindowAll");
  var pickupWindowTable = win.querySelector("#pickupWindowTable");

  var currentItemObj = null;
  var lastSelect = -1;

  pickupWindowClose.addEventListener("click", function (event) {
    Game.windows.pickup.hide();
  });

  pickupWindowAll.addEventListener("click", function (event) {
    var itemObj = currentItemObj;
    if (itemObj && itemObj.inner && Object.keys(itemObj.inner).length > 0) {
      Sprite.each(itemObj.inner, function (itemCount, itemId, inner) {
        if (itemId == "gold") {
          Game.hero.data.gold += itemCount;
        } else {
          if (Game.hero.data.items[itemId]) {
            Game.hero.data.items[itemId] += itemCount;
          } else {
            Game.hero.data.items[itemId] = itemCount;
          }
        }
        delete inner[itemId];
      });
      Game.windows.pickup.open(itemObj);
    }
  });

  win.whenUp(["a", "A"], function (key) {
    pickupWindowAll.click();
  });

  win.whenUp(["esc"], function (key) {
    setTimeout(function () {
      win.hide();
    }, 20);
  });

  win.whenUp(["1", "2", "3", "4", "5", "6", "7", "8", "9"], function (key) {
    var buttons = pickupWindowTable.querySelectorAll("button");
    for (var i = 0, len = buttons.length; i < len; i++) {
      var buttonIndex = buttons[i].getAttribute("data-index");
      if (buttonIndex) {
        if (buttonIndex == key) {
          buttons[i].click();
        }
      }
    }
  });

  win.assign("open", function (itemObj, select) {
    if (typeof select == "undefined") {
      select = -1;
    }

    lastSelect = select;

    if (!itemObj.inner || Object.keys(itemObj.inner).length <= 0) {

      if (Game.area.bags.has(itemObj)) {
        itemObj.erase();
        Game.area.bags["delete"](itemObj);
      }

      if (Game.area.items.has(itemObj)) {
        itemObj.erase();
        Game.area.items["delete"](itemObj);
      }

      Game.windows.pickup.hide();
      return;
    }

    currentItemObj = itemObj;

    var index = 1;
    var table = "";
    Sprite.each(itemObj.inner, function (itemCount, itemId, inner) {
      var item = Game.items[itemId];

      var line = "";

      if (select == index - 1) {
        line += "<tr style=\"background-color: green;\">\n";
      } else {
        line += "<tr>\n";
      }

      if (item.icon) {
        line += "  <td style=\"text-align: center;\"><img alt=\"\" src=\"" + item.icon.src + "\"></td>\n";
      } else {
        line += "  <td> </td>\n";
      }
      line += "  <td>" + item.data.name + "</td>\n";
      line += "  <td style=\"text-align: center;\">" + item.data.value + "G</td>\n";
      line += "  <td style=\"text-align: center;\">" + itemCount + "</td>\n";
      line += "  <td>" + item.data.description + "</td>\n";
      line += "  <td><button data-id=\"" + itemId + "\" data-index=\"" + index + "\" class=\"brownButton\">" + (index <= 9 ? index : "") + " 拿取</button></td>\n";

      line += "</tr>\n";
      table += line;
      index++;
    });

    pickupWindowTable.innerHTML = table;
    Game.windows.pickup.show();
  });

  win.whenUp(["enter"], function () {
    var buttons = pickupWindowTable.querySelectorAll("button");
    if (lastSelect >= 0 && lastSelect < buttons.length) {
      buttons[lastSelect].click();
    }
  });

  win.whenUp(["up", "down"], function (key) {
    var count = pickupWindowTable.querySelectorAll("button").length;

    if (lastSelect == -1) {
      if (key == "down") {
        win.open(currentItemObj, 0);
      } else if (key == "up") {
        win.open(currentItemObj, count - 1);
      }
    } else {
      if (key == "down") {
        var select = lastSelect + 1;
        if (select >= count) {
          select = 0;
        }
        win.open(currentItemObj, select);
      } else if (key == "up") {
        var select = lastSelect - 1;
        if (select < 0) {
          select = count - 1;
        }
        win.open(currentItemObj, select);
      }
    }
  });

  pickupWindowTable.addEventListener("click", function (event) {
    var itemId = event.target.getAttribute("data-id");
    if (itemId && currentItemObj.inner && currentItemObj.inner.hasOwnProperty(itemId)) {
      var itemCount = currentItemObj.inner[itemId];
      if (itemId == "gold") {
        Game.hero.data.gold += itemCount;
      } else {
        if (Game.hero.data.items.hasOwnProperty(itemId)) {
          Game.hero.data.items[itemId] += itemCount;
        } else {
          Game.hero.data.items[itemId] = itemCount;
        }
      }
      delete currentItemObj.inner[itemId];
      win.open(currentItemObj);
    }
  });
})();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy9HYW1lL0dhbWVXaW5kb3dQaWNrdXAuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQW9CQSxDQUFDLFlBQVk7QUFDWCxjQUFZLENBQUM7O0FBRWIsTUFBSSxHQUFHLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsY0FBYyxDQUFDLENBQUM7O0FBRW5FLEtBQUcsQ0FBQyxJQUFJLHltQkFrQlAsQ0FBQzs7QUFFRixLQUFHLENBQUMsR0FBRyxxVkF1Qk4sQ0FBQzs7QUFFRixNQUFJLGlCQUFpQixHQUFHLEdBQUcsQ0FBQyxhQUFhLENBQUMsMEJBQTBCLENBQUMsQ0FBQztBQUN0RSxNQUFJLGVBQWUsR0FBRyxHQUFHLENBQUMsYUFBYSxDQUFDLHdCQUF3QixDQUFDLENBQUM7QUFDbEUsTUFBSSxpQkFBaUIsR0FBRyxHQUFHLENBQUMsYUFBYSxDQUFDLG9CQUFvQixDQUFDLENBQUM7O0FBRWhFLE1BQUksY0FBYyxHQUFHLElBQUksQ0FBQztBQUMxQixNQUFJLFVBQVUsR0FBRyxDQUFDLENBQUMsQ0FBQzs7QUFFcEIsbUJBQWlCLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxFQUFFLFVBQVUsS0FBSyxFQUFFO0FBQzNELFFBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxDQUFDO0dBQzVCLENBQUMsQ0FBQzs7QUFFSCxpQkFBZSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sRUFBRSxVQUFVLEtBQUssRUFBRTtBQUN6RCxRQUFJLE9BQU8sR0FBRyxjQUFjLENBQUM7QUFDN0IsUUFBSSxPQUFPLElBQUksT0FBTyxDQUFDLEtBQUssSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO0FBQ3JFLFlBQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssRUFB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Q0QsYUFBTyxjQUFjLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQ3BDLFNBQUcsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUM7S0FDMUI7R0FDRixDQUFDLENBQUM7Q0FFSixDQUFBLEVBQUcsQ0FBQyIsImZpbGUiOiJzcmMvR2FtZS9HYW1lV2luZG93UGlja3VwLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLypcblxuQS1SUEcgR2FtZSwgQnVpbHQgdXNpbmcgSmF2YVNjcmlwdCBFUzZcbkNvcHlyaWdodCAoQykgMjAxNSBxaGR1YW4oaHR0cDovL3FoZHVhbi5jb20pXG5cblRoaXMgcHJvZ3JhbSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IgbW9kaWZ5XG5pdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieVxudGhlIEZyZWUgU29mdHdhcmUgRm91bmRhdGlvbiwgZWl0aGVyIHZlcnNpb24gMyBvZiB0aGUgTGljZW5zZSwgb3JcbihhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uXG5cblRoaXMgcHJvZ3JhbSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLFxuYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2Zcbk1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGVcbkdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuXG5cbllvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlXG5hbG9uZyB3aXRoIHRoaXMgcHJvZ3JhbS4gIElmIG5vdCwgc2VlIDxodHRwOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi5cblxuKi9cblxuKGZ1bmN0aW9uICgpIHtcbiAgXCJ1c2Ugc3RyaWN0XCI7XG5cbiAgbGV0IHdpbiA9IEdhbWUud2luZG93cy5waWNrdXAgPSBHYW1lLldpbmRvdy5jcmVhdGUoXCJwaWNrdXBXaW5kb3dcIik7XG5cbiAgd2luLmh0bWwgPSBgXG4gICAgPGRpdiBjbGFzcz1cIndpbmRvdy1ib3hcIj5cbiAgICAgIDxidXR0b24gaWQ9XCJwaWNrdXBXaW5kb3dDbG9zZVwiIGNsYXNzPVwiYnJvd25CdXR0b25cIj7lhbPpl608L2J1dHRvbj5cbiAgICAgIDxidXR0b24gaWQ9XCJwaWNrdXBXaW5kb3dBbGxcIiBjbGFzcz1cImJyb3duQnV0dG9uXCI+QSDlhajpg6g8L2J1dHRvbj5cbiAgICAgIDx0YWJsZSBib3JkZXI9XCIwXCI+XG4gICAgICAgIDx0aGVhZD5cbiAgICAgICAgICA8dHI+XG4gICAgICAgICAgICA8dGQgc3R5bGU9XCJ3aWR0aDogNDBweDtcIj48L3RkPlxuICAgICAgICAgICAgPHRkIHN0eWxlPVwid2lkdGg6IDEyMHB4O1wiPjwvdGQ+XG4gICAgICAgICAgICA8dGQgc3R5bGU9XCJ3aWR0aDogMzBweDtcIj48L3RkPlxuICAgICAgICAgICAgPHRkIHN0eWxlPVwid2lkdGg6IDMwcHg7XCI+PC90ZD5cbiAgICAgICAgICAgIDx0ZD48L3RkPlxuICAgICAgICAgICAgPHRkIHN0eWxlPVwid2lkdGg6IDYwcHg7XCI+PC90ZD5cbiAgICAgICAgICA8L3RyPlxuICAgICAgICA8L3RoZWFkPlxuICAgICAgICA8dGJvZHkgaWQ9XCJwaWNrdXBXaW5kb3dUYWJsZVwiPjwvdGJvZHk+XG4gICAgICA8L3RhYmxlPlxuICAgIDwvZGl2PlxuICBgO1xuXG4gIHdpbi5jc3MgPSBgXG5cbiAgICAjcGlja3VwV2luZG93VGFibGUgdHI6bnRoLWNoaWxkKG9kZCkge1xuICAgICAgYmFja2dyb3VuZC1jb2xvcjogcmdiYSgxOTIsIDE5MiwgMTkyLCAwLjYpO1xuICAgIH1cblxuICAgIC5waWNrdXBXaW5kb3cgdGFibGUge1xuICAgICAgd2lkdGg6IDEwMCU7XG4gICAgfVxuXG4gICAgLnBpY2t1cFdpbmRvdyBidXR0b24ge1xuICAgICAgd2lkdGg6IDYwcHg7XG4gICAgICBoZWlnaHQ6IDQwcHg7XG4gICAgICBmb250LXNpemU6IDE2O1xuICAgIH1cblxuICAgICNwaWNrdXBXaW5kb3dDbG9zZSB7XG5cbiAgICB9XG5cbiAgICAjcGlja3VwV2luZG93QWxsIHtcblxuICAgIH1cbiAgYDtcblxuICBsZXQgcGlja3VwV2luZG93Q2xvc2UgPSB3aW4ucXVlcnlTZWxlY3RvcihcImJ1dHRvbiNwaWNrdXBXaW5kb3dDbG9zZVwiKTtcbiAgbGV0IHBpY2t1cFdpbmRvd0FsbCA9IHdpbi5xdWVyeVNlbGVjdG9yKFwiYnV0dG9uI3BpY2t1cFdpbmRvd0FsbFwiKTtcbiAgbGV0IHBpY2t1cFdpbmRvd1RhYmxlID0gd2luLnF1ZXJ5U2VsZWN0b3IoXCIjcGlja3VwV2luZG93VGFibGVcIik7XG5cbiAgbGV0IGN1cnJlbnRJdGVtT2JqID0gbnVsbDtcbiAgbGV0IGxhc3RTZWxlY3QgPSAtMTtcblxuICBwaWNrdXBXaW5kb3dDbG9zZS5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgZnVuY3Rpb24gKGV2ZW50KSB7XG4gICAgR2FtZS53aW5kb3dzLnBpY2t1cC5oaWRlKCk7XG4gIH0pO1xuXG4gIHBpY2t1cFdpbmRvd0FsbC5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgZnVuY3Rpb24gKGV2ZW50KSB7XG4gICAgbGV0IGl0ZW1PYmogPSBjdXJyZW50SXRlbU9iajtcbiAgICBpZiAoaXRlbU9iaiAmJiBpdGVtT2JqLmlubmVyICYmIE9iamVjdC5rZXlzKGl0ZW1PYmouaW5uZXIpLmxlbmd0aCA+IDApIHtcbiAgICAgIFNwcml0ZS5lYWNoKGl0ZW1PYmouaW5uZXIsIGZ1bmN0aW9uIChpdGVtQ291bnQsIGl0ZW1JZCwgaW5uZXIpIHtcbiAgICAgICAgaWYgKGl0ZW1JZCA9PSBcImdvbGRcIikge1xuICAgICAgICAgIEdhbWUuaGVyby5kYXRhLmdvbGQgKz0gaXRlbUNvdW50O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGlmIChHYW1lLmhlcm8uZGF0YS5pdGVtc1tpdGVtSWRdKSB7XG4gICAgICAgICAgICBHYW1lLmhlcm8uZGF0YS5pdGVtc1tpdGVtSWRdICs9IGl0ZW1Db3VudDtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgR2FtZS5oZXJvLmRhdGEuaXRlbXNbaXRlbUlkXSA9IGl0ZW1Db3VudDtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZGVsZXRlIGlubmVyW2l0ZW1JZF07XG4gICAgICB9KTtcbiAgICAgIEdhbWUud2luZG93cy5waWNrdXAub3BlbihpdGVtT2JqKTtcbiAgICB9XG4gIH0pO1xuXG4gIHdpbi53aGVuVXAoW1wiYVwiLCBcIkFcIl0sIGZ1bmN0aW9uIChrZXkpIHtcbiAgICBwaWNrdXBXaW5kb3dBbGwuY2xpY2soKTtcbiAgfSk7XG5cbiAgd2luLndoZW5VcChbXCJlc2NcIl0sIGZ1bmN0aW9uIChrZXkpIHtcbiAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcbiAgICAgIHdpbi5oaWRlKCk7XG4gICAgfSwgMjApO1xuICB9KTtcblxuICB3aW4ud2hlblVwKFtcIjFcIiwgXCIyXCIsIFwiM1wiLCBcIjRcIiwgXCI1XCIsIFwiNlwiLCBcIjdcIiwgXCI4XCIsIFwiOVwiXSwgZnVuY3Rpb24gKGtleSkge1xuICAgIGxldCBidXR0b25zID0gcGlja3VwV2luZG93VGFibGUucXVlcnlTZWxlY3RvckFsbChcImJ1dHRvblwiKTtcbiAgICBmb3IgKGxldCBpID0gMCwgbGVuID0gYnV0dG9ucy5sZW5ndGg7IGkgPCBsZW47IGkrKykge1xuICAgICAgbGV0IGJ1dHRvbkluZGV4ID0gYnV0dG9uc1tpXS5nZXRBdHRyaWJ1dGUoXCJkYXRhLWluZGV4XCIpO1xuICAgICAgaWYgKGJ1dHRvbkluZGV4KSB7XG4gICAgICAgIGlmIChidXR0b25JbmRleCA9PSBrZXkpIHtcbiAgICAgICAgICBidXR0b25zW2ldLmNsaWNrKCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH0pO1xuXG4gIHdpbi5hc3NpZ24oXCJvcGVuXCIsIGZ1bmN0aW9uIChpdGVtT2JqLCBzZWxlY3QpIHtcbiAgICBpZiAodHlwZW9mIHNlbGVjdCA9PSBcInVuZGVmaW5lZFwiKSB7XG4gICAgICBzZWxlY3QgPSAtMTtcbiAgICB9XG5cbiAgICBsYXN0U2VsZWN0ID0gc2VsZWN0O1xuXG4gICAgaWYgKCFpdGVtT2JqLmlubmVyIHx8IE9iamVjdC5rZXlzKGl0ZW1PYmouaW5uZXIpLmxlbmd0aCA8PSAwKSB7XG5cbiAgICAgIGlmIChHYW1lLmFyZWEuYmFncy5oYXMoaXRlbU9iaikpIHtcbiAgICAgICAgaXRlbU9iai5lcmFzZSgpO1xuICAgICAgICBHYW1lLmFyZWEuYmFncy5kZWxldGUoaXRlbU9iaik7XG4gICAgICB9XG5cbiAgICAgIGlmIChHYW1lLmFyZWEuaXRlbXMuaGFzKGl0ZW1PYmopKSB7XG4gICAgICAgIGl0ZW1PYmouZXJhc2UoKTtcbiAgICAgICAgR2FtZS5hcmVhLml0ZW1zLmRlbGV0ZShpdGVtT2JqKTtcbiAgICAgIH1cblxuICAgICAgR2FtZS53aW5kb3dzLnBpY2t1cC5oaWRlKCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY3VycmVudEl0ZW1PYmogPSBpdGVtT2JqO1xuXG4gICAgbGV0IGluZGV4ID0gMTtcbiAgICBsZXQgdGFibGUgPSBcIlwiO1xuICAgIFNwcml0ZS5lYWNoKGl0ZW1PYmouaW5uZXIsIGZ1bmN0aW9uIChpdGVtQ291bnQsIGl0ZW1JZCwgaW5uZXIpIHtcbiAgICAgIGxldCBpdGVtID0gR2FtZS5pdGVtc1tpdGVtSWRdO1xuXG4gICAgICBsZXQgbGluZSA9IFwiXCI7XG5cbiAgICAgIGlmIChzZWxlY3QgPT0gKGluZGV4IC0gMSkpIHtcbiAgICAgICAgbGluZSArPSBgPHRyIHN0eWxlPVwiYmFja2dyb3VuZC1jb2xvcjogZ3JlZW47XCI+XFxuYDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxpbmUgKz0gYDx0cj5cXG5gO1xuICAgICAgfVxuXG5cbiAgICAgIGlmIChpdGVtLmljb24pIHtcbiAgICAgICAgbGluZSArPSBgICA8dGQgc3R5bGU9XCJ0ZXh0LWFsaWduOiBjZW50ZXI7XCI+PGltZyBhbHQ9XCJcIiBzcmM9XCIke2l0ZW0uaWNvbi5zcmN9XCI+PC90ZD5cXG5gO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbGluZSArPSBgICA8dGQ+IDwvdGQ+XFxuYDtcbiAgICAgIH1cbiAgICAgIGxpbmUgKz0gYCAgPHRkPiR7aXRlbS5kYXRhLm5hbWV9PC90ZD5cXG5gO1xuICAgICAgbGluZSArPSBgICA8dGQgc3R5bGU9XCJ0ZXh0LWFsaWduOiBjZW50ZXI7XCI+JHtpdGVtLmRhdGEudmFsdWV9RzwvdGQ+XFxuYDtcbiAgICAgIGxpbmUgKz0gYCAgPHRkIHN0eWxlPVwidGV4dC1hbGlnbjogY2VudGVyO1wiPiR7aXRlbUNvdW50fTwvdGQ+XFxuYDtcbiAgICAgIGxpbmUgKz0gYCAgPHRkPiR7aXRlbS5kYXRhLmRlc2NyaXB0aW9ufTwvdGQ+XFxuYDtcbiAgICAgIGxpbmUgKz0gYCAgPHRkPjxidXR0b24gZGF0YS1pZD1cIiR7aXRlbUlkfVwiIGRhdGEtaW5kZXg9XCIke2luZGV4fVwiIGNsYXNzPVwiYnJvd25CdXR0b25cIj4ke2luZGV4PD05PyhpbmRleCk6XCJcIn0g5ou/5Y+WPC9idXR0b24+PC90ZD5cXG5gO1xuXG4gICAgICBsaW5lICs9IFwiPC90cj5cXG5cIjtcbiAgICAgIHRhYmxlICs9IGxpbmU7XG4gICAgICBpbmRleCsrO1xuICAgIH0pO1xuXG4gICAgcGlja3VwV2luZG93VGFibGUuaW5uZXJIVE1MID0gdGFibGU7XG4gICAgR2FtZS53aW5kb3dzLnBpY2t1cC5zaG93KCk7XG4gIH0pO1xuXG4gIHdpbi53aGVuVXAoW1wiZW50ZXJcIl0sIGZ1bmN0aW9uICgpIHtcbiAgICBsZXQgYnV0dG9ucyA9IHBpY2t1cFdpbmRvd1RhYmxlLnF1ZXJ5U2VsZWN0b3JBbGwoXCJidXR0b25cIik7XG4gICAgaWYgKGxhc3RTZWxlY3QgPj0gMCAmJiBsYXN0U2VsZWN0IDwgYnV0dG9ucy5sZW5ndGgpIHtcbiAgICAgIGJ1dHRvbnNbbGFzdFNlbGVjdF0uY2xpY2soKTtcbiAgICB9XG4gIH0pO1xuXG4gIHdpbi53aGVuVXAoW1widXBcIiwgXCJkb3duXCJdLCBmdW5jdGlvbiAoa2V5KSB7XG4gICAgbGV0IGNvdW50ID0gcGlja3VwV2luZG93VGFibGUucXVlcnlTZWxlY3RvckFsbChcImJ1dHRvblwiKS5sZW5ndGg7XG5cbiAgICBpZiAobGFzdFNlbGVjdCA9PSAtMSkge1xuICAgICAgaWYgKGtleSA9PSBcImRvd25cIikge1xuICAgICAgICB3aW4ub3BlbihjdXJyZW50SXRlbU9iaiwgMCk7XG4gICAgICB9IGVsc2UgaWYgKGtleSA9PSBcInVwXCIpIHtcbiAgICAgICAgd2luLm9wZW4oY3VycmVudEl0ZW1PYmosIGNvdW50IC0gMSk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmIChrZXkgPT0gXCJkb3duXCIpIHtcbiAgICAgICAgbGV0IHNlbGVjdCA9IGxhc3RTZWxlY3QgKyAxO1xuICAgICAgICBpZiAoc2VsZWN0ID49IGNvdW50KSB7XG4gICAgICAgICAgc2VsZWN0ID0gMDtcbiAgICAgICAgfVxuICAgICAgICB3aW4ub3BlbihjdXJyZW50SXRlbU9iaiwgc2VsZWN0KTtcbiAgICAgIH0gZWxzZSBpZiAoa2V5ID09IFwidXBcIikge1xuICAgICAgICBsZXQgc2VsZWN0ID0gbGFzdFNlbGVjdCAtIDE7XG4gICAgICAgIGlmIChzZWxlY3QgPCAwKSB7XG4gICAgICAgICAgc2VsZWN0ID0gY291bnQgLSAxO1xuICAgICAgICB9XG4gICAgICAgIHdpbi5vcGVuKGN1cnJlbnRJdGVtT2JqLCBzZWxlY3QpO1xuICAgICAgfVxuICAgIH1cbiAgfSk7XG5cbiAgcGlja3VwV2luZG93VGFibGUuYWRkRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsIGZ1bmN0aW9uIChldmVudCkge1xuICAgIGxldCBpdGVtSWQgPSBldmVudC50YXJnZXQuZ2V0QXR0cmlidXRlKFwiZGF0YS1pZFwiKTtcbiAgICBpZiAoaXRlbUlkICYmIGN1cnJlbnRJdGVtT2JqLmlubmVyICYmIGN1cnJlbnRJdGVtT2JqLmlubmVyLmhhc093blByb3BlcnR5KGl0ZW1JZCkpIHtcbiAgICAgIGxldCBpdGVtQ291bnQgPSBjdXJyZW50SXRlbU9iai5pbm5lcltpdGVtSWRdO1xuICAgICAgaWYoaXRlbUlkID09IFwiZ29sZFwiKSB7XG4gICAgICAgIEdhbWUuaGVyby5kYXRhLmdvbGQgKz0gaXRlbUNvdW50O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKEdhbWUuaGVyby5kYXRhLml0ZW1zLmhhc093blByb3BlcnR5KGl0ZW1JZCkpIHtcbiAgICAgICAgICBHYW1lLmhlcm8uZGF0YS5pdGVtc1tpdGVtSWRdICs9IGl0ZW1Db3VudDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBHYW1lLmhlcm8uZGF0YS5pdGVtc1tpdGVtSWRdID0gaXRlbUNvdW50O1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBkZWxldGUgY3VycmVudEl0ZW1PYmouaW5uZXJbaXRlbUlkXTtcbiAgICAgIHdpbi5vcGVuKGN1cnJlbnRJdGVtT2JqKTtcbiAgICB9XG4gIH0pO1xuXG59KSgpO1xuIl19