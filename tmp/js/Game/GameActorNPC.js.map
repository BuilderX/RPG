{"version":3,"sources":["../../../src/Game/GameActorNPC.js"],"names":[],"mappings":"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","file":"GameActorNPC.js","sourcesContent":["/*\n\nA-RPG Game, Built using JavaScript ES6\nCopyright (C) 2015 qhduan(http://qhduan.com)\n\nThis program is free software: you can redistribute it and/or modify\nit under the terms of the GNU General Public License as published by\nthe Free Software Foundation, either version 3 of the License, or\n(at your option) any later version.\n\nThis program is distributed in the hope that it will be useful,\nbut WITHOUT ANY WARRANTY; without even the implied warranty of\nMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\nGNU General Public License for more details.\n\nYou should have received a copy of the GNU General Public License\nalong with this program.  If not, see <http://www.gnu.org/licenses/>.\n\n*/\n\n(function () {\n  \"use strict\";\n\n  let internal = Sprite.Namespace();\n\n  /**\n    英雄类\n    属性：\n      this.sprite 精灵\n  */\n  Game.assign(\"ActorNPC\", class GameActorNPC extends Game.Actor {\n    constructor (actorData) {\n      super(actorData);\n    }\n\n    heroUse () {\n      let data = this.data;\n\n      let options = {};\n\n      // npc对话，例如“闲谈”\n      let contact = {};\n      if (data.contact) {\n        for (let talk of data.contact) {\n          let result = true;\n          // talk.condition 是对话条件，如果存在，它是一个函数\n          if (typeof talk.condition == \"function\") {\n            try {\n              result = talk.condition();\n            } catch (e) {\n              console.error(this.id, this.data);\n              console.error(talk.condition);\n              console.error(talk.condition.toString());\n              throw e;\n            }\n          }\n          if (result) {\n            options[talk.name] = talk.name;\n            contact[talk.name] = talk;\n          }\n        }\n      }\n\n      // 玩家接受任务\n      let quest = null;\n      if (this.quest) {\n        quest = this.quest.filter(function (quest) {\n          if (Game.hero.hasQuest(quest.id)) {\n            return false;\n          }\n          return true;\n        });\n        if (quest && quest.length) {\n          options[\"任务\"] = \"quest\";\n        }\n      }\n\n      // 玩家完成任务\n      let completeQuest = null;\n      if (Game.hero.data.currentQuest.length) {\n        completeQuest = [];\n        for (let quest of Game.hero.data.currentQuest) {\n          if (quest.to == this.id && Game.Quest.isComplete(quest)) {\n            completeQuest.push(quest);\n          }\n        }\n        if (completeQuest.length > 0) {\n          options[\"完成任务\"] = \"completeQuest\";\n        }\n      }\n\n      // NPC有的交易\n      if (data.trade && data.items) {\n        options[\"交易\"] = \"trade\";\n      }\n\n      // 没有选项\n      if (Object.keys(options).length <= 0) {\n        return;\n      }\n\n      /*\n        下面的代码中频繁调用了this.heroUse()\n        是为了保证NPC对话框不会关闭，或者说玩家在执行完某个选项之后依然存在\n        但是又不能简单的不关闭对话框，因为选项会有变化，所以要经常重新打开\n      */\n      Game.choice(options, (choice) => {\n        switch (choice) {\n          case \"trade\": // 玩家交易的选择，默认是买\n            this.heroUse();\n            Game.windows.buy.open(data.items);\n            break;\n          case \"quest\": // 玩家接受任务的选择\n            let questOption = {};\n            quest.forEach((quest, index) => {\n              questOption[quest.name] = index;\n            });\n            Game.choice(questOption, (choice) => {\n              if (Number.isInteger(choice)) {\n                let q = quest[choice];\n                Game.confirm({\n                  message: q.before,\n                  yes: \"接受任务\",\n                  no: \"拒绝\"\n                }, () => {\n                  Game.hero.data.currentQuest.push(q);\n                  this.heroUse();\n                }, () => {\n                  this.heroUse();\n                });\n              } else {\n                this.heroUse();\n              }\n            });\n            break;\n          case \"completeQuest\": // 玩家完成了某个任务的选择\n            let completeQuestOption = {};\n            completeQuest.forEach((quest, index) => {\n              completeQuestOption[quest.name] = index;\n            });\n            Game.choice(completeQuestOption, (choice) => {\n              if (Number.isInteger(choice)) {\n                let quest = completeQuest[choice];\n\n                Game.hero.data.currentQuest.splice(\n                  Game.hero.data.currentQuest.indexOf(quest), 1\n                );\n                Game.hero.data.completeQuest.push(quest);\n\n                this.heroUse();\n                Game.dialogue([quest.finish], data.name);\n                if (quest.reward) {\n                  if (quest.reward.gold) {\n                    Game.hero.data.gold += quest.reward.gold;\n                  }\n                  if (quest.reward.exp) {\n                    Game.hero.data.exp += quest.reward.exp;\n                  }\n                }\n              };\n            });\n            break;\n          default: // 其他选择都没选的情况下，就是对话选择，例如“闲谈”\n            if (contact[choice]) {\n              this.heroUse();\n              Game.dialogue(contact[choice].content, data.name);\n            }\n        }\n      });\n    }\n\n  });\n\n\n})();\n"]}